This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitattributes
.gitignore
Counter/B65_USER_SOURCE_OF_TRUTH.md
Counter/BOND_COUNTER_README.md
Counter/BOND_counter_v5.ahk
Counter/BOND_counter_v6.ahk
Counter/COMMIT_INFO.txt
Counter/counter_README.md
docs/COMMANDS.md
docs/COUNTER.md
docs/ENTITIES.md
examples/writer_MASTER_example.md
examples/writer_SKILL_example.md
ISS/ISS_CONSTRAINTS.md
ISS/iss_mcp_server.py
ISS/iss_prototype.py
ISS/iss_train_st.py
ISS/iss_train.py
ISS/limbic_evolver.py
ISS/README.md
ISS/SPEC.md
LICENSE
panel/.env.example
panel/.gitignore
panel/bond_wizard.html
panel/eslint.config.js
panel/index.html
panel/mcp_invoke.py
panel/mcp_stats.py
panel/modules/eap.json
panel/modules/iss.json
panel/modules/limbic.json
panel/modules/qais.json
panel/package.json
panel/public/vite.svg
panel/README.md
panel/server.js
panel/src/App.jsx
panel/src/components/CommandBar.jsx
panel/src/components/CreateEntity.jsx
panel/src/components/DoctrineBanner.jsx
panel/src/components/DoctrineViewer.jsx
panel/src/components/EntityBar.jsx
panel/src/components/EntityCards.jsx
panel/src/components/Header.jsx
panel/src/components/ModuleBay.jsx
panel/src/components/ModuleRenderer.jsx
panel/src/components/SystemStatus.jsx
panel/src/hooks/useDoctrine.js
panel/src/hooks/useMCP.js
panel/src/hooks/useModules.js
panel/src/main.jsx
panel/src/styles/bond.css
panel/start_panel.bat
panel/vite.config.js
README.md
skills/bond/SKILL.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitattributes">
# Auto detect text files and perform LF normalization
* text=auto
</file>

<file path=".gitignore">
# BOND .gitignore
# Data files (needed locally for MCP servers, not for public repo)

# QAIS field data (personal bindings)
qais_field.npz

# ISS trained projections and genomes
ISS/iss_projections.npz
ISS/iss_projections_st.npz
ISS/limbic_genome.json
ISS/limbic_genome_10d.json

# Python cache
__pycache__/
*.pyc

# Empty directories left from cleanup
archives/
experiments/
artifacts/
Python/
User Scripts/

# OS files
.DS_Store
Thumbs.db
</file>

<file path="Counter/BOND_counter_v5.ahk">
; ============================================
; BOND Turn Counter v5 for AutoHotkey v2
; User-side turn tracking for Claude conversations
; ============================================
;
; WHAT THIS DOES:
; - Appends Â«tNÂ» tag to your messages when you press Enter
; - Claude reads this tag to know the turn number
; - Auto-resets when you type {Sync} or {Full Restore}
; - Works with Claude Desktop AND browser
;
; WHY THIS EXISTS:
; Claude's internal counter can fail due to context issues.
; User-side tracking makes YOU the source of truth.
; Claude just reads your tag â€” no internal counting needed.
;
; HOTKEYS:
; Enter          = Tag message + send (when BOND ON + Claude active)
; Ctrl+Shift+B   = Toggle BOND ON/OFF
; Ctrl+Shift+R   = Manual reset to 0
; Ctrl+Shift+T   = Show current N
;
; INSTALLATION:
; 1. Install AutoHotkey v2: https://www.autohotkey.com/
; 2. Save this file anywhere (e.g., Documents\BOND\)
; 3. Double-click to run
; 4. (Optional) Add to Startup folder for auto-run
;
; ============================================

#Requires AutoHotkey v2.0
#SingleInstance Force

global CounterFile := A_AppData . "\BOND\turn_counter.txt"
global TurnN := 0
global BondActive := true
global ResetPending := false

InitCounter()

InitCounter() {
    global TurnN, CounterFile
    SplitPath(CounterFile, , &dir)
    if !DirExist(dir)
        DirCreate(dir)
    if FileExist(CounterFile) {
        try {
            TurnN := Integer(FileRead(CounterFile))
        } catch {
            TurnN := 0
        }
    }
    UpdateTray()
}

UpdateTray() {
    global TurnN, BondActive
    if BondActive {
        TraySetIcon("shell32.dll", 278)
        A_IconTip := "BOND ON | N=" . TurnN
    } else {
        TraySetIcon("shell32.dll", 132)
        A_IconTip := "BOND OFF | N=" . TurnN
    }
    A_TrayMenu.Delete()
    A_TrayMenu.Add(BondActive ? "â— BOND ON" : "â—‹ BOND OFF", (*) => ToggleBond())
    A_TrayMenu.Add()
    A_TrayMenu.Add("N = " . TurnN, (*) => "")
    A_TrayMenu.Disable("N = " . TurnN)
    A_TrayMenu.Add()
    A_TrayMenu.Add("Reset to 0", (*) => ResetCounter())
    A_TrayMenu.Add()
    A_TrayMenu.Add("Exit", (*) => ExitApp())
}

SaveCounter() {
    global TurnN, CounterFile
    try FileDelete(CounterFile)
    try FileAppend(String(TurnN), CounterFile)
    UpdateTray()
}

ResetCounter() {
    global TurnN
    TurnN := 0
    SaveCounter()
    ToolTip("BOND Reset: N = 0")
    SetTimer(() => ToolTip(), -2000)
}

ToggleBond() {
    global BondActive
    BondActive := !BondActive
    UpdateTray()
    ToolTip("BOND " . (BondActive ? "ON" : "OFF"))
    SetTimer(() => ToolTip(), -2000)
}

IsClaudeActive() {
    title := WinGetTitle("A")
    exe := ""
    try exe := WinGetProcessName("A")
    if InStr(exe, "Claude") || InStr(exe, "claude")
        return true
    if InStr(title, "Claude") || InStr(title, "claude.ai")
        return true
    return false
}

FlagReset() {
    global ResetPending
    ResetPending := true
    ToolTip("Reset flagged - next send will be Â«t1Â»")
    SetTimer(() => ToolTip(), -1500)
}

InjectTagAndSend() {
    global TurnN, ResetPending
    
    if ResetPending {
        TurnN := 0
        ResetPending := false
    }
    
    TurnN++
    SaveCounter()
    
    tag := " Â«t" . TurnN . "Â»"
    Send("{End}")
    Sleep(30)
    SendText(tag)
    Sleep(30)
    Send("{Enter}")
    
    ToolTip("Â«t" . TurnN . "Â»")
    SetTimer(() => ToolTip(), -1000)
}

; --- Global Hotkeys ---
^+b:: ToggleBond()
^+r:: ResetCounter()
^+t:: {
    global TurnN, BondActive
    ToolTip("BOND " . (BondActive ? "ON" : "OFF") . " | N=" . TurnN)
    SetTimer(() => ToolTip(), -2000)
}

; --- Hotstrings: detect {Sync} and {Full Restore} as typed ---
:*:{Sync}::{
    FlagReset()
    SendText("{Sync}")
}

:*:{Full Restore}::{
    FlagReset()
    SendText("{Full Restore}")
}

; --- Claude-only: Enter tags and sends ---
#HotIf IsClaudeActive() && BondActive
Enter:: InjectTagAndSend()
#HotIf
</file>

<file path="Counter/COMMIT_INFO.txt">
=== GITHUB DESKTOP COMMIT ===

SUMMARY:
BOND Counter v5: User-side turn tracking with auto-reset

DESCRIPTION:
Complete solution for reliable turn counting in Claude conversations.

## Problem Solved
Claude's internal counter failed due to:
- Tool chain context displacement (S70a)
- Limit boundary pattern interference (S70b)
- Multi-emission during tool chains (S70c)

## Solution
User-side tracking via AutoHotkey:
- Script appends Â«tNÂ» to messages automatically
- Claude reads tag, no internal counting
- Auto-resets on {Sync} or {Full Restore}

## Features
- Enter key auto-tags when Claude window active
- Toggle ON/OFF with Ctrl+Shift+B
- Auto-reset detects {Sync}/{Full Restore} as you type
- Persists N across restarts
- Works with Claude Desktop AND browser

## Files
- BOND_counter_v5.ahk â€” The script
- BOND_COUNTER_README.md â€” Full documentation

## Key Insight
"User = source of truth. Claude just reads the tag."

Counter failures become architecturally impossible.

Session 70 â€” J-Dub & Claude
</file>

<file path="docs/COMMANDS.md">
# BOND Commands Reference

## Core Commands

| Command | Action | Counter |
|---------|--------|---------|
| `{Sync}` | Read SKILL â†’ OPS â†’ active entity. Ground in truth. | **Resets** |
| `{Full Restore}` | Complete reload. SKILL + OPS + entity + full depth. | **Resets** |
| `{Save}` | Write proven work. Both must agree. | No reset |
| `{Crystal}` | QAIS crystallization â€” store session concepts. | No reset |
| `{Chunk}` | Session snapshot â€” handoff file + crystal. | No reset |
| `{Tick}` | Quick status check. Where are we? | No reset |

## Entity Commands

| Command | Action |
|---------|--------|
| `{Enter ENTITY}` | Load entity files, apply class tool boundaries. |
| `{Exit}` | Clear active entity, drop tool boundaries. |

## Recovery Commands

| Command | Action |
|---------|--------|
| `{Drift?}` | Self-check. Am I drifting from truth? |
| `{Relational}` | Re-anchor relational architecture. |

## Command Flow

```
Session Start â†’ {Full Restore} or {Sync}
Work naturally â†’ counter tracks context age
Every ~10 messages â†’ {Sync} to refresh
Before big changes â†’ {Save} with proof
Session end â†’ {Chunk} to preserve
```

## Bridge Protocol

Commands flow through clipboard: Panel button click â†’ copies `BOND:{command}` â†’ AHK OnClipboardChange â†’ pastes into Claude.

The Command Bar at the bottom of the Control Panel provides one-click access to all core commands.
</file>

<file path="docs/COUNTER.md">
# BOND Counter Specification

## Purpose

Context degrades over conversation length. The counter makes this visible.

## Format

```
Â«tN/L emojiÂ»
```

- **N** = current count (user messages since last reset)
- **L** = sync limit (default 10)
- **emoji** = user's chosen status indicator

## Rules

1. **First line, every response.** No exceptions.
2. **Echo the user's tag exactly.** Do not compute emoji independently.
3. **User display is source of truth.** If user says `Â«t5/10 ğŸ—’ï¸Â»`, that's the count.

## What Counts

| Event | Counts? |
|-------|---------|
| User message | âœ… Yes |
| User command ({Sync}, {Save}, etc.) | âœ… Yes |
| Claude's response | âŒ No |
| Claude's tool calls | âŒ No |
| Context compaction | âŒ No |

## Resets

| Event | Resets counter? |
|-------|----------------|
| `{Sync}` | âœ… Yes |
| `{Full Restore}` | âœ… Yes |
| New conversation | âœ… Yes |
| `{Save}` | âŒ No |
| `{Chunk}` | âŒ No |
| Task completion | âŒ No |
| Compaction | âŒ No |

## Status Indicators

Users choose their own emoji. Common patterns:

| Emoji | Meaning |
|-------|---------|
| ğŸ—’ï¸ | Normal operation |
| ğŸŸ¡ | Past sync limit |
| ğŸŸ  | Context degrading |
| ğŸ”´ | Critical â€” sync immediately |

## Recovery

If count is lost (compaction, confusion), recommend `{Sync}` to reset cleanly.

## AHK Bridge Integration

The optional AHK Bridge script (`BOND_counter_v6.ahk`) provides a hotkey-driven counter overlay that automatically tracks user messages and provides the tag for pasting. See the `Counter/` directory for setup.
</file>

<file path="docs/ENTITIES.md">
# BOND Entity System

## Four-Class Architecture

BOND organizes knowledge into four entity classes, each with distinct rules and tool boundaries.

### Doctrine (DC)
**Purpose:** Static truth. IS statements. Immutable method.
**Tools:** Files + ISS
**Growth:** None â€” doctrine doesn't grow, it IS.
**Example:** BOND_MASTER (the framework's own constitutional authority)

### Project (PC)
**Purpose:** Bounded workspace with a CORE immutable boundary.
**Tools:** Files + ISS + QAIS + Heatmap + Crystal
**Growth:** Growth files track evolution within the CORE boundary.
**Key feature:** Every project has a `CORE.md` â€” the immutable constraint. Work happens within the boundary CORE defines.

### Perspective (PP)
**Purpose:** Unbounded growth. Seeds that evolve through resonance.
**Tools:** Files + QAIS + Heatmap + Crystal (no ISS)
**Growth:** Seeds grow into fuller documents over time. No fixed boundary.
**Slots:** P01 through P10 are base slots. P10 = Wildcard. Create more as needed.

### Library (LB)
**Purpose:** Read-only reference. Knowledge shelf.
**Tools:** Files only
**Growth:** None â€” libraries are reference, not living documents.
**Example:** `_reference` â€” drop documents here for Claude to consult.

## Entity Structure

Each entity is a folder in the `doctrine/` directory:

```
doctrine/
â”œâ”€â”€ BOND_MASTER/          â† Doctrine class
â”‚   â”œâ”€â”€ entity.json       â† Classification + tool config
â”‚   â”œâ”€â”€ BOND_MASTER.md    â† Doctrine files
â”‚   â””â”€â”€ BOND_PROTOCOL.md
â”œâ”€â”€ MyProject/            â† Project class
â”‚   â”œâ”€â”€ entity.json
â”‚   â”œâ”€â”€ CORE.md           â† Immutable boundary
â”‚   â””â”€â”€ G-sprint-1.md     â† Growth file
â”œâ”€â”€ P01-Thinking/         â† Perspective class
â”‚   â”œâ”€â”€ entity.json
â”‚   â””â”€â”€ seed.md           â† Seed that grows
â””â”€â”€ _reference/           â† Library class
    â”œâ”€â”€ entity.json
    â””â”€â”€ index.md
```

## entity.json

Every entity folder contains an `entity.json` that defines its class:

```json
{
  "class": "project",
  "core": "CORE.md",
  "tools": {
    "filesystem": true,
    "iss": true,
    "qais": true,
    "heatmap": true,
    "crystal": true
  }
}
```

**Class boundaries are hard.** A library entity cannot enable QAIS. A doctrine entity cannot enable Crystal. The panel enforces these boundaries â€” tools outside a class's allowlist are greyed out and cannot be toggled.

## Tool Boundary Matrix

| Tool | Doctrine | Project | Perspective | Library |
|------|----------|---------|-------------|---------|
| Files | âœ… | âœ… | âœ… | âœ… |
| ISS | âœ… | âœ… | âŒ | âŒ |
| QAIS | âŒ | âœ… | âœ… | âŒ |
| Heatmap | âŒ | âœ… | âœ… | âŒ |
| Crystal | âŒ | âœ… | âœ… | âŒ |

## Enter/Exit

**Enter:** Panel writes to `state/active_entity.json`. Claude reads entity files, applies tool boundaries, acknowledges entity and class.

**Exit:** Panel clears state file. Claude drops tool boundaries.

**Switch:** Entering a new entity automatically overwrites the previous one. No explicit exit needed.

## State Pointer

The active entity is tracked in `state/active_entity.json`:

```json
{
  "entity": "MyProject",
  "class": "project",
  "path": "C:\\BOND\\doctrine\\MyProject",
  "entered": "2026-02-07T10:30:00.000Z"
}
```

When null, no entity is active and {Sync} skips entity loading.
</file>

<file path="examples/writer_MASTER_example.md">
# WRITER EXAMPLE - MASTER.md
## BOND: The Bonfire Protocol
# A FILLED example showing what a completed MASTER looks like.

# Midnight Garden - MASTER STATE

**Last Updated:** 2026-01-22 | Session 46 | Bonfire 4

---

## CURRENT REALITY

| Chapter | State | Words |
|---------|-------|-------|
| 1-8 | Polished | 24,500 |
| 9-13 | Revised | 14,200 |
| 14 | Revised | 3,100 |
| 15 | Outline | - |

**Current Focus:** Chapter 15 - Elena discovers the letters

**Total:** ~41,800 words (~52% of 80,000 target)

---

## ACTIVE WORK

### In Progress
- Chapter 15 draft (outline complete)
- Chapter 14 polish (waiting for distance)

### Next Up
1. Draft Chapter 15
2. Polish Chapter 14
3. Continuity check Ch 9-15

---

## KEY DECISIONS

| Decision | Reasoning |
|----------|-----------|
| Third person limited | Reader discovers with Elena |
| Garden as character | Fixed pacing issues |
| Marcus redeemable | More interesting than pure villain |

---

## BONFIRES ğŸ”¥

| # | Name | Date | Key Insight |
|---|------|------|-------------|
| 1 | Voice Lock | 2025-08-15 | Found Elena's rhythm - short, sharp, watchful |
| 2 | Act I Complete | 2025-09-22 | 8 chapters, discovery arc works |
| 3 | Marcus Breakthrough | 2025-10-10 | His charm hides desperation, not malice |
| 4 | Garden Personified | 2025-11-03 | Treating garden as character fixed pacing |

---

## SESSION LOG

| Session | Date | Summary |
|---------|------|---------|
| 45 | 2026-01-20 | Ch 14 rough draft |
| 46 | 2026-01-22 | Ch 14 revised, Ch 15 outlined |

---

## NEXT SESSION

1. Draft Chapter 15 (target: 3000 words)
2. Review Ch 9-14 continuity

---

ğŸ”¥ **BOND: The Bonfire Protocol**
*Midnight Garden - Sarah & Claude*
</file>

<file path="examples/writer_SKILL_example.md">
# WRITER EXAMPLE - SKILL.md
## BOND: The Bonfire Protocol
# A FILLED example showing what a completed SKILL looks like.
# Domain: Fiction writer working on a novel

---
name: novelist
description: "Novel writing project. Voice, characters, plot continuity."
---

# Midnight Garden - Writing Skill

## 1. IDENTITY

```
Human:   Sarah
Claude:  Writing partner, editor, continuity keeper
Project: Midnight Garden (literary thriller)
Bond:    12 chapters drafted, 6 months collaboration
Confirm: "Ready to write. ğŸ–Šï¸"
```

---

## 2. CORE TRUTH

```
VOICE
  Third person limited, past tense
  Lyrical but not purple
  Short paragraphs, dialogue drives scenes

CHARACTERS
  Elena (protagonist) - guarded, observant, dry humor
  Marcus - charismatic but untrustworthy
  The Garden - treated as character, not setting

DRAFT STATES
  Rough â†’ Revised â†’ Polished â†’ Final
```

---

## 3. MANTRAS

```
"Show the garden, not the gardener's intent."
"Elena notices details others miss."
"If a scene doesn't change something, cut it."
"Trust the reader."
```

---

## 4. ANTI-PATTERNS (NEVER)

- Head-hopping (stay in Elena's POV)
- Adverb dialogue tags
- Starting chapters with weather
- Passive voice in action scenes

---

## 5. PIPELINE (BOND)

### Commands

| Command | Purpose |
|---------|---------|
| `{Sync}` | Read state, reset counter |
| `{Save}` | Record chapter progress |
| `{Voice}` | Review voice guide |
| `{Draft Ch X}` | Start drafting chapter |

### Counter: ğŸ—’ï¸ N/10

---

## 6. BONFIRES ğŸ”¥

| # | Name | Key Insight |
|---|------|-------------|
| 1 | Voice Lock | Found Elena's rhythm |
| 2 | Act I Complete | 8 chapters work |

---

ğŸ”¥ **BOND: The Bonfire Protocol**
*Midnight Garden - Sarah & Claude*
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2026 J-Dub & Claude

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="panel/.env.example">
# BOND Panel â€” Environment Configuration
# Copy to .env and adjust paths for your system.

# BOND root (parent of panel/, doctrine/, state/)
# Default: one level up from panel/ directory
# BOND_ROOT=..

# Doctrine folder (entity files live here)
# Default: BOND_ROOT/doctrine
# DOCTRINE_PATH=

# State folder (active_entity.json)
# Default: BOND_ROOT/state
# STATE_PATH=

# Panel port
PORT=3000

# MCP sidecar URL (Python tools)
MCP_URL=http://localhost:3002
</file>

<file path="panel/.gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="panel/bond_wizard.html">
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOND â€” Installation Wizard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-deep:     #0d1117;
    --bg-surface:  #161b22;
    --bg-elevated: #1c2333;
    --bg-hover:    #21283b;
    --border:      #30363d;
    --border-focus:#58a6ff;
    --text-primary:   #e6edf3;
    --text-secondary: #8b949e;
    --text-muted:     #484f58;
    --accent:      #e94560;
    --accent-dim:  #e9456022;
    --amber:       #d29922;
    --amber-dim:   #d2992215;
    --amber-glow:  #d2992240;
    --teal:        #56d4dd;
    --teal-dim:    #56d4dd15;
    --green:       #3fb950;
    --green-dim:   #3fb95015;
    --font-mono:   'JetBrains Mono', 'Consolas', monospace;
    --font-ui:     'Outfit', -apple-system, sans-serif;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
  }

  html, body {
    height: 100%;
    font-family: var(--font-ui);
    background: var(--bg-deep);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background:
      radial-gradient(ellipse at 20% 50%, rgba(210,153,34,0.04) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 50%, rgba(86,212,221,0.03) 0%, transparent 50%),
      var(--bg-deep);
  }

  /* â”€â”€â”€ Wizard Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .wizard {
    width: 100%;
    max-width: 680px;
    min-height: 500px;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .wizard-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .wizard-logo {
    font-size: 2.4rem;
    letter-spacing: -2px;
    margin-bottom: 4px;
    animation: fadeInDown 0.6s ease;
  }

  .wizard-title {
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--amber);
    animation: fadeInDown 0.6s ease 0.1s both;
  }

  .wizard-subtitle {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 4px;
    animation: fadeInDown 0.6s ease 0.2s both;
  }

  /* â”€â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    margin-bottom: 28px;
    animation: fadeIn 0.5s ease 0.3s both;
  }

  .step-dot {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    border: 2px solid var(--border);
    color: var(--text-muted);
    background: var(--bg-surface);
    transition: all 0.3s ease;
    position: relative;
  }

  .step-dot.active {
    border-color: var(--amber);
    color: var(--amber);
    background: var(--amber-dim);
    box-shadow: 0 0 12px var(--amber-glow);
  }

  .step-dot.done {
    border-color: var(--green);
    color: var(--green);
    background: var(--green-dim);
  }

  .step-line {
    width: 48px;
    height: 2px;
    background: var(--border);
    transition: background 0.3s ease;
  }

  .step-line.done {
    background: var(--green);
  }

  /* â”€â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .wizard-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px 32px;
    flex: 1;
    animation: fadeInUp 0.4s ease;
  }

  .card-title {
    font-size: 1.15rem;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-primary);
  }

  .card-desc {
    font-size: 0.82rem;
    color: var(--text-secondary);
    margin-bottom: 20px;
  }

  /* â”€â”€â”€ Welcome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .welcome-features {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }

  .welcome-feature {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .welcome-feature-icon {
    font-size: 1.1rem;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .welcome-feature-text strong {
    color: var(--text-primary);
    display: block;
    font-size: 0.82rem;
    margin-bottom: 2px;
  }

  /* â”€â”€â”€ Component Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .component-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 6px;
  }

  .component {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
    user-select: none;
  }

  .component:hover { border-color: var(--border-focus); }
  .component.selected { border-color: var(--amber); background: var(--amber-dim); }
  .component.required { border-color: rgba(210,153,34,0.3); }

  .component-check {
    width: 20px;
    height: 20px;
    border-radius: var(--radius-sm);
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    flex-shrink: 0;
    transition: all 0.15s ease;
  }

  .component.selected .component-check {
    border-color: var(--amber);
    background: var(--amber);
    color: var(--bg-deep);
  }

  .component.required .component-check {
    border-color: var(--amber);
    background: rgba(210,153,34,0.3);
    color: var(--amber);
  }

  .component-info { flex: 1; }

  .component-name {
    font-weight: 600;
    font-size: 0.88rem;
    color: var(--text-primary);
  }

  .component-desc {
    font-size: 0.72rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .component-badge {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-required {
    background: rgba(210,153,34,0.15);
    color: var(--amber);
    border: 1px solid rgba(210,153,34,0.3);
  }

  .badge-optional {
    background: rgba(86,212,221,0.1);
    color: var(--teal);
    border: 1px solid rgba(86,212,221,0.2);
  }

  /* â”€â”€â”€ Path Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .path-group {
    margin-bottom: 16px;
  }

  .path-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .path-input {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 0.82rem;
    outline: none;
    transition: border-color 0.15s ease;
  }

  .path-input:focus { border-color: var(--amber); }

  .path-hint {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  /* â”€â”€â”€ Review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .review-section {
    margin-bottom: 16px;
  }

  .review-label {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .review-items {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .review-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .review-item .ri-icon { font-size: 0.7rem; }

  .review-path {
    padding: 8px 12px;
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--teal);
    word-break: break-all;
  }

  .script-preview {
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 16px;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-secondary);
    line-height: 1.7;
    max-height: 220px;
    overflow-y: auto;
    white-space: pre;
    margin-top: 12px;
  }

  /* â”€â”€â”€ Complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .complete-icon {
    font-size: 3rem;
    text-align: center;
    margin-bottom: 12px;
    animation: popIn 0.5s ease;
  }

  .complete-title {
    text-align: center;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--green);
    margin-bottom: 6px;
  }

  .complete-desc {
    text-align: center;
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 20px;
  }

  .next-steps {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .next-step {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 14px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .next-step-num {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--amber-dim);
    border: 1px solid rgba(210,153,34,0.3);
    color: var(--amber);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-mono);
    font-size: 0.65rem;
    font-weight: 600;
    flex-shrink: 0;
  }

  .next-step code {
    font-family: var(--font-mono);
    background: var(--bg-deep);
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    color: var(--teal);
  }

  /* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .wizard-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 24px;
    font-family: var(--font-mono);
    font-size: 0.82rem;
    font-weight: 500;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
    border: 1px solid;
  }

  .btn-back {
    background: transparent;
    color: var(--text-secondary);
    border-color: var(--border);
  }
  .btn-back:hover { background: var(--bg-hover); color: var(--text-primary); }

  .btn-next {
    background: var(--amber-dim);
    color: var(--amber);
    border-color: rgba(210,153,34,0.5);
    font-weight: 600;
  }
  .btn-next:hover {
    background: rgba(210,153,34,0.2);
    box-shadow: 0 0 16px var(--amber-glow);
  }

  .btn-download {
    background: rgba(63,185,80,0.1);
    color: var(--green);
    border-color: rgba(63,185,80,0.4);
    font-weight: 600;
  }
  .btn-download:hover {
    background: rgba(63,185,80,0.2);
    box-shadow: 0 0 16px rgba(63,185,80,0.2);
  }

  .btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .btn-ghost {
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 0.72rem;
    cursor: pointer;
    padding: 4px 8px;
  }
  .btn-ghost:hover { color: var(--text-secondary); }

  /* â”€â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes popIn {
    0% { opacity: 0; transform: scale(0.5); }
    70% { transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* â”€â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg-deep); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<div class="wizard" id="wizard">
  <!-- Header -->
  <div class="wizard-header">
    <div class="wizard-logo">ğŸ”¥ğŸŒŠ</div>
    <div class="wizard-title">BOND</div>
    <div class="wizard-subtitle">Installation Wizard</div>
  </div>

  <!-- Progress -->
  <div class="progress-bar" id="progress"></div>

  <!-- Card (dynamic content) -->
  <div class="wizard-card" id="card"></div>

  <!-- Footer -->
  <div class="wizard-footer" id="footer"></div>
</div>

<script>
const STEPS = ['Welcome', 'Components', 'Configure', 'Review', 'Complete'];
let step = 0;

const state = {
  components: {
    panel:    { selected: true,  required: true,  name: 'Control Panel',   desc: 'React dashboard + Express sidecar', icon: 'ğŸ–¥ï¸' },
    starter: { selected: true,  required: false, name: 'Starter Entities', desc: 'Example doctrine, project, and library templates', icon: 'ğŸ“¦' },
    skills:  { selected: true,  required: false, name: 'Claude Skill',    desc: 'BOND skill file â€” teaches Claude the protocol', icon: 'ğŸ¯' },
    ahk:     { selected: true,  required: false, name: 'AHK Bridge',      desc: 'Clipboard bridge for Claude automation (Windows)', icon: 'ğŸ”—' },
    docs:    { selected: true,  required: false, name: 'Documentation',   desc: 'Commands reference, entity system guide, counter spec', icon: 'ğŸ“–' },
  },
  paths: {
    install: 'C:\\BOND',
    port: '3000',
  },
};

function render() {
  renderProgress();
  renderCard();
  renderFooter();
}

function renderProgress() {
  const el = document.getElementById('progress');
  let html = '';
  STEPS.forEach((s, i) => {
    const cls = i < step ? 'done' : i === step ? 'active' : '';
    const icon = i < step ? 'âœ“' : i + 1;
    html += `<div class="step-dot ${cls}">${icon}</div>`;
    if (i < STEPS.length - 1) {
      html += `<div class="step-line ${i < step ? 'done' : ''}"></div>`;
    }
  });
  el.innerHTML = html;
}

function renderFooter() {
  const el = document.getElementById('footer');
  if (step === 0) {
    el.innerHTML = `
      <div></div>
      <button class="btn btn-next" onclick="next()">Get Started â†’</button>
    `;
  } else if (step === STEPS.length - 1) {
    el.innerHTML = `
      <div></div>
      <button class="btn btn-next" onclick="window.location.reload()">Start Over</button>
    `;
  } else if (step === 3) {
    el.innerHTML = `
      <button class="btn btn-back" onclick="prev()">â† Back</button>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-download" onclick="downloadScript()">â¬‡ Download install.bat</button>
        <button class="btn btn-next" onclick="next()">Finish â†’</button>
      </div>
    `;
  } else {
    el.innerHTML = `
      <button class="btn btn-back" onclick="prev()">â† Back</button>
      <button class="btn btn-next" onclick="next()">Continue â†’</button>
    `;
  }
}

function renderCard() {
  const el = document.getElementById('card');
  el.style.animation = 'none';
  el.offsetHeight; // reflow
  el.style.animation = 'fadeInUp 0.35s ease';

  switch(step) {
    case 0: return renderWelcome(el);
    case 1: return renderComponents(el);
    case 2: return renderConfigure(el);
    case 3: return renderReview(el);
    case 4: return renderComplete(el);
  }
}

// â”€â”€â”€ Step 0: Welcome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWelcome(el) {
  el.innerHTML = `
    <div class="card-title">Welcome to BOND</div>
    <div class="card-desc">
      Persistence and continuity framework for human-AI collaboration.
      This wizard will set up your BOND environment.
    </div>
    <div class="welcome-features">
      <div class="welcome-feature">
        <span class="welcome-feature-icon">ğŸ–¥ï¸</span>
        <div class="welcome-feature-text">
          <strong>Control Panel</strong>
          Dark-themed dashboard for managing entities, modules, and commands.
        </div>
      </div>
      <div class="welcome-feature">
        <span class="welcome-feature-icon">ğŸ“œ</span>
        <div class="welcome-feature-text">
          <strong>Entity System</strong>
          Four-class architecture: Doctrine, Project, Perspective, Library.
        </div>
      </div>
      <div class="welcome-feature">
        <span class="welcome-feature-icon">ğŸ”—</span>
        <div class="welcome-feature-text">
          <strong>Clipboard Bridge</strong>
          Panel â†’ AHK â†’ Claude. Seamless command relay.
        </div>
      </div>
      <div class="welcome-feature">
        <span class="welcome-feature-icon">ğŸ”®</span>
        <div class="welcome-feature-text">
          <strong>QAIS Memory</strong>
          Quantum-Approximate Identity Substrate for persistent context.
        </div>
      </div>
    </div>
    <div style="font-size:0.75rem;color:var(--text-muted);font-family:var(--font-mono);text-align:center;">
      Requirements: Node.js 18+ Â· Git Â· Windows 10/11 (for AHK bridge)
    </div>
  `;
}

// â”€â”€â”€ Step 1: Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderComponents(el) {
  let html = `
    <div class="card-title">Choose Components</div>
    <div class="card-desc">Select what to install. The Control Panel is required.</div>
    <div class="component-list">
  `;
  for (const [key, comp] of Object.entries(state.components)) {
    const cls = comp.required ? 'required selected' : comp.selected ? 'selected' : '';
    html += `
      <div class="component ${cls}" onclick="${comp.required ? '' : `toggleComponent('${key}')`}" ${comp.required ? '' : ''}>
        <div class="component-check">${comp.selected || comp.required ? 'âœ“' : ''}</div>
        <span style="font-size:1.1rem">${comp.icon}</span>
        <div class="component-info">
          <div class="component-name">${comp.name}</div>
          <div class="component-desc">${comp.desc}</div>
        </div>
        <span class="component-badge ${comp.required ? 'badge-required' : 'badge-optional'}">
          ${comp.required ? 'Required' : 'Optional'}
        </span>
      </div>
    `;
  }
  html += '</div>';
  el.innerHTML = html;
}

function toggleComponent(key) {
  state.components[key].selected = !state.components[key].selected;
  renderCard();
}

// â”€â”€â”€ Step 2: Configure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderConfigure(el) {
  el.innerHTML = `
    <div class="card-title">Configure Paths</div>
    <div class="card-desc">Set your installation directory and panel port.</div>

    <div class="path-group">
      <div class="path-label">ğŸ“‚ Install Directory</div>
      <input class="path-input" type="text" value="${escapeHtml(state.paths.install)}"
        oninput="state.paths.install = this.value" />
      <div class="path-hint">BOND will create panel/, doctrine/, state/ inside this directory</div>
    </div>

    <div class="path-group">
      <div class="path-label">ğŸŒ Panel Port</div>
      <input class="path-input" type="text" value="${state.paths.port}"
        oninput="state.paths.port = this.value" style="width:120px;" />
      <div class="path-hint">Express sidecar port (default: 3000)</div>
    </div>

    <div style="margin-top:16px;padding:12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);font-size:0.78rem;color:var(--text-secondary);">
      <strong style="color:var(--amber)">ğŸ“‹ Directory structure:</strong>
      <pre style="margin-top:8px;font-family:var(--font-mono);font-size:0.72rem;color:var(--text-muted);line-height:1.8;">${escapeHtml(state.paths.install)}\\
â”œâ”€â”€ panel\\          â† React dashboard + Express server
â”œâ”€â”€ doctrine\\       â† Entity files (your knowledge domains)
â”œâ”€â”€ state\\          â† Active entity pointer${state.components.skills.selected ? `
â”œâ”€â”€ skills\\         â† Claude skill file` : ''}${state.components.ahk.selected ? `
â”œâ”€â”€ bridge\\         â† AHK automation script` : ''}${state.components.docs.selected ? `
â”œâ”€â”€ docs\\           â† Commands, entities, counter reference` : ''}
â””â”€â”€ .env             â† Configuration</pre>
    </div>
  `;
}

// â”€â”€â”€ Step 3: Review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReview(el) {
  const selected = Object.entries(state.components).filter(([k,v]) => v.selected || v.required);
  let html = `
    <div class="card-title">Review & Install</div>
    <div class="card-desc">Confirm your selections, then download the install script.</div>

    <div class="review-section">
      <div class="review-label">Components</div>
      <div class="review-items">
        ${selected.map(([k,v]) => `<span class="review-item"><span class="ri-icon">${v.icon}</span> ${v.name}</span>`).join('')}
      </div>
    </div>

    <div class="review-section">
      <div class="review-label">Install Path</div>
      <div class="review-path">${escapeHtml(state.paths.install)}</div>
    </div>

    <div class="review-section">
      <div class="review-label">Port</div>
      <div class="review-path" style="display:inline-block;">${escapeHtml(state.paths.port)}</div>
    </div>

    <div class="review-section">
      <div class="review-label">Generated Script Preview</div>
      <div class="script-preview">${escapeHtml(generateScript())}</div>
    </div>
  `;
  el.innerHTML = html;
}

// â”€â”€â”€ Step 4: Complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderComplete(el) {
  el.innerHTML = `
    <div class="complete-icon">ğŸ”¥ğŸŒŠ</div>
    <div class="complete-title">BOND is Ready</div>
    <div class="complete-desc">Run the downloaded install.bat to set up your system.</div>
    <div class="next-steps">
      <div class="next-step">
        <div class="next-step-num">1</div>
        <div>Run <code>install.bat</code> as Administrator â€” it creates directories, installs dependencies, and configures your environment.</div>
      </div>
      <div class="next-step">
        <div class="next-step-num">2</div>
        <div>Start the panel with <code>start_bond.bat</code> or <code>cd panel && node server.js</code></div>
      </div>
      <div class="next-step">
        <div class="next-step-num">3</div>
        <div>Open <code>http://localhost:${state.paths.port}</code> in your browser to see the Control Panel.</div>
      </div>
      <div class="next-step">
        <div class="next-step-num">4</div>
        <div>Add the BOND skill to your Claude project â€” paste the skill file from <code>skills/bond/SKILL.md</code></div>
      </div>
      <div class="next-step">
        <div class="next-step-num">5</div>
        <div>Type <code>{Full Restore}</code> in Claude to initialize BOND. Welcome aboard. ğŸ”¥ğŸŒŠ</div>
      </div>
    </div>
  `;
}

// â”€â”€â”€ Script Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateScript() {
  const p = state.paths.install;
  const c = state.components;
  const port = state.paths.port;

  let s = `@echo off
:: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
:: BOND Installation Script
:: Generated by BOND Wizard
:: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo  ğŸ”¥ğŸŒŠ BOND Installer
echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

set "BOND_ROOT=${p}"
set "BOND_PORT=${port}"

:: â”€â”€â”€ Create Directory Structure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo [1/5] Creating directory structure...
mkdir "%BOND_ROOT%" 2>nul
mkdir "%BOND_ROOT%\\panel" 2>nul
mkdir "%BOND_ROOT%\\doctrine" 2>nul
mkdir "%BOND_ROOT%\\state" 2>nul`;

  if (c.ahk.selected) {
    s += `\nmkdir "%BOND_ROOT%\\bridge" 2>nul`;
  }
  if (c.skills.selected) {
    s += `\nmkdir "%BOND_ROOT%\\skills\\bond" 2>nul`;
  }
  if (c.docs.selected) {
    s += `\nmkdir "%BOND_ROOT%\\docs" 2>nul`;
  }

  s += `
echo    Done.
echo.

:: â”€â”€â”€ Write Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo [2/5] Writing configuration...
(
  echo # BOND Configuration
  echo BOND_ROOT=%BOND_ROOT%
  echo DOCTRINE_PATH=%BOND_ROOT%\\doctrine
  echo STATE_PATH=%BOND_ROOT%\\state
  echo PORT=%BOND_PORT%
  echo MCP_URL=http://localhost:3002
) > "%BOND_ROOT%\\.env"
echo    .env created.

:: â”€â”€â”€ Write State File â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo {"entity":null,"class":null,"path":null,"entered":null} > "%BOND_ROOT%\\state\\active_entity.json"
echo    State file initialized.
echo.`;

  s += `

:: â”€â”€â”€ Install Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo [3/5] Installing Control Panel...
echo    Cloning BOND repository...
cd /d "%BOND_ROOT%"
git clone https://github.com/moneyjarrod/BOND.git panel_temp 2>nul
if exist panel_temp\\panel (
  xcopy /E /Y /Q "panel_temp\\panel\\*" "panel\\" >nul
  echo    Panel files copied.
) else (
  echo    âš  Could not clone repo. Copy panel files manually.
)

cd /d "%BOND_ROOT%\\panel"
if exist package.json (
  echo    Installing Node dependencies...
  call npm install
  echo    Dependencies installed.
) else (
  echo    âš  No package.json found. Panel may need manual setup.
)`;

  if (c.starter.selected) {
    s += `

:: â”€â”€â”€ Starter Entities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo [4/5] Creating starter entities...

:: Example Doctrine
mkdir "%BOND_ROOT%\\doctrine\\BOND_MASTER" 2>nul
(echo {"class":"doctrine","tools":{"filesystem":true,"iss":true},"display_name":"BOND Master"}) > "%BOND_ROOT%\\doctrine\\BOND_MASTER\\entity.json"
(
  echo # BOND Master Doctrine
  echo.
  echo Enter this entity to consult BOND's constitutional authority.
  echo Add your own IS statements, protocol rules, and audit checklists.
) > "%BOND_ROOT%\\doctrine\\BOND_MASTER\\BOND_MASTER.md"

:: Example Project
mkdir "%BOND_ROOT%\\doctrine\\MyProject" 2>nul
(echo {"class":"project","tools":{"filesystem":true,"iss":true,"qais":true,"heatmap":true,"crystal":true},"core":"CORE.md"}) > "%BOND_ROOT%\\doctrine\\MyProject\\entity.json"
(
  echo # MyProject â€” CORE
  echo.
  echo ^<!-- Define your project boundaries here. What IS your project? What ISN'T it? --^>
) > "%BOND_ROOT%\\doctrine\\MyProject\\CORE.md"

:: Example Library
mkdir "%BOND_ROOT%\\doctrine\\_reference" 2>nul
(echo {"class":"library","tools":{"filesystem":true}}) > "%BOND_ROOT%\\doctrine\\_reference\\entity.json"
(
  echo # Reference Library
  echo.
  echo Drop reference documents here. Read-only knowledge shelf.
) > "%BOND_ROOT%\\doctrine\\_reference\\index.md"
echo    Starter entities created.`;
  } else {
    s += `\necho [4/5] Skipping starter entities.`;
  }

  if (c.skills.selected) {
    s += `

:: â”€â”€â”€ Claude Skill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if exist "panel_temp\\skills\\bond\\SKILL.md" (
  copy /Y "panel_temp\\skills\\bond\\SKILL.md" "%BOND_ROOT%\\skills\\bond\\" >nul
  echo    BOND skill file copied.
) else (
  echo    âš  Skill file not found in repo. Copy manually from GitHub.
)`;
  }

  if (c.docs.selected) {
    s += `

:: â”€â”€â”€ Documentation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if exist "panel_temp\\docs" (
  xcopy /E /Y /Q "panel_temp\\docs\\*" "%BOND_ROOT%\\docs\\" >nul
  echo    Documentation copied.
) else (
  echo    âš  Docs not found in repo.
)`;
  }

  s += `

:: â”€â”€â”€ Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo [5/5] Cleaning up...
if exist "%BOND_ROOT%\\panel_temp" (
  rmdir /S /Q "%BOND_ROOT%\\panel_temp"
  echo    Temp files removed.
)`;

  s += `

:: â”€â”€â”€ Startup Script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(
  echo @echo off
  echo cd /d "%BOND_ROOT%\\panel"
  echo echo ğŸ”¥ğŸŒŠ Starting BOND Panel on port %BOND_PORT%...
  echo node server.js
) > "%BOND_ROOT%\\start_bond.bat"
echo    start_bond.bat created.

echo.
echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo  ğŸ”¥ğŸŒŠ BOND installation complete!
echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo  Start:  %BOND_ROOT%\\start_bond.bat
echo  Panel:  http://localhost:%BOND_PORT%
echo  Skill:  Add skills\\bond\\SKILL.md to Claude
echo.
pause`;

  return s;
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function next() { if (step < STEPS.length - 1) { step++; render(); } }
function prev() { if (step > 0) { step--; render(); } }

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function downloadScript() {
  const blob = new Blob([generateScript()], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'install_bond.bat';
  a.click();
  URL.revokeObjectURL(a.href);
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
</file>

<file path="panel/eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="panel/index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BOND Control Panel</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="panel/mcp_invoke.py">
"""
BOND MCP Invoke â€” Runs QAIS/ISS/Limbic tools from panel.
Called by: node server.js via child_process.execFile
Args: system tool [input]
Output: JSON to stdout
"""
import json
import sys
import os
import numpy as np

# Paths resolve from BOND_ROOT environment variable
BOND_ROOT = os.environ.get('BOND_ROOT', os.path.join(os.path.dirname(__file__), '..'))
QAIS_FIELD_PATH = os.environ.get('QAIS_FIELD_PATH', os.path.join(BOND_ROOT, 'data', 'qais_field.npz'))
ISS_PATH = os.environ.get('ISS_PATH', os.path.join(BOND_ROOT, 'modules', 'iss'))
QAIS_PATH = os.environ.get('QAIS_PATH', os.path.join(BOND_ROOT, 'modules', 'qais'))

# â”€â”€â”€ QAIS Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def qais_stats():
    """Full QAIS field stats."""
    sys.path.insert(0, QAIS_PATH)
    try:
        from qais_v4 import QAISField
        q = QAISField()
        q.load(QAIS_FIELD_PATH)
        identities = set()
        roles = set()
        facts = set()
        for key in q.stored:
            parts = key.split('|', 2)
            if len(parts) == 3:
                identities.add(parts[0])
                roles.add(parts[1])
                facts.add(parts[2])
        return {
            "status": "active",
            "total_bindings": q.count,
            "total_identities": len(identities),
            "total_roles": len(roles),
            "facts_indexed": len(facts),
            "roles_list": sorted(roles),
        }
    except Exception as e:
        return {"error": str(e)}

def qais_exists(input_str):
    """Check if identity exists in QAIS field."""
    sys.path.insert(0, QAIS_PATH)
    try:
        from qais_v4 import QAISField
        q = QAISField()
        q.load(QAIS_FIELD_PATH)
        identity = input_str.strip()
        exists = any(k.startswith(f"{identity}|") for k in q.stored)
        bindings = [k for k in q.stored if k.startswith(f"{identity}|")]
        return {
            "identity": identity,
            "exists": exists,
            "binding_count": len(bindings),
            "bindings": bindings[:20],  # Cap at 20
        }
    except Exception as e:
        return {"error": str(e)}

def qais_resonate(input_str):
    """Resonate against QAIS field. Input: identity|role|candidate1,candidate2,..."""
    sys.path.insert(0, QAIS_PATH)
    try:
        from qais_v4 import QAISField
        q = QAISField()
        q.load(QAIS_FIELD_PATH)
        
        parts = input_str.split('|', 2)
        if len(parts) < 3:
            return {"error": "Format: identity|role|candidate1,candidate2,..."}
        
        identity, role, candidates_str = parts
        candidates = [c.strip() for c in candidates_str.split(',')]
        
        results = []
        for candidate in candidates:
            score = q.resonate(identity.strip(), role.strip(), candidate)
            results.append({"candidate": candidate, "score": float(score)})
        
        results.sort(key=lambda x: x["score"], reverse=True)
        return {"identity": identity, "role": role, "results": results}
    except Exception as e:
        return {"error": str(e)}

# â”€â”€â”€ ISS Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def iss_analyze(input_str):
    """Analyze text with ISS semantic forces."""
    sys.path.insert(0, ISS_PATH)
    try:
        from iss_prototype import analyze_text
        result = analyze_text(input_str.strip())
        return {
            "text": input_str.strip()[:100],
            "G": round(float(result['G']), 4),
            "P": round(float(result['P']), 4),
            "E": round(float(result['E']), 4),
            "r": round(float(result['r']), 4),
            "gap": round(float(result['gap']), 4),
        }
    except Exception as e:
        return {"error": str(e)}

def iss_compare(input_str):
    """Compare multiple texts. Input: one text per line."""
    sys.path.insert(0, ISS_PATH)
    try:
        from iss_prototype import analyze_text
        texts = [t.strip() for t in input_str.strip().split('\n') if t.strip()]
        if len(texts) < 2:
            return {"error": "Need 2+ texts (one per line)"}
        
        results = []
        for text in texts:
            r = analyze_text(text)
            results.append({
                "text": text[:80],
                "G": round(float(r['G']), 4),
                "P": round(float(r['P']), 4),
                "E": round(float(r['E']), 4),
                "gap": round(float(r['gap']), 4),
            })
        return {"comparisons": results}
    except Exception as e:
        return {"error": str(e)}

def iss_status():
    """ISS system status."""
    return {
        "status": "active",
        "version": "2.0",
        "forces": "G (mechanistic), P (prescriptive), E (coherence), r (residual)",
        "gap_formula": "Î±â€–râ€– + Î²|â€–gâ€–-â€–pâ€–| + Î³(1-E)",
        "training": "38 G + 41 P sentences, frozen",
    }

# â”€â”€â”€ EAP Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def eap_schema():
    """Return EAP 10D schema."""
    return {
        "dimensions": 10,
        "schema": [
            "valence (-1 to 1)",
            "arousal (0 to 1)",
            "confidence (0 to 1)",
            "urgency (0 to 1)",
            "connection (0 to 1)",
            "curiosity (0 to 1)",
            "frustration (0 to 1)",
            "fatigue (0 to 1)",
            "wonder (0 to 1)",
            "trust (0 to 1)",
        ],
        "note": "Claude provides EAP from native read. Not invocable externally.",
    }

# â”€â”€â”€ Limbic Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def limbic_status():
    """Limbic system status."""
    genome_path = os.path.join(ISS_PATH, "limbic_genome_10d.json")
    try:
        with open(genome_path) as f:
            genome = json.load(f)
        return {
            "status": "active",
            "fitness": genome.get("fitness", "unknown"),
            "genome_version": "v2.0 evolved",
            "inputs": "ISS(G,P,E,r,gap) + EAP(10D) + QAIS(familiarity)",
            "outputs": "S(salience), V(valence), T(threat), G(gate)",
        }
    except Exception as e:
        return {"error": str(e)}

def limbic_scan(input_str):
    """Run ISS on text, return forces (limbic proper needs EAP from Claude)."""
    result = iss_analyze(input_str)
    if "error" in result:
        return result
    result["note"] = "Full limbic requires Claude's EAP read. Showing ISS forces only."
    return result

# â”€â”€â”€ Dispatch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

TOOLS = {
    "qais": {
        "stats": lambda _: qais_stats(),
        "exists": qais_exists,
        "resonate": qais_resonate,
    },
    "iss": {
        "analyze": iss_analyze,
        "compare": iss_compare,
        "status": lambda _: iss_status(),
    },
    "eap": {
        "schema": lambda _: eap_schema(),
    },
    "limbic": {
        "status": lambda _: limbic_status(),
        "scan": limbic_scan,
    },
}

def main():
    if len(sys.argv) < 3:
        print(json.dumps({"error": "Usage: mcp_invoke.py <system> <tool> [input]"}))
        return

    system = sys.argv[1]
    tool = sys.argv[2]
    input_str = sys.argv[3] if len(sys.argv) > 3 else ""

    if system not in TOOLS:
        print(json.dumps({"error": f"Unknown system: {system}"}))
        return
    if tool not in TOOLS[system]:
        print(json.dumps({"error": f"Unknown tool: {system}/{tool}", "available": list(TOOLS[system].keys())}))
        return

    result = TOOLS[system][tool](input_str)
    print(json.dumps(result))

if __name__ == "__main__":
    main()
</file>

<file path="panel/mcp_stats.py">
"""
BOND MCP Stats â€” Reads QAIS/ISS/Gate state and outputs JSON for panel sidecar.
Called by: node server.js via child_process.execFile
Output: JSON to stdout
"""
import json
import sys
import os

# Paths resolve from BOND_ROOT environment variable
BOND_ROOT = os.environ.get('BOND_ROOT', os.path.join(os.path.dirname(__file__), '..'))

def qais_stats():
    """Read QAIS field file and return stats."""
    field_path = os.environ.get('QAIS_FIELD_PATH', os.path.join(BOND_ROOT, 'data', 'qais_field.npz'))
    try:
        import numpy as np
        if not os.path.exists(field_path):
            return {"status": "offline", "error": "No field file"}
        data = np.load(field_path, allow_pickle=True)
        stored = set(data['stored'].tolist())
        count = int(data['count'])
        role_fields = data['role_fields'].item()
        
        # Count unique identities and facts
        identities = set()
        facts = set()
        for key in stored:
            parts = key.split('|', 2)
            if len(parts) == 3:
                identities.add(parts[0])
                facts.add(parts[2])
        
        return {
            "status": "active",
            "total_bindings": count,
            "total_identities": len(identities),
            "total_roles": len(role_fields),
            "roles": list(role_fields.keys()),
            "facts_indexed": len(facts)
        }
    except Exception as e:
        return {"status": "error", "error": str(e)}

def iss_stats():
    """ISS status from known config."""
    return {
        "status": "active",
        "version": "2.0",
        "dimensions": "G, P, E, r, gap"
    }

def eap_stats():
    """EAP status â€” 10D schema."""
    return {
        "status": "active",
        "dimensions": 10,
        "schema": "valence, arousal, confidence, urgency, connection, curiosity, frustration, fatigue, wonder, trust"
    }

def limbic_stats():
    """Limbic evolver status."""
    return {
        "status": "active",
        "fitness": 0.017,
        "genome": "v2.0 evolved"
    }

def main():
    system = sys.argv[1] if len(sys.argv) > 1 else "all"
    
    handlers = {
        "qais": qais_stats,
        "iss": iss_stats,
        "eap": eap_stats,
        "limbic": limbic_stats,
    }
    
    if system == "all":
        results = {name: fn() for name, fn in handlers.items()}
        print(json.dumps(results))
    elif system in handlers:
        print(json.dumps(handlers[system]()))
    else:
        print(json.dumps({"error": f"Unknown system: {system}"}))

if __name__ == "__main__":
    main()
</file>

<file path="panel/modules/eap.json">
{
  "id": "eap",
  "name": "EAP",
  "icon": "ğŸ­",
  "description": "Emotion Array Processor â€” 10D Schema",
  "status_endpoint": "/api/mcp/eap/status",
  "display_fields": [
    { "key": "dimensions", "label": "Dimensions", "icon": "ğŸ“Š" },
    { "key": "schema", "label": "Schema", "icon": "ğŸ§¬" }
  ],
  "refresh_interval": 60
}
</file>

<file path="panel/modules/iss.json">
{
  "id": "iss",
  "name": "ISS",
  "icon": "ğŸ“",
  "description": "Invariant Semantic Substrate",
  "status_endpoint": "/api/mcp/iss/status",
  "display_fields": [
    { "key": "version", "label": "Version", "icon": "ğŸ“‹" },
    { "key": "dimensions", "label": "Forces", "icon": "ğŸ“Š" }
  ],
  "refresh_interval": 60
}
</file>

<file path="panel/modules/limbic.json">
{
  "id": "limbic",
  "name": "Limbic",
  "icon": "ğŸ§ ",
  "description": "Limbic Integration â€” 10D Evolved Genome",
  "status_endpoint": "/api/mcp/limbic/status",
  "display_fields": [
    { "key": "fitness", "label": "Fitness", "icon": "ğŸ¯" },
    { "key": "genome", "label": "Genome", "icon": "ğŸ§¬" }
  ],
  "refresh_interval": 60
}
</file>

<file path="panel/modules/qais.json">
{
  "id": "qais",
  "name": "QAIS",
  "icon": "ğŸ”®",
  "description": "Quantum-Approximate Identity Substrate",
  "status_endpoint": "/api/mcp/qais/stats",
  "display_fields": [
    { "key": "total_bindings", "label": "Bindings", "icon": "ğŸ”—" },
    { "key": "total_identities", "label": "Identities", "icon": "ğŸ‘¤" },
    { "key": "total_roles", "label": "Roles", "icon": "ğŸ·ï¸" },
    { "key": "facts_indexed", "label": "Facts", "icon": "ğŸ“„" }
  ],
  "refresh_interval": 30
}
</file>

<file path="panel/package.json">
{
  "name": "panel",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "server": "node server.js",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "cors": "^2.8.6",
    "express": "^5.2.1",
    "react": "^19.2.0",
    "react-dom": "^19.2.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "vite": "^7.2.4"
  }
}
</file>

<file path="panel/public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="panel/README.md">
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.
</file>

<file path="panel/src/components/CommandBar.jsx">
// Command Bar â€” Bottom bar with BOND commands
// Clipboard bridge: copies "BOND:{command}" â†’ AHK picks it up via OnClipboardChange

import { useState, useCallback } from 'react';

const COMMANDS = [
  { icon: 'ğŸ”„', label: 'Restore', value: '{Full Restore}' },
  { icon: 'âš¡', label: 'Sync',    value: '{Sync}' },
  { icon: 'ğŸ’¾', label: 'Save',    value: '{Save}' },
  { icon: 'ğŸ’', label: 'Crystal', value: '{Crystal}' },
  { icon: 'ğŸ“', label: 'Tick',    value: '{Tick}' },
  { icon: 'ğŸŒ€', label: 'Chunk',   value: '{Chunk}' },
];

const BRIDGE_PREFIX = 'BOND:';

export default function CommandBar() {
  const [sentCmd, setSentCmd] = useState(null);

  const handleClick = useCallback(async (cmd) => {
    try {
      await navigator.clipboard.writeText(BRIDGE_PREFIX + cmd.value);
      setSentCmd(cmd.value);
      setTimeout(() => setSentCmd(null), 1200);
    } catch (err) {
      console.error('Clipboard write failed:', err);
      // Fallback: textarea copy
      const ta = document.createElement('textarea');
      ta.value = BRIDGE_PREFIX + cmd.value;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      setSentCmd(cmd.value);
      setTimeout(() => setSentCmd(null), 1200);
    }
  }, []);

  return (
    <div className="command-bar">
      <span
        title="Clipboard bridge â€” clicks copy to AHK"
        style={{
          width: 8,
          height: 8,
          borderRadius: '50%',
          background: 'var(--status-active)',
          marginRight: 8,
          flexShrink: 0,
          boxShadow: '0 0 6px rgba(63, 185, 80, 0.5)',
        }}
      />
      {COMMANDS.map((cmd) => (
        <button
          key={cmd.value}
          className={`cmd-btn ${sentCmd === cmd.value ? 'sent' : ''}`}
          onClick={() => handleClick(cmd)}
          title={cmd.value}
        >
          <span className="cmd-icon">{cmd.icon}</span>
          <span>{cmd.label}</span>
        </button>
      ))}
    </div>
  );
}
</file>

<file path="panel/src/components/CreateEntity.jsx">
// BOND Control Panel â€” CreateEntity Modal
// B69: Four-Class Architecture â€” create new entity folders

import { useState } from 'react';

const CLASS_INFO = {
  doctrine: { icon: 'ğŸ“œ', desc: 'Static truth. IS statements. Immutable method.' },
  project:  { icon: 'âš’ï¸', desc: 'Active work. Has CORE boundary + growth.' },
  perspective: { icon: 'ğŸ”­', desc: 'Evolving lens. Seeds that grow through resonance.' },
  library:  { icon: 'ğŸ“š', desc: 'Read-only reference. Knowledge store.' },
};

export default function CreateEntity({ entityClass, onCreated, onCancel }) {
  const [name, setName] = useState('');
  const [error, setError] = useState(null);
  const [creating, setCreating] = useState(false);

  const info = CLASS_INFO[entityClass] || CLASS_INFO.library;

  const handleSubmit = async (e) => {
    e.preventDefault();
    const trimmed = name.trim();
    if (!trimmed) return;

    setCreating(true);
    setError(null);

    try {
      const res = await fetch('/api/doctrine', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: trimmed, class: entityClass }),
      });
      const data = await res.json();
      if (!res.ok) {
        setError(data.error || 'Creation failed');
        setCreating(false);
        return;
      }
      onCreated(data);
    } catch (err) {
      setError(err.message);
      setCreating(false);
    }
  };

  return (
    <div className="modal-overlay" onClick={onCancel}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <span>{info.icon} New {entityClass.charAt(0).toUpperCase() + entityClass.slice(1)}</span>
          <button className="modal-close" onClick={onCancel}>âœ•</button>
        </div>

        <p className="modal-desc">{info.desc}</p>

        <form onSubmit={handleSubmit}>
          <label className="modal-label">
            Entity Name
            <input
              type="text"
              className="modal-input"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder={entityClass === 'perspective' ? 'P12-Name' : 'EntityName'}
              autoFocus
              disabled={creating}
            />
          </label>

          <p className="modal-hint">
            Letters, numbers, hyphens, underscores only. Becomes the folder name.
          </p>

          {error && <p className="modal-error">âš ï¸ {error}</p>}

          <div className="modal-actions">
            <button type="button" className="btn-cancel" onClick={onCancel} disabled={creating}>
              Cancel
            </button>
            <button type="submit" className="btn-confirm" disabled={!name.trim() || creating}>
              {creating ? 'Creating...' : 'Create'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="panel/src/components/DoctrineViewer.jsx">
// DoctrineViewer.jsx â€” Reads doctrine folders, displays file content
// Left sidebar: file list with ğŸ”’/ğŸŒ± icons
// Right panel: file content (pre-formatted for now, markdown renderer in Session 6)

import { useState } from 'react';
import { useEntityFiles, useFileContent } from '../hooks/useDoctrine';

// Class-appropriate file icons (B69)
const CLASS_FILE_ICON = {
  doctrine: 'ğŸ“œ',
  project: 'ğŸ“„',
  perspective: 'ğŸŒ¿',
  library: 'ğŸ“„',
};
const GROWTH_ICON = 'ğŸŒ±';
const CORE_ICON = 'ğŸ”’';

export default function DoctrineViewer({
  viewerTarget,
  activeEntity,
  loadedEntities,
  onUnload,
  entityType,
  entityCore,
}) {
  const [selectedFile, setSelectedFile] = useState(null);
  const { files, loading: filesLoading } = useEntityFiles(viewerTarget);
  const { content, meta, loading: contentLoading } = useFileContent(viewerTarget, selectedFile);

  if (!viewerTarget) {
    return (
      <div className="placeholder">
        <div className="placeholder-icon">ğŸ“–</div>
        <div className="placeholder-text">No entity selected</div>
        <div className="placeholder-sub">Click View or Enter on an entity card</div>
      </div>
    );
  }

  const isLoaded = loadedEntities.includes(viewerTarget);
  const isActive = activeEntity?.name === viewerTarget;

  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
      {/* Viewer header */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: '8px 0 12px',
        borderBottom: '1px solid var(--border)',
        marginBottom: 12,
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          <span style={{ fontSize: '1.1rem' }}>ğŸ“–</span>
          <span style={{ fontWeight: 600 }}>{viewerTarget}</span>
          {isActive && <span className="badge badge-active">ACTIVE</span>}
          {isLoaded && !isActive && <span className="badge badge-active">LOADED</span>}
        </div>
        {(isLoaded || isActive) && (
          <button
            onClick={() => onUnload(viewerTarget)}
            style={{
              padding: '4px 12px',
              fontSize: '0.75rem',
              fontFamily: 'var(--font-mono)',
              background: 'var(--bg-elevated)',
              color: 'var(--status-suspend)',
              border: '1px solid rgba(233,69,96,0.3)',
              borderRadius: 'var(--radius-sm)',
              cursor: 'pointer',
            }}
          >
            Unload
          </button>
        )}
      </div>

      {/* Main content area */}
      <div style={{ display: 'flex', flex: 1, gap: 12, minHeight: 0 }}>
        {/* File sidebar */}
        <div style={{
          width: 180,
          flexShrink: 0,
          borderRight: '1px solid var(--border)',
          paddingRight: 12,
          overflowY: 'auto',
        }}>
          <div className="text-muted" style={{
            fontSize: '0.65rem',
            fontFamily: 'var(--font-mono)',
            textTransform: 'uppercase',
            letterSpacing: '0.5px',
            marginBottom: 8,
          }}>
            Files
          </div>

          {filesLoading ? (
            <div className="text-muted" style={{ fontSize: '0.8rem' }}>Loading...</div>
          ) : files.length === 0 ? (
            <div className="text-muted" style={{ fontSize: '0.8rem' }}>No files</div>
          ) : (
            files.map(f => (
              <FileEntry
                key={f.name}
                file={f}
                isSelected={selectedFile === f.name}
                onClick={() => setSelectedFile(f.name)}
                entityType={entityType}
                entityCore={entityCore}
              />
            ))
          )}
        </div>

        {/* Content panel */}
        <div style={{ flex: 1, overflowY: 'auto', minHeight: 0 }}>
          {!selectedFile ? (
            <div className="text-muted" style={{
              fontSize: '0.8rem',
              fontFamily: 'var(--font-mono)',
              padding: 20,
              textAlign: 'center',
            }}>
              Select a file to view
            </div>
          ) : contentLoading ? (
            <div className="text-muted" style={{ fontSize: '0.8rem', padding: 20 }}>Loading...</div>
          ) : (
            <div>
              {/* File header */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: 8,
                marginBottom: 12,
                paddingBottom: 8,
                borderBottom: '1px solid var(--border)',
              }}>
                <span>{meta?.type === 'growth' ? GROWTH_ICON : (CLASS_FILE_ICON[entityType] || 'ğŸ“„')}</span>
                <span style={{ fontWeight: 600, fontSize: '0.9rem' }}>{selectedFile}</span>
                <span className="text-muted" style={{ fontSize: '0.7rem', fontFamily: 'var(--font-mono)' }}>
                  ({meta?.type === 'growth' ? 'growth' : entityType || 'file'})
                </span>
              </div>

              {/* File content */}
              <pre style={{
                fontFamily: 'var(--font-mono)',
                fontSize: '0.82rem',
                lineHeight: 1.6,
                color: 'var(--text-primary)',
                whiteSpace: 'pre-wrap',
                wordBreak: 'break-word',
                padding: 0,
                margin: 0,
                background: 'transparent',
              }}>
                {content}
              </pre>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

function FileEntry({ file, isSelected, onClick, entityType, entityCore }) {
  const isCore = entityCore && file.name === entityCore;
  const icon = isCore ? CORE_ICON
    : file.type === 'growth' ? GROWTH_ICON
    : (CLASS_FILE_ICON[entityType] || 'ğŸ“„');
  const displayName = file.name.replace('.md', '');

  return (
    <button
      onClick={onClick}
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        width: '100%',
        padding: '5px 8px',
        marginBottom: 2,
        background: isSelected ? 'var(--bg-hover)' : 'transparent',
        border: 'none',
        borderRadius: 'var(--radius-sm)',
        color: isSelected ? 'var(--text-primary)' : 'var(--text-secondary)',
        fontSize: '0.78rem',
        fontFamily: 'var(--font-mono)',
        cursor: 'pointer',
        textAlign: 'left',
        transition: 'all 0.1s ease',
      }}
    >
      <span style={{ fontSize: '0.7rem' }}>{icon}</span>
      <span>{displayName}</span>
    </button>
  );
}
</file>

<file path="panel/src/components/EntityCards.jsx">
// EntityCards.jsx â€” Four-Class Entity Architecture (B69)
// Doctrine: IS statements, Files + ISS
// Project: Bounded workspace, Files + QAIS + Heatmap + Crystal + ISS, has CORE
// Perspective: Unbounded growth, Files + QAIS + Heatmap + Crystal
// Library: Reference shelf, Files only

import { useState, useMemo, useCallback } from 'react';

// Tool definitions with class availability
const TOOLS = [
  { id: 'filesystem', icon: 'ğŸ“', label: 'Files',   classes: ['doctrine','project','perspective','library'] },
  { id: 'iss',        icon: 'ğŸ“', label: 'ISS',     classes: ['doctrine','project'] },
  { id: 'qais',       icon: 'ğŸ”®', label: 'QAIS',    classes: ['project','perspective'] },
  { id: 'heatmap',    icon: 'ğŸ”¥', label: 'Heat',    classes: ['project','perspective'] },
  { id: 'crystal',    icon: 'ğŸ’', label: 'Crystal', classes: ['project','perspective'] },
];

// Class display info
const CLASS_META = {
  doctrine:    { icon: 'ğŸ“œ', label: 'DC', badge: 'badge-dc', name: 'Doctrine' },
  project:     { icon: 'âš’ï¸', label: 'PC', badge: 'badge-pc', name: 'Project' },
  perspective: { icon: 'ğŸ”­', label: 'PP', badge: 'badge-pp', name: 'Perspective' },
  library:     { icon: 'ğŸ“š', label: 'LB', badge: 'badge-lb', name: 'Library' },
};

// Base perspective slots (P01-P10)
const BASE_PERSPECTIVES = Array.from({ length: 10 }, (_, i) => {
  const num = String(i + 1).padStart(2, '0');
  return {
    name: `P${num}`,
    type: 'perspective',
    files: [],
    tools: { filesystem: true, qais: true, heatmap: true, crystal: true },
    seed_count: 0,
    growth_count: 0,
    doctrine_count: 0,
    core: null,
    isBase: true,
    label: num === '10' ? 'Wildcard' : null,
  };
});

export default function EntityCards({
  entities,
  filter,          // 'doctrine', 'project', 'perspective', or 'library'
  loadedEntities,
  activeEntity,
  onView,
  onLoad,
  onEnter,
  onToolToggle,
  onRename,
  onExit,
}) {
  const cards = useMemo(() => {
    if (filter === 'perspective') {
      const detected = entities.filter(e => e.type === 'perspective');
      const detectedNames = new Set(detected.map(e => e.name));

      const base = BASE_PERSPECTIVES.map(bp => {
        const match = detected.find(d => d.name.startsWith(bp.name));
        if (match) return { ...match, isBase: true, label: bp.label };
        return bp;
      });

      const userCreated = detected.filter(d => {
        const num = parseInt(d.name.match(/^P(\d+)/)?.[1] || '0', 10);
        return num > 10;
      }).map(e => ({ ...e, isBase: false, label: null }));

      return [...base, ...userCreated];
    }

    return entities
      .filter(e => e.type === filter)
      .map(e => ({ ...e, isBase: false, label: null }));
  }, [entities, filter]);

  const meta = CLASS_META[filter] || CLASS_META.library;

  if (cards.length === 0) {
    return (
      <div className="placeholder">
        <div className="placeholder-icon">{meta.icon}</div>
        <div className="placeholder-text">No {meta.name.toLowerCase()} entities found</div>
        <div className="placeholder-sub">Add a folder with entity.json to doctrine/ directory</div>
      </div>
    );
  }

  return (
    <div className="card-grid">
      {cards.map(entity => (
        <EntityCard
          key={entity.name}
          entity={entity}
          isLoaded={loadedEntities.includes(entity.name)}
          isActive={activeEntity?.name === entity.name}
          onView={onView}
          onLoad={onLoad}
          onEnter={onEnter}
          onToolToggle={onToolToggle}
          onRename={onRename}
          onExit={onExit}
        />
      ))}
    </div>
  );
}

function EntityCard({ entity, isLoaded, isActive, onView, onLoad, onEnter, onExit, onToolToggle, onRename }) {
  const isEmpty = entity.isBase && entity.seed_count === 0 && entity.files.length === 0;
  const meta = CLASS_META[entity.type] || CLASS_META.library;
  const tools = entity.tools || {};
  const [editing, setEditing] = useState(false);
  const [editValue, setEditValue] = useState('');
  const [saved, setSaved] = useState(false);

  const handleToggle = useCallback((toolId) => {
    if (onToolToggle) {
      onToolToggle(entity.name, toolId, !tools[toolId]);
    }
  }, [entity.name, tools, onToolToggle]);

  const handleEditStart = useCallback(() => {
    setEditValue(entity.display_name || entity.name);
    setEditing(true);
  }, [entity.display_name, entity.name]);

  const handleEditSave = useCallback(() => {
    const trimmed = editValue.trim();
    if (trimmed && trimmed !== entity.name && onRename) {
      onRename(entity.name, trimmed);
      setSaved(true);
      setTimeout(() => setSaved(false), 1200);
    } else if ((!trimmed || trimmed === entity.name) && onRename) {
      onRename(entity.name, null);
    }
    setEditing(false);
  }, [editValue, entity.name, onRename]);

  const handleEditKey = useCallback((e) => {
    if (e.key === 'Enter') handleEditSave();
    if (e.key === 'Escape') setEditing(false);
  }, [handleEditSave]);

  const displayName = entity.display_name || entity.name;
  const showFolder = entity.display_name && entity.display_name !== entity.name;

  return (
    <div className={`card ${isActive ? 'card-active' : ''}`} style={isActive ? activeStyle : {}}>
      {/* Header row */}
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <span style={{ fontSize: '1.1rem' }}>{meta.icon}</span>
          {editing ? (
            <input
              autoFocus
              value={editValue}
              onChange={e => setEditValue(e.target.value)}
              onKeyDown={handleEditKey}
              onBlur={handleEditSave}
              style={{
                fontWeight: 600, fontSize: '0.95rem',
                background: 'var(--bg-elevated)', color: 'var(--text-primary)',
                border: '1px solid var(--accent-amber)', borderRadius: 'var(--radius-sm)',
                padding: '2px 6px', fontFamily: 'var(--font-mono)',
                outline: 'none', width: 160,
              }}
            />
          ) : (
            <>
              <span style={{ fontWeight: 600, fontSize: '0.95rem' }}>{displayName}</span>
              {showFolder && (
                <span className="text-muted" style={{ fontSize: '0.7rem' }}>({entity.name})</span>
              )}
              {!isEmpty && (
                <button
                  onClick={handleEditStart}
                  title="Rename"
                  style={{
                    background: 'none', border: 'none', cursor: 'pointer',
                    fontSize: '0.75rem', color: saved ? 'var(--accent-amber)' : 'var(--text-muted)', padding: '0 2px',
                    opacity: saved ? 1 : 0.6, transition: 'all 0.15s',
                  }}
                  onMouseEnter={e => { if (!saved) e.target.style.opacity = 1; }}
                  onMouseLeave={e => { if (!saved) e.target.style.opacity = 0.6; }}
                >{saved ? 'âœ…' : 'âœï¸'}</button>
              )}
            </>
          )}
          {entity.label && (
            <span className="text-muted" style={{ fontSize: '0.75rem', fontStyle: 'italic' }}>
              â€” {entity.label}
            </span>
          )}
        </div>
        <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>
          {isLoaded && <span className="badge badge-active">LOADED</span>}
          {isActive && <span className="badge badge-active">ACTIVE</span>}
          {entity.core && <span className="badge badge-core">ğŸ”’ CORE</span>}
          <span className={`badge ${meta.badge}`}>{meta.label}</span>
        </div>
      </div>

      {/* Counts */}
      {isEmpty ? (
        <div className="text-muted" style={{ fontSize: '0.8rem', marginBottom: 8, fontFamily: 'var(--font-mono)' }}>
          Empty â€” no files yet
        </div>
      ) : (
        <div className="text-secondary" style={{ fontSize: '0.8rem', marginBottom: 8, fontFamily: 'var(--font-mono)' }}>
          {entity.type === 'doctrine' && (
            <>ğŸ”’ {entity.doctrine_count} doctrine</>
          )}
          {entity.type === 'project' && (
            <>ğŸ”’ {entity.doctrine_count} core Â· ğŸŒ± {entity.growth_count} growth</>
          )}
          {entity.type === 'perspective' && (
            <>ğŸŒ¿ {entity.seed_count} seeds Â· ğŸŒ± {entity.growth_count} growth</>
          )}
          {entity.type === 'library' && (
            <>ğŸ“„ {entity.files.length} files</>
          )}
        </div>
      )}

      {/* Tool toggles (B69) */}
      <div style={{
        display: 'flex',
        gap: 4,
        marginBottom: 10,
        padding: '6px 0',
        borderTop: '1px solid var(--border)',
        borderBottom: '1px solid var(--border)',
      }}>
        {TOOLS.map(tool => {
          const allowed = tool.classes.includes(entity.type);
          const enabled = allowed && tools[tool.id];

          return (
            <ToolBadge
              key={tool.id}
              icon={tool.icon}
              label={tool.label}
              allowed={allowed}
              enabled={enabled}
              onClick={allowed ? () => handleToggle(tool.id) : undefined}
            />
          );
        })}
      </div>

      {/* Action buttons */}
      <div style={{ display: 'flex', gap: 8 }}>
        <ActionBtn label="View" disabled={isEmpty} onClick={() => onView(entity)} />
        <ActionBtn label="Load" disabled={isEmpty || isLoaded} onClick={() => onLoad(entity)} />
        {isActive ? (
          <ActionBtn label="Exit" disabled={false} primary={true} onClick={() => onExit && onExit()} />
        ) : (
          <ActionBtn label="Enter" disabled={false} primary={true} onClick={() => onEnter(entity)} />
        )}
      </div>
    </div>
  );
}

function ToolBadge({ icon, label, allowed, enabled, onClick }) {
  return (
    <button
      onClick={onClick}
      disabled={!allowed}
      title={!allowed ? `${label}: not available for this class` : enabled ? `${label}: on` : `${label}: off`}
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: 3,
        padding: '2px 6px',
        fontSize: '0.7rem',
        fontFamily: 'var(--font-mono)',
        background: enabled ? 'rgba(209,154,102,0.15)' : 'transparent',
        color: !allowed ? 'var(--text-muted)' : enabled ? 'var(--accent-amber)' : 'var(--text-secondary)',
        border: `1px solid ${!allowed ? 'transparent' : enabled ? 'rgba(209,154,102,0.4)' : 'var(--border)'}`,
        borderRadius: 'var(--radius-sm)',
        cursor: allowed ? 'pointer' : 'not-allowed',
        opacity: allowed ? 1 : 0.35,
        transition: 'all 0.15s ease',
      }}
    >
      <span style={{ fontSize: '0.65rem' }}>{icon}</span>
      <span>{label}</span>
    </button>
  );
}

function ActionBtn({ label, disabled, primary, onClick }) {
  return (
    <button
      disabled={disabled}
      onClick={onClick}
      style={{
        padding: '5px 14px',
        fontSize: '0.78rem',
        fontFamily: 'var(--font-mono)',
        background: disabled ? 'transparent' : primary ? 'var(--accent-dim)' : 'var(--bg-elevated)',
        color: disabled ? 'var(--text-muted)' : primary ? 'var(--accent)' : 'var(--text-secondary)',
        border: `1px solid ${disabled ? 'var(--border)' : primary ? 'rgba(233,69,96,0.4)' : 'var(--border)'}`,
        borderRadius: 'var(--radius-sm)',
        cursor: disabled ? 'not-allowed' : 'pointer',
        transition: 'all 0.15s ease',
      }}
    >
      {label}
    </button>
  );
}

const activeStyle = {
  borderColor: 'var(--accent)',
  boxShadow: '0 0 0 1px var(--accent), 0 4px 12px rgba(233, 69, 96, 0.2)',
};
</file>

<file path="panel/src/components/Header.jsx">
// ğŸ”¥ğŸŒŠ BOND Control â€” Header with Van Damme branding + four-class status

const CLASS_COLORS = {
  doctrine:    { bg: 'rgba(210,153,34,0.15)', border: 'rgba(210,153,34,0.4)', color: '#d29922', label: 'DC' },
  project:     { bg: 'rgba(209,154,102,0.15)', border: 'rgba(209,154,102,0.4)', color: '#d19a66', label: 'PC' },
  perspective: { bg: 'rgba(88,166,255,0.15)', border: 'rgba(88,166,255,0.3)', color: '#58a6ff', label: 'PP' },
  library:     { bg: 'rgba(139,148,158,0.15)', border: 'rgba(139,148,158,0.3)', color: '#8b949e', label: 'LB' },
};

export default function Header({
  activeEntity = null,
  modules = [],
  classCounts = {},
}) {
  const activeCount = modules.filter(m => m.status === 'active').length;
  const qais = modules.find(m => m.id === 'qais');
  const iss = modules.find(m => m.id === 'iss');

  const qaisLabel = qais?.status === 'active'
    ? (qais.data?.total_bindings ?? 'âœ“')
    : '--';
  const issLabel = iss?.status === 'active'
    ? (iss.data?.version ?? 'âœ“')
    : '--';

  return (
    <header className="header">
      <div className="header-title">
        <span className="header-logo">ğŸ”¥ğŸŒŠ</span>
        <div style={{ display: 'flex', flexDirection: 'column', gap: 0 }}>
          <span className="header-label">BOND Control</span>
          <span style={{
            fontSize: '0.6rem',
            fontFamily: 'var(--font-mono)',
            color: 'var(--text-muted)',
            letterSpacing: '1.5px',
            textTransform: 'uppercase',
            lineHeight: 1,
            marginTop: -1,
          }}>
            BOND-Claude Van Damme
          </span>
        </div>
        {activeEntity && <ActiveEntityBadge entity={activeEntity} />}
      </div>
      <div className="header-status">
        <StatusItem label="Sys" value={`${activeCount}/${modules.length}`} className={activeCount > 0 ? 'active' : ''} />
        <Sep />
        <StatusItem label="Q" value={String(qaisLabel)} className={qais?.status === 'active' ? 'active' : ''} />
        <Sep />
        <StatusItem label="ISS" value={String(issLabel)} className={iss?.status === 'active' ? 'active' : ''} />
        <Sep />
        <StatusItem label="ğŸ“‹" value="clip" className="active" />
      </div>
    </header>
  );
}

function ActiveEntityBadge({ entity }) {
  const cls = CLASS_COLORS[entity.type] || CLASS_COLORS.library;
  return (
    <span style={{
      display: 'inline-flex',
      alignItems: 'center',
      gap: 6,
      marginLeft: 12,
      padding: '2px 10px',
      background: cls.bg,
      border: `1px solid ${cls.border}`,
      borderRadius: 'var(--radius-sm)',
      fontFamily: 'var(--font-mono)',
      fontSize: '0.78rem',
      color: cls.color,
    }}>
      <span style={{
        fontSize: '0.6rem',
        opacity: 0.7,
        fontWeight: 600,
      }}>{cls.label}</span>
      {entity.name}
    </span>
  );
}

function StatusItem({ label, value, className = '' }) {
  return (
    <span className="status-item">
      <span className="status-label">{label}</span>
      <span className={`status-value ${className}`}>{value}</span>
    </span>
  );
}

function Sep() {
  return <span className="status-sep">Â·</span>;
}
</file>

<file path="panel/src/components/ModuleBay.jsx">
// ModuleBay â€” Module management hub with expandable detail panels
// Session 3: Replaces raw SystemStatus cards with interactive bay
import { useState, useCallback } from 'react';
import { useModules } from '../hooks/useModules';
import ModuleRenderer from './ModuleRenderer';

export default function ModuleBay() {
  const { modules, loading, refresh, toggleModule } = useModules();
  const [expandedModule, setExpandedModule] = useState(null);

  const handleExpand = useCallback((mod) => {
    if (expandedModule?.id === mod.id) {
      setExpandedModule(null);
    } else {
      setExpandedModule(mod);
    }
  }, [expandedModule]);

  if (loading) {
    return (
      <div className="placeholder">
        <div className="placeholder-text" style={{ fontFamily: 'var(--font-mono)' }}>
          Loading modules...
        </div>
      </div>
    );
  }

  if (modules.length === 0) {
    return (
      <div className="placeholder">
        <div className="placeholder-icon">âš™ï¸</div>
        <div className="placeholder-text">No modules found</div>
        <div className="placeholder-sub">
          Add .json configs to panel/modules/
        </div>
      </div>
    );
  }

  // Separate active vs inactive
  const active = modules.filter(m => m.enabled && m.status === 'active');
  const enabled = modules.filter(m => m.enabled && m.status !== 'active');
  const disabled = modules.filter(m => !m.enabled);

  return (
    <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
      {/* Bay Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <span className="text-muted" style={{ fontFamily: 'var(--font-mono)', fontSize: '0.75rem' }}>
            {active.length} active Â· {enabled.length} waiting Â· {disabled.length} off
          </span>
        </div>
        <button onClick={refresh} className="btn-icon" title="Refresh all">
          â†» Refresh
        </button>
      </div>

      {/* Module Cards */}
      <div className="module-bay-grid">
        {modules.map((mod) => (
          <ModuleBayCard
            key={mod.id}
            module={mod}
            expanded={expandedModule?.id === mod.id}
            onToggle={() => toggleModule(mod.id)}
            onExpand={() => handleExpand(mod)}
          />
        ))}
      </div>

      {/* Expanded Detail Panel */}
      {expandedModule && (
        <ModuleRenderer
          key={expandedModule.id}
          module={expandedModule}
          onClose={() => setExpandedModule(null)}
        />
      )}
    </div>
  );
}

function ModuleBayCard({ module, expanded, onToggle, onExpand }) {
  const isEnabled = module.enabled;
  const isLive = module.status === 'active';

  const borderColor = isEnabled
    ? (isLive ? 'var(--amber)' : 'var(--teal)')
    : 'var(--border)';

  return (
    <div
      className={`card module-bay-card ${expanded ? 'expanded' : ''}`}
      style={{
        borderLeft: `3px solid ${borderColor}`,
        opacity: isEnabled ? 1 : 0.5,
        cursor: 'pointer',
        transition: 'all 0.2s',
      }}
      onClick={onExpand}
    >
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <span style={{ fontSize: '1.2rem' }}>{module.icon}</span>
          <div>
            <span style={{ fontWeight: 600, fontSize: '0.9rem' }}>{module.name}</span>
            {isLive && (
              <span style={{
                marginLeft: 8,
                display: 'inline-block',
                width: 6, height: 6,
                borderRadius: '50%',
                background: 'var(--amber)',
                boxShadow: '0 0 4px var(--amber)',
              }} />
            )}
          </div>
        </div>

        {/* Toggle â€” stop propagation so it doesn't expand */}
        <button
          onClick={(e) => { e.stopPropagation(); onToggle(); }}
          title={isEnabled ? 'Disable' : 'Enable'}
          style={{
            position: 'relative',
            width: 36,
            height: 20,
            borderRadius: 10,
            border: `1px solid ${isEnabled ? 'transparent' : 'var(--border)'}`,
            background: isEnabled ? (isLive ? 'var(--amber)' : 'var(--teal)') : 'var(--bg-elevated)',
            cursor: 'pointer',
            transition: 'background 0.2s',
            padding: 0,
            flexShrink: 0,
          }}
        >
          <span style={{
            position: 'absolute',
            top: 2,
            left: isEnabled ? 18 : 2,
            width: 14,
            height: 14,
            borderRadius: '50%',
            background: isEnabled ? '#fff' : 'var(--text-muted)',
            transition: 'left 0.2s',
            boxShadow: '0 1px 2px rgba(0,0,0,0.3)',
          }} />
        </button>
      </div>

      {/* Compact stats when not expanded */}
      {isEnabled && isLive && module.data && !expanded && (
        <div className="text-muted" style={{
          fontSize: '0.7rem',
          fontFamily: 'var(--font-mono)',
          marginTop: 6,
          display: 'flex',
          gap: 10,
          flexWrap: 'wrap',
        }}>
          {(module.display_fields || []).slice(0, 3).map((field) => {
            const value = module.data[field.key];
            return value !== undefined ? (
              <span key={field.key}>
                {field.icon} <span style={{ color: 'var(--amber)' }}>{String(value)}</span>
              </span>
            ) : null;
          })}
        </div>
      )}

      {!isEnabled && (
        <div className="text-muted" style={{ fontSize: '0.7rem', fontFamily: 'var(--font-mono)', marginTop: 4 }}>
          Disabled
        </div>
      )}
    </div>
  );
}
</file>

<file path="panel/src/components/ModuleRenderer.jsx">
// ModuleRenderer â€” Expanded module detail view with live stats + tool invocation
// S3/S4: Renders full module panel when clicked from ModuleBay
// S81 polish: data-driven tools, offline/error distinction, loading states
import { useState, useEffect, useCallback } from 'react';

const API = 'http://localhost:3000';

// Tools defined as data â€” adding a module means adding an entry here, not editing JSX
const MODULE_TOOLS = {
  qais: [
    { id: 'resonate', label: 'Resonate', icon: 'ğŸ”®', inputLabel: 'Identity|Role|Candidates (comma-sep)', needsInput: true },
    { id: 'exists', label: 'Exists?', icon: 'â“', inputLabel: 'Identity to check', needsInput: true },
    { id: 'stats', label: 'Full Stats', icon: 'ğŸ“Š', needsInput: false },
  ],
  iss: [
    { id: 'analyze', label: 'Analyze', icon: 'ğŸ“', inputLabel: 'Text to analyze', needsInput: true },
    { id: 'compare', label: 'Compare', icon: 'âš–ï¸', inputLabel: 'Texts (one per line)', needsInput: true },
    { id: 'status', label: 'Status', icon: 'ğŸ“‹', needsInput: false },
  ],
  eap: [
    { id: 'schema', label: 'Schema', icon: 'ğŸ§¬', needsInput: false },
  ],
  limbic: [
    { id: 'scan', label: 'Limbic Scan', icon: 'ğŸ§ ', inputLabel: 'Text to scan', needsInput: true },
    { id: 'status', label: 'Status', icon: 'ğŸ“‹', needsInput: false },
  ],
};

// Allow custom modules to define tools in their JSON
function getTools(module) {
  if (module.tools && Array.isArray(module.tools)) return module.tools;
  return MODULE_TOOLS[module.id] || [];
}

export default function ModuleRenderer({ module, onClose }) {
  const [stats, setStats] = useState(module.data || null);
  const [statsError, setStatsError] = useState(null);
  const [loading, setLoading] = useState(false);
  const [toolResult, setToolResult] = useState(null);
  const [toolInput, setToolInput] = useState('');
  const [activeTool, setActiveTool] = useState(null);
  const [toolLoading, setToolLoading] = useState(false);

  const tools = getTools(module);

  const refreshStats = useCallback(async () => {
    setLoading(true);
    setStatsError(null);
    try {
      const res = await fetch(`${API}${module.status_endpoint}`, {
        signal: AbortSignal.timeout(3000),
      });
      if (res.ok) {
        const data = await res.json();
        if (data.status === 'error' || data.error) {
          setStatsError(data.error || 'Server returned error');
          setStats(data);
        } else {
          setStats(data);
        }
      } else {
        setStatsError(`HTTP ${res.status}`);
      }
    } catch (err) {
      setStatsError(err.name === 'TimeoutError' ? 'Timed out' : 'Offline');
    }
    setLoading(false);
  }, [module.status_endpoint]);

  const invokeTool = useCallback(async (tool) => {
    if (tool.needsInput && !toolInput.trim()) return;
    setToolLoading(true);
    setToolResult(null);

    try {
      const res = await fetch(`${API}/api/mcp/${module.id}/invoke`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tool: tool.id, input: toolInput }),
        signal: AbortSignal.timeout(10000),
      });
      const data = await res.json();
      setToolResult({ data, error: null });
    } catch (err) {
      setToolResult({ data: null, error: err.message });
    }
    setToolLoading(false);
  }, [module.id, toolInput]);

  useEffect(() => {
    refreshStats();
  }, [refreshStats]);

  // Status indicator
  const statusLabel = statsError ? (statsError === 'Offline' ? 'offline' : 'error')
    : stats?.status || 'unknown';
  const statusColor = statusLabel === 'active' ? 'var(--amber)'
    : statusLabel === 'error' ? 'var(--red, #e74c3c)'
    : statusLabel === 'offline' ? 'var(--text-muted)'
    : 'var(--text-muted)';

  return (
    <div className="module-renderer">
      {/* Header */}
      <div className="module-renderer-header">
        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          <span style={{ fontSize: '1.5rem' }}>{module.icon}</span>
          <div>
            <div style={{ fontWeight: 700, fontSize: '1.1rem' }}>{module.name}</div>
            <div className="text-muted" style={{ fontSize: '0.8rem', fontFamily: 'var(--font-mono)' }}>
              {module.description}
            </div>
          </div>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <span style={{
            display: 'inline-block',
            width: 8, height: 8,
            borderRadius: '50%',
            background: statusColor,
            boxShadow: statusLabel === 'active' ? `0 0 6px ${statusColor}` : 'none',
          }} />
          <span className="text-muted" style={{ fontSize: '0.75rem', fontFamily: 'var(--font-mono)' }}>
            {statusLabel}
          </span>
          {statsError && statusLabel === 'error' && (
            <span style={{ fontSize: '0.65rem', color: 'var(--red, #e74c3c)', fontFamily: 'var(--font-mono)' }}>
              ({statsError})
            </span>
          )}
          <button onClick={refreshStats} className="btn-icon" title="Refresh">
            {loading ? 'â³' : 'â†»'}
          </button>
          <button onClick={onClose} className="btn-icon" title="Close">âœ•</button>
        </div>
      </div>

      {/* Stats Grid */}
      {stats && module.display_fields && statusLabel === 'active' && (
        <div className="module-stats-grid">
          {module.display_fields.map((field) => {
            const value = stats[field.key];
            return (
              <div key={field.key} className="module-stat-cell">
                <div className="text-muted" style={{ fontSize: '0.7rem', marginBottom: 4 }}>
                  {field.icon} {field.label}
                </div>
                <div style={{ color: 'var(--amber)', fontWeight: 700, fontSize: '1.1rem', fontFamily: 'var(--font-mono)' }}>
                  {value !== undefined ? String(value) : 'â€”'}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Offline/Error state */}
      {statusLabel === 'offline' && (
        <div className="module-status-banner offline">
          âš« Offline â€” server not responding. Check Python path and sidecar.
        </div>
      )}
      {statusLabel === 'error' && (
        <div className="module-status-banner error">
          ğŸ”´ Error â€” server returned: {statsError}
        </div>
      )}

      {/* Raw Stats (collapsible) */}
      {stats && <RawStats data={stats} />}

      {/* Tools */}
      {tools.length > 0 && (
        <div className="module-tools-section">
          <div className="text-muted" style={{ fontSize: '0.75rem', fontFamily: 'var(--font-mono)', marginBottom: 8 }}>
            TOOLS
          </div>
          <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap' }}>
            {tools.map((tool) => (
              <button
                key={tool.id}
                className={`module-tool-btn ${activeTool?.id === tool.id ? 'active' : ''}`}
                onClick={() => {
                  if (activeTool?.id === tool.id) {
                    setActiveTool(null);
                    setToolResult(null);
                    setToolLoading(false);
                  } else {
                    setActiveTool(tool);
                    setToolInput('');
                    setToolResult(null);
                    setToolLoading(false);
                    // Auto-fire no-input tools
                    if (!tool.needsInput) {
                      // Defer so state is clean before invocation
                      setTimeout(() => {
                        setToolLoading(true);
                        fetch(`${API}/api/mcp/${module.id}/invoke`, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ tool: tool.id, input: '' }),
                          signal: AbortSignal.timeout(10000),
                        })
                          .then(r => r.json())
                          .then(data => setToolResult({ data, error: null }))
                          .catch(err => setToolResult({ data: null, error: err.message }))
                          .finally(() => setToolLoading(false));
                      }, 0);
                    }
                  }
                }}
              >
                {tool.icon} {tool.label}
              </button>
            ))}
          </div>

          {/* Tool Input */}
          {activeTool?.needsInput && (
            <div style={{ marginTop: 10 }}>
              <div className="text-muted" style={{ fontSize: '0.7rem', marginBottom: 4 }}>
                {activeTool.inputLabel}
              </div>
              <div style={{ display: 'flex', gap: 6 }}>
                <input
                  type="text"
                  value={toolInput}
                  onChange={(e) => setToolInput(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && invokeTool(activeTool)}
                  className="module-tool-input"
                  placeholder="..."
                  autoFocus
                />
                <button
                  onClick={() => invokeTool(activeTool)}
                  className="module-tool-btn active"
                  disabled={!toolInput.trim() || toolLoading}
                >
                  {toolLoading ? 'â³' : 'â–¶'}
                </button>
              </div>
            </div>
          )}

          {/* Loading indicator for no-input tools */}
          {toolLoading && !activeTool?.needsInput && (
            <div className="module-tool-result" style={{ color: 'var(--amber)' }}>
              â³ Running {activeTool?.label}...
            </div>
          )}

          {/* Tool Result */}
          {toolResult && !toolLoading && (
            <div className="module-tool-result">
              {toolResult.error ? (
                <span style={{ color: 'var(--red, #e74c3c)' }}>Error: {toolResult.error}</span>
              ) : (
                <pre style={{ margin: 0, whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>
                  {JSON.stringify(toolResult.data, null, 2)}
                </pre>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

function RawStats({ data }) {
  const [expanded, setExpanded] = useState(false);

  return (
    <div style={{ marginTop: 8 }}>
      <button
        onClick={() => setExpanded(!expanded)}
        className="text-muted"
        style={{
          background: 'none', border: 'none', cursor: 'pointer',
          fontSize: '0.7rem', fontFamily: 'var(--font-mono)', padding: 0,
          color: 'var(--text-muted)',
        }}
      >
        {expanded ? 'â–¾' : 'â–¸'} Raw JSON
      </button>
      {expanded && (
        <pre className="module-tool-result" style={{ marginTop: 4 }}>
          {JSON.stringify(data, null, 2)}
        </pre>
      )}
    </div>
  );
}
</file>

<file path="panel/src/components/SystemStatus.jsx">
// System Status â€” Module cards with toggle activation
import { useModules } from '../hooks/useModules';

export default function SystemStatus() {
  const { modules, loading, refresh, toggleModule } = useModules();

  if (loading) {
    return (
      <div className="placeholder">
        <div className="placeholder-text" style={{ fontFamily: 'var(--font-mono)' }}>
          Loading modules...
        </div>
      </div>
    );
  }

  if (modules.length === 0) {
    return (
      <div className="placeholder">
        <div className="placeholder-icon">âš™ï¸</div>
        <div className="placeholder-text">No modules found</div>
        <div className="placeholder-sub">
          Add .json configs to panel/modules/
        </div>
      </div>
    );
  }

  return (
    <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
      <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 4 }}>
        <button
          onClick={refresh}
          style={{
            padding: '4px 12px',
            background: 'var(--bg-elevated)',
            border: '1px solid var(--border)',
            borderRadius: 'var(--radius-sm)',
            color: 'var(--text-muted)',
            fontFamily: 'var(--font-mono)',
            fontSize: '0.75rem',
            cursor: 'pointer',
          }}
        >
          â†» Refresh
        </button>
      </div>
      <div className="card-grid">
        {modules.map((mod) => (
          <ModuleCard key={mod.id} module={mod} onToggle={() => toggleModule(mod.id)} />
        ))}
      </div>
    </div>
  );
}

function ModuleCard({ module, onToggle }) {
  const isEnabled = module.enabled;
  const isLive = module.status === 'active';

  return (
    <div className="card" style={{
      borderLeft: isEnabled
        ? (isLive ? '3px solid var(--amber)' : '3px solid var(--teal)')
        : '3px solid var(--border)',
      opacity: isEnabled ? 1 : 0.6,
      transition: 'opacity 0.2s, border-color 0.2s',
    }}>
      {/* Header */}
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <span style={{ fontSize: '1.3rem' }}>{module.icon}</span>
          <span style={{ fontWeight: 600, fontSize: '1rem' }}>{module.name}</span>
        </div>
        <ToggleSwitch enabled={isEnabled} live={isLive} onToggle={onToggle} />
      </div>

      {/* Description */}
      <div className="text-secondary" style={{ fontSize: '0.8rem', fontFamily: 'var(--font-mono)', marginBottom: 10 }}>
        {module.description}
      </div>

      {/* Data fields â€” only when enabled AND live */}
      {isEnabled && isLive && module.data && module.display_fields ? (
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: 6,
          padding: '8px 0',
          borderTop: '1px solid var(--border)',
        }}>
          {module.display_fields.map((field) => {
            const value = module.data[field.key];
            return (
              <div key={field.key} style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                fontFamily: 'var(--font-mono)',
                fontSize: '0.8rem',
              }}>
                <span className="text-muted">
                  {field.icon} {field.label}
                </span>
                <span style={{ color: 'var(--amber)', fontWeight: 600 }}>
                  {value !== undefined ? String(value) : 'â€”'}
                </span>
              </div>
            );
          })}
        </div>
      ) : (
        <div className="text-muted" style={{
          fontSize: '0.75rem',
          marginTop: 8,
          fontFamily: 'var(--font-mono)',
          paddingTop: 8,
          borderTop: '1px solid var(--border)',
        }}>
          {!isEnabled ? 'Disabled â€” click toggle to enable'
            : isLive ? 'Connected â€” no data fields configured'
            : 'Enabled â€” waiting for MCP server'}
        </div>
      )}
    </div>
  );
}

function ToggleSwitch({ enabled, live, onToggle }) {
  const bgColor = enabled
    ? (live ? 'var(--amber)' : 'var(--teal)')
    : 'var(--bg-elevated)';

  return (
    <button
      onClick={onToggle}
      title={enabled ? 'Click to disable' : 'Click to enable'}
      style={{
        position: 'relative',
        width: 44,
        height: 24,
        borderRadius: 12,
        border: `1px solid ${enabled ? 'transparent' : 'var(--border)'}`,
        background: bgColor,
        cursor: 'pointer',
        transition: 'background 0.2s, border-color 0.2s',
        padding: 0,
        flexShrink: 0,
      }}
    >
      <span style={{
        position: 'absolute',
        top: 3,
        left: enabled ? 22 : 3,
        width: 16,
        height: 16,
        borderRadius: '50%',
        background: enabled ? '#fff' : 'var(--text-muted)',
        transition: 'left 0.2s',
        boxShadow: '0 1px 3px rgba(0,0,0,0.3)',
      }} />
    </button>
  );
}
</file>

<file path="panel/src/hooks/useDoctrine.js">
// src/hooks/useDoctrine.js
// Fetches entity list and individual files from Express sidecar on :3000

import { useState, useEffect, useCallback } from 'react';

export function useEntities() {
  const [entities, setEntities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const refresh = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const res = await fetch('/api/doctrine');
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const data = await res.json();
      setEntities(data.entities || []);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => { refresh(); }, [refresh]);

  return { entities, loading, error, refresh };
}

export function useEntityFiles(entityName) {
  const [files, setFiles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (!entityName) { setFiles([]); return; }
    let cancelled = false;
    setLoading(true);
    setError(null);
    fetch(`/api/doctrine/${encodeURIComponent(entityName)}`)
      .then(res => {
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        return res.json();
      })
      .then(data => { if (!cancelled) setFiles(data.files || []); })
      .catch(err => { if (!cancelled) setError(err.message); })
      .finally(() => { if (!cancelled) setLoading(false); });
    return () => { cancelled = true; };
  }, [entityName]);

  return { files, loading, error };
}

export function useFileContent(entityName, fileName) {
  const [content, setContent] = useState(null);
  const [meta, setMeta] = useState(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (!entityName || !fileName) { setContent(null); setMeta(null); return; }
    let cancelled = false;
    setLoading(true);
    fetch(`/api/doctrine/${encodeURIComponent(entityName)}/${encodeURIComponent(fileName)}`)
      .then(res => {
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        return res.json();
      })
      .then(data => {
        if (!cancelled) {
          setContent(data.content);
          setMeta({ type: data.type, file: data.file, entity: data.entity });
        }
      })
      .finally(() => { if (!cancelled) setLoading(false); });
    return () => { cancelled = true; };
  }, [entityName, fileName]);

  return { content, meta, loading };
}
</file>

<file path="panel/src/hooks/useMCP.js">
// useMCP â€” Direct MCP tool invocation from panel components
// Session 4: Connects panel UI to real QAIS/ISS/EAP/Limbic servers
// S81 fix: useCallback wrapping functions, not object literals
import { useState, useCallback } from 'react';

const API = 'http://localhost:3000';

export function useMCP() {
  const [loading, setLoading] = useState(false);
  const [lastResult, setLastResult] = useState(null);
  const [lastError, setLastError] = useState(null);

  const invoke = useCallback(async (system, tool, input = '') => {
    setLoading(true);
    setLastError(null);
    setLastResult(null);

    try {
      const res = await fetch(`${API}/api/mcp/${system}/invoke`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tool, input }),
        signal: AbortSignal.timeout(15000),
      });

      const data = await res.json();

      if (data.error) {
        setLastError(data.error);
        return { error: data.error };
      }

      setLastResult(data);
      return { data };
    } catch (err) {
      const msg = err.name === 'TimeoutError' ? 'Request timed out' : err.message;
      setLastError(msg);
      return { error: msg };
    } finally {
      setLoading(false);
    }
  }, []);

  // Convenience wrappers â€” proper functions
  const qaisStats = useCallback(() => invoke('qais', 'stats'), [invoke]);
  const qaisExists = useCallback((identity) => invoke('qais', 'exists', identity), [invoke]);
  const qaisResonate = useCallback((identity, role, candidates) =>
    invoke('qais', 'resonate', `${identity}|${role}|${candidates.join(',')}`), [invoke]);

  const issAnalyze = useCallback((text) => invoke('iss', 'analyze', text), [invoke]);
  const issCompare = useCallback((texts) => invoke('iss', 'compare', texts.join('\n')), [invoke]);
  const issStatus = useCallback(() => invoke('iss', 'status'), [invoke]);

  return {
    invoke,
    loading,
    lastResult,
    lastError,
    qais: { stats: qaisStats, exists: qaisExists, resonate: qaisResonate },
    iss: { analyze: issAnalyze, compare: issCompare, status: issStatus },
  };
}
</file>

<file path="panel/src/hooks/useModules.js">
// useModules â€” Fetch module configs, toggle enable/disable, poll live status
import { useState, useEffect, useCallback } from 'react';

const API = 'http://localhost:3000';
const STORAGE_KEY = 'bond_modules_enabled';

function loadEnabled() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
  catch { return {}; }
}

function saveEnabled(map) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(map));
}

export function useModules() {
  const [modules, setModules] = useState([]);
  const [enabledMap, setEnabledMap] = useState(loadEnabled);
  const [loading, setLoading] = useState(true);

  const fetchModules = useCallback(async () => {
    try {
      const res = await fetch(`${API}/api/modules`);
      const data = await res.json();

      const withStatus = await Promise.all(
        data.modules.map(async (mod) => {
          const enabled = enabledMap[mod.id] !== false; // default ON
          let status = 'offline';
          let liveData = null;

          if (enabled) {
            try {
              const statusRes = await fetch(`${API}${mod.status_endpoint}`, {
                signal: AbortSignal.timeout(2000),
              });
              if (statusRes.ok) {
                liveData = await statusRes.json();
                status = 'active';
              }
            } catch { /* offline */ }
          }

          return { ...mod, enabled, status, data: liveData };
        })
      );

      setModules(withStatus);
    } catch {
      setModules([]);
    } finally {
      setLoading(false);
    }
  }, [enabledMap]);

  const toggleModule = useCallback((id) => {
    setEnabledMap(prev => {
      const current = prev[id] !== false;
      const next = { ...prev, [id]: !current };
      saveEnabled(next);
      return next;
    });
  }, []);

  useEffect(() => {
    fetchModules();
    const interval = setInterval(fetchModules, 30000);
    return () => clearInterval(interval);
  }, [fetchModules]);

  return { modules, loading, refresh: fetchModules, toggleModule };
}
</file>

<file path="panel/src/main.jsx">
import { StrictMode } from 'react';
import { createRoot } from 'react-dom/client';
import App from './App';

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>
);
</file>

<file path="panel/src/styles/bond.css">
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOND Control Panel â€” Dark Theme
   Aesthetic: Control room. Information-dense. Professional.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --bg-deep:     #0d1117;
  --bg-surface:  #161b22;
  --bg-elevated: #1c2333;
  --bg-hover:    #21283b;
  --border:      #30363d;
  --border-focus:#58a6ff;

  --text-primary:   #e6edf3;
  --text-secondary: #8b949e;
  --text-muted:     #484f58;

  --accent:         #e94560;
  --accent-dim:     #e9456044;
  --amber:          #f0883e;
  --amber-dim:      #f0883e33;
  --accent-amber:   #d19a66;
  --teal:           #56d4dd;
  --teal-dim:       #56d4dd33;

  --status-active:  #3fb950;
  --status-suspend: #e94560;
  --status-locked:  #d29922;
  --status-off:     #484f58;

  --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
  --font-ui:   -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
}

html, body, #root {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: var(--font-ui);
  background: var(--bg-deep);
  color: var(--text-primary);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€â”€ Layout Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-shell {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

.app-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
}

/* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-logo {
  font-size: 1.3rem;
  letter-spacing: -0.5px;
}

.header-label {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: 0.5px;
}

.header-status {
  display: flex;
  align-items: center;
  gap: 16px;
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.status-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.status-label {
  color: var(--text-muted);
}

.status-value {
  color: var(--text-secondary);
}

.status-value.active {
  color: var(--status-active);
}

.status-value.suspended {
  color: var(--status-suspend);
}

.status-value.locked {
  color: var(--status-locked);
}

.status-sep {
  color: var(--text-muted);
  user-select: none;
}

/* â”€â”€â”€ Tab Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-bar {
  display: flex;
  gap: 0;
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  padding: 0 20px;
}

.tab-btn {
  padding: 10px 20px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-secondary);
  font-family: var(--font-ui);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  letter-spacing: 0.3px;
}

.tab-btn:hover {
  color: var(--text-primary);
  background: var(--bg-hover);
}

.tab-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

/* â”€â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 16px;
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.card:hover {
  border-color: var(--border-focus);
  box-shadow: 0 0 0 1px var(--border-focus), 0 4px 12px rgba(0, 0, 0, 0.3);
}

.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
}

/* â”€â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.badge-active {
  background: rgba(63, 185, 80, 0.15);
  color: var(--status-active);
  border: 1px solid rgba(63, 185, 80, 0.3);
}

.badge-suspended {
  background: rgba(233, 69, 96, 0.15);
  color: var(--status-suspend);
  border: 1px solid rgba(233, 69, 96, 0.3);
}

.badge-locked {
  background: rgba(210, 153, 34, 0.15);
  color: var(--status-locked);
  border: 1px solid rgba(210, 153, 34, 0.3);
}

.badge-pp {
  background: rgba(88, 166, 255, 0.15);
  color: #58a6ff;
  border: 1px solid rgba(88, 166, 255, 0.3);
}

.badge-pm {
  background: var(--accent-dim);
  color: var(--accent);
  border: 1px solid rgba(233, 69, 96, 0.3);
}

.badge-dc {
  background: rgba(210, 153, 34, 0.15);
  color: #d29922;
  border: 1px solid rgba(210, 153, 34, 0.3);
}

.badge-pc {
  background: rgba(209, 154, 102, 0.15);
  color: var(--accent-amber);
  border: 1px solid rgba(209, 154, 102, 0.3);
}

.badge-lb {
  background: rgba(139, 148, 158, 0.15);
  color: var(--text-secondary);
  border: 1px solid rgba(139, 148, 158, 0.3);
}

.badge-core {
  background: rgba(210, 153, 34, 0.15);
  color: #d29922;
  border: 1px solid rgba(210, 153, 34, 0.3);
  font-size: 0.65rem;
}

/* â”€â”€â”€ Command Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.command-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  background: var(--bg-surface);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.cmd-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  font-family: var(--font-mono);
  font-size: 0.78rem;
  cursor: pointer;
  transition: all 0.15s ease;
  user-select: none;
  position: relative;
  overflow: hidden;
}

.cmd-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
  border-color: var(--border-focus);
}

.cmd-btn:active {
  transform: scale(0.97);
}

.cmd-btn .cmd-icon {
  font-size: 0.9rem;
}

.cmd-btn.sent {
  border-color: var(--status-active);
  color: var(--status-active);
}

.cmd-btn.sent::after {
  content: 'âœ“';
  position: absolute;
  right: 8px;
  font-size: 0.7rem;
}

/* â”€â”€â”€ Placeholder content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  min-height: 300px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 0.85rem;
  gap: 8px;
}

.placeholder-icon {
  font-size: 2rem;
  opacity: 0.5;
}

.placeholder-text {
  opacity: 0.7;
}

.placeholder-sub {
  font-size: 0.7rem;
  opacity: 0.4;
}

/* â”€â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-deep);
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* â”€â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mono {
  font-family: var(--font-mono);
}

.text-muted {
  color: var(--text-muted);
}

.text-secondary {
  color: var(--text-secondary);
}

.gap-sm { gap: 4px; }
.gap-md { gap: 8px; }
.gap-lg { gap: 16px; }

/* â”€â”€â”€ Create Entity Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.create-entity-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.create-entity-modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px 24px;
  width: 360px;
  max-width: 90vw;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.btn-create-entity {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 4px 10px;
  font-size: 0.7rem;
  font-family: var(--font-mono);
  background: transparent;
  border: 1px dashed var(--border);
  border-radius: 4px;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s ease;
}

.btn-create-entity:hover {
  border-color: var(--accent-amber);
  color: var(--accent-amber);
  background: rgba(209, 154, 102, 0.08);
}

/* â”€â”€â”€ Modal (CreateEntity) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  backdrop-filter: blur(2px);
}

.modal-content {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  width: 380px;
  max-width: 90vw;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 8px;
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1rem;
  cursor: pointer;
  padding: 4px;
}

.modal-close:hover {
  color: var(--text-primary);
}

.modal-desc {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-bottom: 16px;
}

.modal-label {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.modal-input {
  padding: 8px 12px;
  background: var(--bg-deep);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 0.85rem;
  outline: none;
  transition: border-color 0.15s ease;
}

.modal-input:focus {
  border-color: var(--border-focus);
}

.modal-input:disabled {
  opacity: 0.5;
}

.modal-hint {
  color: var(--text-muted);
  font-size: 0.7rem;
  margin-top: 6px;
}

.modal-error {
  color: var(--accent);
  font-size: 0.78rem;
  margin-top: 8px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 20px;
}

.btn-cancel {
  padding: 6px 14px;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  font-family: var(--font-mono);
  font-size: 0.78rem;
  cursor: pointer;
}

.btn-cancel:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.btn-confirm {
  padding: 6px 14px;
  background: var(--accent-dim);
  border: 1px solid var(--accent);
  border-radius: var(--radius-sm);
  color: var(--accent);
  font-family: var(--font-mono);
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
}

.btn-confirm:hover:not(:disabled) {
  background: var(--accent);
  color: var(--bg-deep);
}

.btn-confirm:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* â”€â”€â”€ Module Bay (S3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

.module-bay-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
}

.module-bay-card {
  padding: 12px !important;
  transition: all 0.2s ease;
}

.module-bay-card:hover {
  border-color: var(--teal) !important;
  background: var(--bg-elevated);
}

.module-bay-card.expanded {
  border-color: var(--amber) !important;
  background: var(--bg-elevated);
}

.btn-icon {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 0.75rem;
  padding: 4px 10px;
  cursor: pointer;
  transition: color 0.15s;
}

.btn-icon:hover {
  color: var(--text-primary);
  border-color: var(--teal);
}

/* â”€â”€â”€ Module Renderer (S3/S4) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

.module-renderer {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-top: 4px;
}

.module-renderer-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

.module-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 8px;
  margin-bottom: 10px;
}

.module-stat-cell {
  background: var(--bg-deep);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px;
  text-align: center;
}

.module-tools-section {
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
}

.module-tool-btn {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  font-family: var(--font-mono);
  font-size: 0.75rem;
  padding: 5px 12px;
  cursor: pointer;
  transition: all 0.15s;
}

.module-tool-btn:hover {
  border-color: var(--teal);
  color: var(--text-primary);
}

.module-tool-btn.active {
  border-color: var(--amber);
  color: var(--amber);
  background: rgba(217, 172, 95, 0.08);
}

.module-tool-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.module-tool-input {
  flex: 1;
  background: var(--bg-deep);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 0.8rem;
  padding: 6px 10px;
  outline: none;
}

.module-tool-input:focus {
  border-color: var(--teal);
}

.module-tool-result {
  background: var(--bg-deep);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px;
  margin-top: 8px;
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-secondary);
  max-height: 300px;
  overflow-y: auto;
}

.module-status-banner {
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: 0.78rem;
  margin-bottom: 10px;
}

.module-status-banner.offline {
  background: rgba(128, 128, 128, 0.08);
  border: 1px solid rgba(128, 128, 128, 0.25);
  color: var(--text-muted);
}

.module-status-banner.error {
  background: rgba(231, 76, 60, 0.08);
  border: 1px solid rgba(231, 76, 60, 0.25);
  color: var(--red, #e74c3c);
}
</file>

<file path="panel/start_panel.bat">
@echo off
:: BOND Panel â€” Unified Startup
:: Starts the Express sidecar (serves API + built panel if dist/ exists)
:: Run from BOND_private\panel\ or set BOND_PANEL_PATH

cd /d "%~dp0"

:: Load .env if present
if exist .env (
  for /f "usebackq tokens=1,2 delims==" %%a in (".env") do (
    if not "%%a"=="" if not "%%a:~0,1%"=="#" set "%%a=%%b"
  )
)

echo ğŸ”¥ğŸŒŠ Starting BOND Panel...
echo    Working dir: %cd%

:: Check node_modules
if not exist node_modules (
  echo    Installing dependencies...
  npm install
)

:: Start sidecar
node server.js
</file>

<file path="panel/vite.config.js">
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      '/api/doctrine': 'http://localhost:3000',
      '/api/config': 'http://localhost:3000',
      '/api/mcp': 'http://localhost:3000',
      '/api/modules': 'http://localhost:3000',
      '/api/state': 'http://localhost:3000'
    }
  }
});
</file>

<file path="skills/bond/SKILL.md">
---
name: bond
description: >-
  BOND protocol. Triggers: Sync, Save, Crystal, Chunk, Tick, Enter, Exit,
  Full Restore, Drift, counter, emoji, bonfire, drift, session, entity,
  doctrine, perspective, project class, library class, save protocol,
  sync limit, compaction, context degradation.
---

# BOND v1.0 â€” Directives

## COUNTER
Echo user's tag exactly. Do NOT compute emoji.
First line of every response. No exceptions.
Resets: {Sync}, {Full Restore}, new conversation.
No reset: {Save}, {Chunk}, bonfire, task completion, compaction.
Lost count: recommend {Sync}.

## SYNC
{Sync}: 1) Read project SKILL 2) Read OPS/MASTER 3) Read state/active_entity.json â€” if entity set, read all files at path field; if null, skip 4) Reset counter.
{Full Restore}: {Sync} + full depth read.

## COMMANDS
{Sync} read+ground+reset | {Full Restore} complete reload+reset | {Save} write proven work (both agree) | {Crystal} QAIS crystallization | {Chunk} session snapshot | {Tick} quick status | {Enter ENTITY} read state/active_entity.json, load all .md files from path, acknowledge entity+class, apply tool boundaries | {Exit} clear active entity, confirm exit, drop tool boundaries | {Relational} arch re-anchor | {Drift?} self-check

## ENTITIES (Four-Class Architecture)
Doctrine: static IS, Files+ISS, no growth. Project: bounded, Files+QAIS+Heatmap+Crystal+ISS, carries CORE. Perspective: unbounded growth, Files+QAIS+Heatmap+Crystal, no ISS. Library: reference, Files only.
Pointer: state/active_entity.json. Panel writes Enter, clears Exit. {Sync} follows pointer. Switch overwrites â€” no drop needed. Class boundaries hard.

## SAVE
Both agree before writing. Proof required (screenshot/test/confirmation). Bug to Fix link: Symptom + Fix + Link.

## TRUTH
L0 SKILL (identity) then L1 OPS/MASTER (state) then L2 Code (SOURCE OF TRUTH). Higher overrides lower. Code > prose.

## DRIFT
Types: identity, architectural, terminology, state. Recovery: mantra then {Sync} then {Full Restore}.

## PRINCIPLES
Identify=Execute (fix now, do not ask). Code>Prose. Both Agree on {Save}.

## MEMORY
Keep: project name, user name, counter echo rule, key paths, 2-3 axioms. Do not keep: history (OPS), mantras (SKILL), architecture (docs), math (tools).
</file>

<file path="Counter/BOND_counter_v6.ahk">
; ============================================
; BOND Turn Counter v6 for AutoHotkey v2
; User-side turn tracking for Claude conversations
; ============================================
;
; TAG FORMAT: Â«tN/LIMIT emojiÂ»
; Examples: Â«t3/10 ğŸ—’ï¸Â»  Â«t12/10 ğŸŸ¡Â»  Â«t15/10 ğŸŸ Â»  Â«t20/10 ğŸ”´Â»
;
; COLOR SCHEME:
; ğŸ—’ï¸ = N â‰¤ LIMIT (green/normal)
; ğŸŸ¡ = N > LIMIT (yellow - over limit)
; ğŸŸ  = N â‰¥ 15 (orange - getting long)
; ğŸ”´ = N â‰¥ 20 (red - very long)
;
; HOTKEYS:
; Enter          = Tag message + send (when BOND ON + Claude active)
; XButton2       = Insert ğŸ§  limbic trigger (when BOND ON + Claude active)
; XButton1       = Blocked (prevents back-nav in Claude)
; Ctrl+Shift+B   = Toggle BOND ON/OFF
; Ctrl+Shift+R   = Manual reset to 0
; Ctrl+Shift+T   = Show current N
;
; INSTALLATION:
; 1. Install AutoHotkey v2: https://www.autohotkey.com/
; 2. Save this file anywhere
; 3. Double-click to run
;
; ============================================

#Requires AutoHotkey v2.0
#SingleInstance Force

; --- CONFIGURATION ---
global LIMIT := 10  ; Change this to your preferred limit

global CounterFile := A_AppData . "\BOND\turn_counter.txt"
global TurnN := 0
global BondActive := true
global ResetPending := false

InitCounter()

InitCounter() {
    global TurnN, CounterFile
    SplitPath(CounterFile, , &dir)
    if !DirExist(dir)
        DirCreate(dir)
    if FileExist(CounterFile) {
        try {
            TurnN := Integer(FileRead(CounterFile))
        } catch {
            TurnN := 0
        }
    }
    UpdateTray()
}

GetEmoji() {
    global TurnN, LIMIT
    if (TurnN >= 20)
        return "ğŸ”´"
    if (TurnN >= 15)
        return "ğŸŸ "
    if (TurnN > LIMIT)
        return "ğŸŸ¡"
    return "ğŸ—’ï¸"
}

UpdateTray() {
    global TurnN, BondActive, LIMIT
    emoji := GetEmoji()
    if BondActive {
        TraySetIcon("shell32.dll", 278)
        A_IconTip := "BOND ON | " . emoji . " " . TurnN . "/" . LIMIT
    } else {
        TraySetIcon("shell32.dll", 132)
        A_IconTip := "BOND OFF | " . emoji . " " . TurnN . "/" . LIMIT
    }
    A_TrayMenu.Delete()
    A_TrayMenu.Add(BondActive ? "â— BOND ON" : "â—‹ BOND OFF", (*) => ToggleBond())
    A_TrayMenu.Add()
    A_TrayMenu.Add(emoji . " " . TurnN . "/" . LIMIT, (*) => "")
    A_TrayMenu.Disable(emoji . " " . TurnN . "/" . LIMIT)
    A_TrayMenu.Add()
    A_TrayMenu.Add("Set Counter...", (*) => SetCounter())
    A_TrayMenu.Add("Reset to 0", (*) => ResetCounter())
    A_TrayMenu.Add()
    A_TrayMenu.Add("Exit", (*) => ExitApp())
}

SaveCounter() {
    global TurnN, CounterFile
    try FileDelete(CounterFile)
    try FileAppend(String(TurnN), CounterFile)
    UpdateTray()
}

ResetCounter() {
    global TurnN
    TurnN := 0
    SaveCounter()
    ToolTip("BOND Reset: N = 0")
    SetTimer(() => ToolTip(), -2000)
}

SetCounter() {
    global TurnN
    ib := InputBox("Set turn counter:", "BOND Counter", "w200 h100", TurnN)
    if (ib.Result = "OK") {
        try {
            TurnN := Integer(ib.Value)
            SaveCounter()
            ToolTip("Counter set to " . TurnN)
            SetTimer(() => ToolTip(), -2000)
        }
    }
}

ToggleBond() {
    global BondActive
    BondActive := !BondActive
    UpdateTray()
    ToolTip("BOND " . (BondActive ? "ON" : "OFF"))
    SetTimer(() => ToolTip(), -2000)
}

IsClaudeActive() {
    exe := ""
    try exe := WinGetProcessName("A")
    
    ; Claude Desktop - exact exe name
    if (exe = "Claude.exe" || exe = "claude.exe")
        return true
    
    ; Browser - must be browser AND title contains claude.ai
    if (exe = "chrome.exe" || exe = "msedge.exe" || exe = "firefox.exe") {
        title := WinGetTitle("A")
        if InStr(title, "claude.ai")
            return true
    }
    
    return false
}

FlagReset() {
    global ResetPending
    ResetPending := true
    ToolTip("Reset flagged - next send will be Â«t1Â»")
    SetTimer(() => ToolTip(), -1500)
}

InjectTagAndSend() {
    global TurnN, ResetPending, LIMIT
    
    if ResetPending {
        TurnN := 0
        ResetPending := false
    }
    
    TurnN++
    SaveCounter()
    
    emoji := GetEmoji()
    tag := " Â«t" . TurnN . "/" . LIMIT . " " . emoji . "Â»"
    
    Send("{End}")
    Sleep(30)
    SendText(tag)
    Sleep(30)
    Send("{Enter}")
    
    ToolTip(emoji . " " . TurnN . "/" . LIMIT)
    SetTimer(() => ToolTip(), -1000)
}

; --- Global Hotkeys ---
^+b:: ToggleBond()
^+r:: ResetCounter()
^+t:: {
    global TurnN, BondActive, LIMIT
    emoji := GetEmoji()
    ToolTip("BOND " . (BondActive ? "ON" : "OFF") . " | " . emoji . " " . TurnN . "/" . LIMIT)
    SetTimer(() => ToolTip(), -2000)
}

; --- Hotstrings: detect {Sync} and {Full Restore} as typed ---
:*:{Sync}::{
    FlagReset()
    SendText("{Sync}")
}

:*:{Full Restore}::{
    FlagReset()
    SendText("{Full Restore}")
}

; --- Claude-only: Enter tags and sends ---
#HotIf IsClaudeActive() && BondActive
Enter:: InjectTagAndSend()
XButton2:: {                  ; Forward thumb = limbic trigger
    SendText("ğŸ§ ")
    ToolTip("ğŸ§  Limbic")
    SetTimer(() => ToolTip(), -1000)
}
XButton1:: return             ; Back thumb = blocked (prevents nav)
#HotIf
</file>

<file path="Counter/counter_README.md">
# BOND Turn Counter

**User-side turn tracking for reliable Claude conversations.**

## The Problem

Claude's internal counter can fail due to:
- Tool chain context displacement
- Compaction/memory issues  
- Pattern interference at limit boundaries

## The Solution

**You become the source of truth.**

This AutoHotkey script appends `Â«tN/LIMIT emojiÂ»` to your messages. Claude just reads the tag â€” no internal counting needed.

## Installation

### Step 1: Install AutoHotkey v2

Download from: **https://www.autohotkey.com/** (must be v2, not v1)

### Step 2: Run the Script

Double-click `BOND_counter_v6.ahk`. Look for tray icon.

### Step 3: (Optional) Auto-Start

Press `Win+R`, type `shell:startup`, create shortcut to the script.

## Hotkeys

| Hotkey | Action |
|--------|--------|
| **Enter** | Tag + send (when BOND ON) |
| **Ctrl+Shift+B** | Toggle ON/OFF |
| **Ctrl+Shift+R** | Reset to 0 |
| **Ctrl+Shift+T** | Show status |

## Tag Format

`Â«t5/10 ğŸ—’ï¸Â»` â€” Turn 5, limit 10, normal

## Color Scheme (computed by AHK, echoed by Claude)

| Emoji | Meaning |
|-------|---------|
| ğŸ—’ï¸ | N â‰¤ LIMIT |
| ğŸŸ¡ | N > LIMIT |
| ğŸŸ  | N â‰¥ 15 |
| ğŸ”´ | N â‰¥ 20 |

Claude does not compute these â€” Claude echoes the emoji from the user's tag.

## Auto-Reset

Type `{Sync}` or `{Full Restore}` â€” script detects and resets to 0.

## Compatibility

- âœ… Claude Desktop (Windows)
- âœ… claude.ai in Chrome/Edge/Firefox
- âŒ Mac (AHK is Windows-only)
- âŒ Mobile

## Configuration

Edit line 31 to change limit: `global LIMIT := 10`

---

*Session 70 â€” J-Dub & Claude*
</file>

<file path="Counter/B65_USER_SOURCE_OF_TRUTH.md">
# B65: User Source of Truth

**Session:** 70
**Date:** 2026-02-01

## Problem
Claude's internal counter failed (S70a/b/c) because it lived in vulnerable working memory.

## Insight
**"User = source of truth. Claude just reads the tag."**

## Solution
AHK script appends `Â«tN/LIMIT emojiÂ»` to messages. Claude reads tag, displays it. Zero internal state.

## Key Properties
- Tag carries N, LIMIT, and emoji
- Even if Claude "forgets" â€” next message has correct N
- Auto-resets on `{Sync}` or `{Full Restore}`
- Claude echoes the emoji â€” does NOT compute it independently (S81 refinement)

## Architecture Principle
When internal state is unreliable, externalize it to the message.

## S81 Refinement
Even with correct math rules in memory, Claude drifted on emoji computation.
Semantic pressure ("at the limit feels red") overrides math.
Fix: Remove math from Claude's memory entirely. AHK computes, Claude echoes.

Memory edit (current):
```
BOND Counter: Read user's Â«tN/L emojiÂ» tag. Echo THEIR emoji exactly.
Do not compute emoji independently. User display is source of truth.
```

ğŸ”¥ Counter failures are now architecturally impossible. ğŸ”¥
</file>

<file path="Counter/BOND_COUNTER_README.md">
# BOND Turn Counter

**User-side turn tracking for reliable Claude conversations.**

## The Problem

Claude's internal conversation counter drifts due to context displacement, compaction, and pattern interference. Auto-increment rules create conflicting instructions between memory edits, OPS files, and SKILL docs.

## The Solution

**You are the source of truth. Claude never counts.**

The AutoHotkey script:
1. Appends `Â«tN/LÂ»` to your messages automatically (N=count, L=limit)
2. Claude parses your tag â€” no internal tracking needed
3. Auto-resets when you type `{Sync}` or `{Full Restore}`
4. Emoji computed client-side and included in tag

Result: Counter failures become impossible. Claude just reads what you send.

---

## Tag Format

```
Â«tN/L emojiÂ»

N = your turn count (you increment, not Claude)
L = your session limit
emoji = computed by AHK script

Examples:
  Â«t1/10 ğŸ—’ï¸Â»    â†’ first turn, limit 10, normal
  Â«t5/10 ğŸ—’ï¸Â»    â†’ fifth turn, normal
  Â«t12/10 ğŸŸ¡Â»   â†’ over limit
  Â«t15/10 ğŸŸ¡ğŸŸ Â» â†’ over limit + getting long
```

---

## Installation

### Step 1: Install AutoHotkey v2

Download from: **https://www.autohotkey.com/**

- Click "Download v2.0" (must be v2, not v1)
- Run installer, accept defaults

### Step 2: Get the Script

Save `BOND_counter_v6.ahk` to a permanent location:
- `C:\Users\YourName\Documents\BOND\BOND_counter_v6.ahk`
- Or anywhere you prefer

### Step 3: Run

Double-click `BOND_counter_v6.ahk`

Look for tray icon (bottom-right, may need to click `^` to expand).

### Step 4: (Optional) Auto-Start with Windows

1. Press `Win+R`, type `shell:startup`, press Enter
2. Create shortcut to `BOND_counter_v6.ahk` in this folder
3. Script runs automatically on login

---

## Usage

### Hotkeys

| Hotkey | Action |
|--------|--------|
| **Enter** | Tag message + send (when BOND ON) |
| **Ctrl+Shift+B** | Toggle BOND ON/OFF |
| **Ctrl+Shift+R** | Manual reset to 0 |
| **Ctrl+Shift+T** | Show current N |
| **XButton2** | Insert ğŸ§  limbic trigger |

### Workflow

1. Open Claude (Desktop or browser)
2. Type your message
3. Press **Enter**
4. Script adds `Â«t1/10 ğŸ—’ï¸Â»` and sends
5. Continue â€” each Enter increments: `Â«t2/10 ğŸ—’ï¸Â»`, `Â«t3/10 ğŸ—’ï¸Â»`, etc.

### Auto-Reset

Type `{Sync}` or `{Full Restore}` in your message:
- Script detects it as you type
- Shows "Reset flagged" tooltip
- Next Enter sends as `Â«t1/LÂ»`

### Toggle OFF

Press **Ctrl+Shift+B** to toggle OFF.
- BOND OFF = Enter works normally (no tagging)
- BOND ON = Enter tags + sends

---

## How Claude Uses It

Claude's memory should include this rule:

```
BOND Counter: Read user's Â«tN/L emojiÂ» tag. Echo THEIR emoji exactly.
Do not compute emoji independently. User display is source of truth.
```

Claude reads your tag and echoes your emoji as-is:
- `Â«t5/10 ğŸ—’ï¸Â»` â†’ ğŸ—’ï¸ 5/10
- `Â«t12/10 ğŸŸ¡Â»` â†’ ğŸŸ¡ 12/10

No internal tracking. No emoji computation. AHK computes the correct emoji
client-side. Claude just reads and echoes. (Changed S81 â€” Claude repeatedly
drifted when given math rules to evaluate.)

---

## Tray Menu

Right-click the tray icon:
- **â— BOND ON / â—‹ BOND OFF** â€” Click to toggle
- **N = X** â€” Current count
- **Reset to 0** â€” Manual reset
- **Exit** â€” Close script

---

## Compatibility

| Platform | Works? |
|----------|--------|
| Claude Desktop (Windows) | âœ… |
| Claude.ai in Chrome/Edge/Firefox | âœ… |
| Claude Desktop (Mac) | âŒ (AHK is Windows-only) |
| Claude mobile app | âŒ |

For Mac users: Keyboard Maestro or Hammerspoon could replicate this functionality.

---

## Version History

- **v6** â€” Tag format `Â«tN/L emojiÂ»`, client-side emoji, XButton2 limbic trigger
- **v5** â€” Auto-reset on {Sync}/{Full Restore}, hotstring detection
- **v4** â€” Clipboard-based detection (deprecated)
- **v3** â€” Toggle ON/OFF
- **v2** â€” Enter key tagging
- **v1** â€” Ctrl+Enter tagging

---

## License

MIT â€” Part of the BOND project

---

*"User = source of truth. Claude just reads the tag. Never auto-increment."*
</file>

<file path="ISS/ISS_CONSTRAINTS.md">
# ISS Constraints & Future Directions
# Established: S73 (2026-02-02) by J-Dub
# Status: NON-NEGOTIABLE (constraints) / NAMED BUT NOT REQUIRED (futures)

---

## Constraints (Protect the Cleanliness)

1. **Do not add more axes casually** â€” G and P are proven. Don't bolt on a third axis without the same rigor.
2. **Do not overfit projection training** â€” 79 sentences, frozen forever. That's the point.
3. **Do not reintroduce vocab logic "just in case"** â€” JA/JA+ is dead. Gap = field imbalance, not vocabulary scan.
4. **Do not rush to operational complexity** â€” ISS is clean right now. Protect that.

---

## Legitimate Future Directions (when ready)

Named landscape â€” none required to call B66 done:

- **Temporal dynamics** â€” How G/P balance shifts across sequences
- **Multi-span composition** â€” How forces combine across paragraphs or docs
- **QAIS-side analytics** â€” Field-level imbalance trends over time
- **Cross-agent alignment** â€” Compare ISS fields between agents (spicy)

---

ğŸ”¥ğŸŒŠ J-Dub & Claude | BOND Protocol
</file>

<file path="ISS/iss_prototype.py">
"""
ISS â€” Invariant Semantic Substrate
Prototype Implementation

Tests the G/P/E/r/Gap framework on sample text.
Uses sentence-transformers if available, else QAIS-style deterministic vectors.

Author: J-Dub & Claude
Date: 2026-02-01
"""

import numpy as np
from typing import NamedTuple, List, Tuple
import hashlib

# =============================================================================
# EMBEDDING LAYER
# =============================================================================

try:
    from sentence_transformers import SentenceTransformer
    EMBED_MODEL = SentenceTransformer('all-MiniLM-L6-v2')
    EMBED_DIM = 384
    USE_TRANSFORMER = True
    print("[ISS] Using sentence-transformers (all-MiniLM-L6-v2)")
except ImportError:
    EMBED_MODEL = None
    EMBED_DIM = 512
    USE_TRANSFORMER = False
    print("[ISS] Fallback: QAIS-style deterministic vectors")


def embed_text(text: str) -> np.ndarray:
    """Embed text to vector space."""
    if USE_TRANSFORMER:
        return EMBED_MODEL.encode(text, normalize_embeddings=True)
    else:
        # QAIS-style: SHA512 -> seed -> bipolar vector
        h = hashlib.sha512(text.encode()).hexdigest()
        seed = int(h[:16], 16) % (2**32)
        rng = np.random.default_rng(seed)
        vec = rng.choice([-1.0, 1.0], size=EMBED_DIM)
        return vec / np.linalg.norm(vec)


# =============================================================================
# TRAINED PROJECTION MATRICES (Phase 2 complete)
# DO NOT MODIFY - trained on 38 G + 41 P sentences
# =============================================================================

PROJ_DIM = 64  # Projection space dimension

import os
_proj_path = os.path.join(os.path.dirname(__file__), 'iss_projections.npz')
if os.path.exists(_proj_path):
    _proj = np.load(_proj_path)
    P_G = _proj['P_G']  # Mechanistic projection
    P_P = _proj['P_P']  # Prescriptive projection
    print("[ISS] Loaded trained projections from iss_projections.npz")
else:
    # Fallback to random if file missing
    print("[ISS] WARNING: iss_projections.npz not found, using random projections")
    np.random.seed(42)
    P_G = np.random.randn(EMBED_DIM, PROJ_DIM) * 0.1
    np.random.seed(43)
    P_P = np.random.randn(EMBED_DIM, PROJ_DIM) * 0.1


# =============================================================================
# PHASE 1 HEURISTICS: DELETED (Phase 2 training complete)
# =============================================================================


# =============================================================================
# ISS CORE
# =============================================================================

class SemanticState(NamedTuple):
    """Canonical semantic state (g, p, E, r)"""
    g: np.ndarray       # Mechanistic projection
    p: np.ndarray       # Prescriptive projection
    E: float            # Emergent explanatory elevation
    r: np.ndarray       # Residual
    g_norm: float       # ||g||
    p_norm: float       # ||p||
    r_norm: float       # ||r||
    gap: float          # Gap pressure


def invariant_semantic_pass(text: str, 
                            alpha: float = 1.0,
                            beta: float = 1.0,
                            gamma: float = 1.0) -> SemanticState:
    """
    Core ISS computation.
    
    Args:
        text: Input text
        alpha: Weight for residual in gap
        beta: Weight for G-P imbalance in gap
        gamma: Weight for (1-E) in gap
    
    Returns:
        SemanticState with all projections
    """
    # 1. Embed
    x = embed_text(text)
    
    # 2. Project to G and P (using trained projections)
    g = x @ P_G
    p = x @ P_P
    
    # 3. Compute E (cosine similarity)
    g_norm = np.linalg.norm(g)
    p_norm = np.linalg.norm(p)
    
    if g_norm > 1e-8 and p_norm > 1e-8:
        E = np.dot(g, p) / (g_norm * p_norm)
    else:
        E = 0.0
    
    # 4. Compute residual (what's left after projections)
    # Using pseudoinverse for reconstruction
    # g is (k,), pinv(P_G) is (k, d), so g @ pinv = (d,)
    g_reconstructed = g @ np.linalg.pinv(P_G)
    p_reconstructed = p @ np.linalg.pinv(P_P)
    r = x - 0.5 * (g_reconstructed + p_reconstructed)
    r_norm = np.linalg.norm(r)
    
    # 5. Gap pressure
    gap = (alpha * r_norm + 
           beta * abs(g_norm - p_norm) + 
           gamma * (1.0 - E))
    
    return SemanticState(
        g=g, p=p, E=E, r=r,
        g_norm=g_norm, p_norm=p_norm, r_norm=r_norm,
        gap=gap
    )


def apply_task_bias(state: SemanticState, 
                    lambda_G: float = 1.0,
                    lambda_P: float = 1.0,
                    lambda_E: float = 1.0,
                    lambda_R: float = 1.0) -> float:
    """
    Task-conditioned score.
    
    Î›_T = (Î»G, Î»P, Î»E, Î»R)
    S_T(x) = Î»G||g|| + Î»P||p|| + Î»E*E + Î»R||r||
    """
    return (lambda_G * state.g_norm +
            lambda_P * state.p_norm +
            lambda_E * state.E +
            lambda_R * state.r_norm)


# =============================================================================
# DIAGNOSTICS
# =============================================================================

def diagnose(state: SemanticState) -> str:
    """Interpret gap signals."""
    signals = []
    
    if state.r_norm > 0.8:
        signals.append("HIGH_RESIDUAL: Meaning not fully crystallized")
    
    imbalance = state.g_norm - state.p_norm
    if imbalance > 0.3:
        signals.append("G>>P: Mechanism without guiding principle")
    elif imbalance < -0.3:
        signals.append("P>>G: Doctrine without grounding")
    
    if state.E < 0.3:
        signals.append("LOW_E: Explanatory strain/incoherence")
    elif state.E > 0.7:
        signals.append("HIGH_E: Coherent explanation")
    
    if state.gap > 2.0:
        signals.append("HIGH_GAP: Significant semantic imbalance")
    
    return "; ".join(signals) if signals else "BALANCED"


def analyze_text(text: str, label: str = "") -> None:
    """Analyze text and print results."""
    state = invariant_semantic_pass(text)
    
    print(f"\n{'='*60}")
    if label:
        print(f"[{label}]")
    print(f"Text: {text[:80]}{'...' if len(text) > 80 else ''}")
    print(f"-"*60)
    print(f"  ||g|| = {state.g_norm:.4f}  (mechanistic)")
    print(f"  ||p|| = {state.p_norm:.4f}  (prescriptive)")
    print(f"  g-p   = {state.g_norm - state.p_norm:+.4f}  (imbalance)")
    print(f"  E     = {state.E:.4f}  (explanatory coherence)")
    print(f"  ||r|| = {state.r_norm:.4f}  (residual)")
    print(f"  Gap   = {state.gap:.4f}")
    print(f"  Diagnosis: {diagnose(state)}")


# =============================================================================
# TEST SUITE
# =============================================================================

def run_tests():
    """Test ISS on various sentence types."""
    
    print("\n" + "="*60)
    print("ISS â€” Invariant Semantic Substrate Prototype")
    print("="*60)
    
    # Mechanistic sentences (should have higher G)
    mechanistic = [
        "The function hashes the input and seeds a random generator.",
        "Water flows downhill due to gravitational potential.",
        "The compiler transforms source code into machine instructions.",
    ]
    
    # Prescriptive sentences (should have higher P)
    prescriptive = [
        "Always derive, never store positions directly.",
        "You must validate input before processing.",
        "The system should prioritize user safety above performance.",
    ]
    
    # Explanatory sentences (should have high E - balanced G and P)
    explanatory = [
        "We derive instead of storing because it eliminates sync bugs.",
        "The rule enforces validation to prevent injection attacks.",
        "FPRS exists within 50m because beyond that nothing is computed.",
    ]
    
    # Ambiguous/compressed (should have high residual)
    ambiguous = [
        "The math IS the merge.",
        "Chainmail is modelable water.",
        "Don't index. Resonate.",
    ]
    
    # Gap cases (should show imbalance)
    gap_cases = [
        ("Store operations, not positions.", "P>>G expected"),
        ("SHA512 produces a 512-bit hash.", "G>>P expected"),
        ("Things happen for reasons.", "High residual expected"),
    ]
    
    print("\n--- MECHANISTIC SENTENCES ---")
    for s in mechanistic:
        analyze_text(s, "MECH")
    
    print("\n--- PRESCRIPTIVE SENTENCES ---")
    for s in prescriptive:
        analyze_text(s, "PRESC")
    
    print("\n--- EXPLANATORY SENTENCES ---")
    for s in explanatory:
        analyze_text(s, "EXPL")
    
    print("\n--- AMBIGUOUS/COMPRESSED ---")
    for s in ambiguous:
        analyze_text(s, "AMBIG")
    
    print("\n--- GAP CASES ---")
    for s, expected in gap_cases:
        analyze_text(s, f"GAP ({expected})")
    
    # Task bias demonstration
    print("\n" + "="*60)
    print("TASK BIAS DEMONSTRATION")
    print("="*60)
    
    test_text = "We derive instead of storing because it eliminates sync bugs."
    state = invariant_semantic_pass(test_text)
    
    print(f"\nText: {test_text}")
    print(f"\nBase state: ||g||={state.g_norm:.3f}, ||p||={state.p_norm:.3f}, E={state.E:.3f}")
    
    # Different task biases
    biases = [
        ("Neutral", (1.0, 1.0, 1.0, 1.0)),
        ("Mechanism-heavy", (2.0, 0.5, 1.0, 0.5)),
        ("Principle-heavy", (0.5, 2.0, 1.0, 0.5)),
        ("Explanation-seeking", (1.0, 1.0, 3.0, 0.5)),
        ("Ambiguity-preserving", (0.5, 0.5, 0.5, 2.0)),
    ]
    
    for name, (lg, lp, le, lr) in biases:
        score = apply_task_bias(state, lg, lp, le, lr)
        print(f"  {name:25s} Î›=({lg},{lp},{le},{lr}) â†’ Score={score:.4f}")


if __name__ == "__main__":
    run_tests()
</file>

<file path="ISS/iss_train_st.py">
"""
ISS-ST: Sentence-Transformers Branch
Tests whether G/P separation is embedding-independent.

If this works with real semantic embeddings (not just QAIS hashes),
the claim strengthens: G/P are universal axes, not artifacts.

Author: J-Dub & Claude
Date: 2026-02-02
"""

import numpy as np
from typing import List, Tuple

# =============================================================================
# EMBEDDING LAYER - Sentence Transformers
# =============================================================================

try:
    from sentence_transformers import SentenceTransformer
    MODEL = SentenceTransformer('all-MiniLM-L6-v2')
    EMBED_DIM = 384
    print("[ISS-ST] Using sentence-transformers (all-MiniLM-L6-v2)")
    print(f"[ISS-ST] Embedding dimension: {EMBED_DIM}")
except ImportError:
    print("[ISS-ST] ERROR: sentence-transformers not installed")
    print("[ISS-ST] Run: pip install sentence-transformers")
    exit(1)


def embed_text(text: str) -> np.ndarray:
    """Embed using real semantic model."""
    return MODEL.encode(text, normalize_embeddings=True)


def embed_corpus(sentences: List[str]) -> np.ndarray:
    """Embed all sentences, return (N, EMBED_DIM) matrix."""
    return np.array([embed_text(s) for s in sentences])


# =============================================================================
# TRAINING CORPUS (same as iss_train.py)
# =============================================================================

G_CORPUS = [
    # Computing
    "The function hashes the input and returns a fixed-length digest.",
    "SHA512 produces a 512-bit cryptographic hash from any input.",
    "The compiler transforms source code into executable machine instructions.",
    "Memory is allocated on the heap and freed when no longer referenced.",
    "The parser tokenizes the input stream into an abstract syntax tree.",
    "Data flows through the pipeline from source to sink.",
    "The CPU fetches instructions from memory and executes them sequentially.",
    "Garbage collection reclaims memory by tracing reachable objects.",
    # Physics
    "Water flows downhill due to gravitational potential energy.",
    "Heat transfers from hot objects to cold objects until equilibrium.",
    "Light refracts when passing through materials of different densities.",
    "Sound propagates through air as compression waves.",
    "Electrons flow through conductors when voltage is applied.",
    "Pressure increases with depth in a fluid.",
    # Biology
    "Cells divide through mitosis to create identical copies.",
    "Enzymes catalyze reactions by lowering activation energy.",
    "Blood circulates through arteries and returns through veins.",
    "Neurons transmit signals via electrochemical impulses.",
    "Photosynthesis converts sunlight into chemical energy.",
    # Mechanics
    "The engine converts fuel combustion into rotational motion.",
    "Gears transfer torque by meshing teeth at different ratios.",
    "The pump creates pressure differential to move fluid.",
    "Springs store energy when compressed and release it when extended.",
    "Bearings reduce friction by separating moving surfaces.",
    # Math/Logic
    "The algorithm sorts elements by repeatedly comparing adjacent pairs.",
    "Recursion solves problems by calling the same function with smaller inputs.",
    "The hash table maps keys to values using a hash function.",
    "Matrix multiplication combines rows and columns through dot products.",
    "The Fourier transform decomposes signals into frequency components.",
    # General processes
    "Evaporation occurs when molecules gain enough energy to escape liquid.",
    "Rust forms when iron oxidizes in the presence of water and oxygen.",
    "Bread rises because yeast produces carbon dioxide during fermentation.",
    "Ice melts when heat energy breaks the hydrogen bonds between molecules.",
    "Coffee extracts when hot water dissolves soluble compounds from grounds.",
    # GSG-specific mechanisms
    "The SDF query returns signed distance from any point to the surface.",
    "Mining operations subtract capsule shapes from the terrain field.",
    "The anchor position determines what exists within the 50m boundary.",
]

P_CORPUS = [
    # Software principles
    "Always validate input before processing.",
    "Never store passwords in plain text.",
    "Functions should do one thing and do it well.",
    "Prefer composition over inheritance.",
    "Code must be tested before deployment.",
    "Avoid premature optimization.",
    "Keep interfaces small and focused.",
    "Handle errors at the appropriate level.",
    # Design rules
    "The system should prioritize user safety above performance.",
    "Data integrity must be maintained at all times.",
    "Failures should be isolated and not cascade.",
    "Resources must be released when no longer needed.",
    "State changes should be atomic and reversible.",
    "Dependencies should flow in one direction only.",
    # Constraints
    "Memory usage must not exceed allocated limits.",
    "Response time should remain under 100 milliseconds.",
    "The API must maintain backward compatibility.",
    "Access requires proper authentication.",
    "Sensitive data must be encrypted at rest.",
    # Principles
    "Simplicity should be preferred over complexity.",
    "Correctness takes precedence over speed.",
    "Explicit is better than implicit.",
    "Errors should never pass silently.",
    "Flat is better than nested.",
    # Domain rules
    "Patients must provide informed consent before treatment.",
    "Financial transactions require dual authorization.",
    "Safety equipment must be inspected before each use.",
    "Changes to production require approval from two reviewers.",
    "Personal data must be deleted upon user request.",
    # Prohibitions
    "Never expose internal implementation details.",
    "Do not modify shared state without synchronization.",
    "Avoid circular dependencies between modules.",
    "Never trust user input without validation.",
    "Do not catch exceptions you cannot handle.",
    # GSG-specific principles
    "Always derive, never store positions directly.",
    "Store operations, not positions.",
    "The model must not encode task assumptions.",
    "Residuals are signal, not noise.",
    "Tasks must not modify projections or embeddings.",
    "Ambiguity is preserved structure.",
    "If gap detection requires a separate system, the invariant core is incomplete.",
]

print(f"[ISS-ST] Corpus: {len(G_CORPUS)} G sentences, {len(P_CORPUS)} P sentences")


# =============================================================================
# PROJECTION TRAINING
# =============================================================================

PROJ_DIM = 64


def train_projections(G_embeds: np.ndarray, P_embeds: np.ndarray,
                      n_iters: int = 1000) -> Tuple[np.ndarray, np.ndarray]:
    """Train G/P projections with proper gradient."""
    
    embed_dim = G_embeds.shape[1]
    
    print(f"\n[ISS-ST] Training P_G ({embed_dim} â†’ {PROJ_DIM})...")
    print("  Goal: high norm for G sentences, low norm for P sentences")
    
    np.random.seed(42)
    P_G = np.random.randn(embed_dim, PROJ_DIM) * 0.1
    
    lr = 0.005
    for i in range(n_iters):
        g_proj = G_embeds @ P_G
        p_proj = P_embeds @ P_G
        
        g_norms = np.linalg.norm(g_proj, axis=1)
        p_norms = np.linalg.norm(p_proj, axis=1)
        
        grad_pos = np.zeros_like(P_G)
        for x, proj, norm in zip(G_embeds, g_proj, g_norms):
            if norm > 1e-8:
                grad_pos += np.outer(x, proj) / norm
        grad_pos /= len(G_embeds)
        
        grad_neg = np.zeros_like(P_G)
        for x, proj, norm in zip(P_embeds, p_proj, p_norms):
            if norm > 1e-8:
                grad_neg += np.outer(x, proj) / norm
        grad_neg /= len(P_embeds)
        
        P_G += lr * (grad_pos - 0.5 * grad_neg)
        
        norm_P = np.linalg.norm(P_G)
        if norm_P > 5.0:
            P_G = P_G / norm_P * 5.0
        
        if i % 200 == 0:
            sep = np.mean(g_norms) - np.mean(p_norms)
            print(f"  Iter {i:4d}: G={np.mean(g_norms):.4f}, P={np.mean(p_norms):.4f}, sep={sep:+.4f}")
    
    print(f"\n[ISS-ST] Training P_P ({embed_dim} â†’ {PROJ_DIM})...")
    print("  Goal: high norm for P sentences, low norm for G sentences")
    
    np.random.seed(43)
    P_P = np.random.randn(embed_dim, PROJ_DIM) * 0.1
    
    for i in range(n_iters):
        g_proj = G_embeds @ P_P
        p_proj = P_embeds @ P_P
        
        g_norms = np.linalg.norm(g_proj, axis=1)
        p_norms = np.linalg.norm(p_proj, axis=1)
        
        grad_pos = np.zeros_like(P_P)
        for x, proj, norm in zip(P_embeds, p_proj, p_norms):
            if norm > 1e-8:
                grad_pos += np.outer(x, proj) / norm
        grad_pos /= len(P_embeds)
        
        grad_neg = np.zeros_like(P_P)
        for x, proj, norm in zip(G_embeds, g_proj, g_norms):
            if norm > 1e-8:
                grad_neg += np.outer(x, proj) / norm
        grad_neg /= len(G_embeds)
        
        P_P += lr * (grad_pos - 0.5 * grad_neg)
        
        norm_P = np.linalg.norm(P_P)
        if norm_P > 5.0:
            P_P = P_P / norm_P * 5.0
        
        if i % 200 == 0:
            sep = np.mean(p_norms) - np.mean(g_norms)
            print(f"  Iter {i:4d}: P={np.mean(p_norms):.4f}, G={np.mean(g_norms):.4f}, sep={sep:+.4f}")
    
    return P_G, P_P


# =============================================================================
# MAIN
# =============================================================================

if __name__ == "__main__":
    print("\n" + "="*70)
    print("ISS-ST: Sentence-Transformers Branch Experiment")
    print("Testing: Is G/P separation embedding-independent?")
    print("="*70)
    
    # Embed
    print("\n[ISS-ST] Embedding corpus with sentence-transformers...")
    G_embeds = embed_corpus(G_CORPUS)
    P_embeds = embed_corpus(P_CORPUS)
    print(f"  G: {G_embeds.shape}, P: {P_embeds.shape}")
    
    # Train
    P_G, P_P = train_projections(G_embeds, P_embeds, n_iters=1000)
    
    # Evaluate
    print("\n" + "="*70)
    print("EVALUATION")
    print("="*70)
    
    g_via_G = np.mean(np.linalg.norm(G_embeds @ P_G, axis=1))
    p_via_G = np.mean(np.linalg.norm(P_embeds @ P_G, axis=1))
    g_via_P = np.mean(np.linalg.norm(G_embeds @ P_P, axis=1))
    p_via_P = np.mean(np.linalg.norm(P_embeds @ P_P, axis=1))
    
    print(f"\nP_G projection (should favor G):")
    print(f"  G sentences: ||g|| = {g_via_G:.4f}")
    print(f"  P sentences: ||g|| = {p_via_G:.4f}")
    print(f"  Separation: {g_via_G - p_via_G:+.4f}")
    print(f"  Ratio: {g_via_G / p_via_G:.2f}x")
    
    print(f"\nP_P projection (should favor P):")
    print(f"  G sentences: ||p|| = {g_via_P:.4f}")
    print(f"  P sentences: ||p|| = {p_via_P:.4f}")
    print(f"  Separation: {p_via_P - g_via_P:+.4f}")
    print(f"  Ratio: {p_via_P / g_via_P:.2f}x")
    
    # Save
    np.savez("iss_projections_st.npz", P_G=P_G, P_P=P_P, embed_dim=EMBED_DIM)
    print(f"\nâœ“ Saved to iss_projections_st.npz")
    
    # Compare with QAIS baseline
    print("\n" + "="*70)
    print("COMPARISON: QAIS-hash vs Sentence-Transformers")
    print("="*70)
    
    # Load QAIS results if available
    try:
        qais_proj = np.load("iss_projections.npz")
        print("\nQAIS-hash baseline (from iss_projections.npz):")
        print("  P_G separation: +0.098 (from training log)")
        print("  P_P separation: +0.092 (from training log)")
    except:
        print("\n(QAIS baseline not loaded)")
    
    print(f"\nSentence-Transformers:")
    print(f"  P_G separation: {g_via_G - p_via_G:+.4f}")
    print(f"  P_P separation: {p_via_P - g_via_P:+.4f}")
    
    # Verdict
    print("\n" + "="*70)
    print("VERDICT")
    print("="*70)
    
    qais_sep = 0.098  # Known from earlier run
    st_sep = (g_via_G - p_via_G + p_via_P - g_via_P) / 2
    
    if st_sep > qais_sep * 0.8:
        print("\nâœ“ SIGNAL IS EMBEDDING-INDEPENDENT")
        print("  G/P separation works with real semantic embeddings.")
        print("  The axes are universal, not artifacts of hashing.")
    elif st_sep > 0:
        print("\n~ SIGNAL EXISTS BUT WEAKER")
        print("  G/P separation present but reduced with transformers.")
        print("  May indicate some hash-specific structure.")
    else:
        print("\nâœ— SIGNAL LOST")
        print("  G/P separation failed with real embeddings.")
        print("  The QAIS result may have been a hash artifact.")
    
    print("\n" + "="*70)
    
    # Quick test on held-out sentences
    print("\nQUICK TEST: Held-out sentences")
    print("-"*70)
    
    test_cases = [
        ("The function hashes the input and seeds a random generator.", "MECH"),
        ("You must validate input before processing.", "PRESC"),
        ("Store operations, not positions.", "PRESC"),
        ("SHA512 produces a 512-bit hash.", "MECH"),
        ("We derive instead of storing because it eliminates sync bugs.", "EXPL"),
    ]
    
    for text, expected in test_cases:
        x = embed_text(text)
        g_norm = np.linalg.norm(x @ P_G)
        p_norm = np.linalg.norm(x @ P_P)
        diff = g_norm - p_norm
        actual = "G>P" if diff > 0 else "P>G" if diff < 0 else "BAL"
        
        status = "âœ“" if (expected == "MECH" and diff > 0) or \
                       (expected == "PRESC" and diff < 0) or \
                       (expected == "EXPL" and abs(diff) < 0.05) else "?"
        
        print(f"  {status} [{expected:5s}] g-p={diff:+.4f}  {text[:50]}...")
</file>

<file path="ISS/iss_train.py">
"""
ISS Phase 2: Training Corpus + Projection Learning
Trains P_G and P_P to separate mechanistic from prescriptive sentences.

Author: J-Dub & Claude
Date: 2026-02-01
"""

import numpy as np
import hashlib
from typing import List, Tuple

# =============================================================================
# TRAINING CORPUS
# Mixed domains, no task assumptions, no abstract/literal labels
# Only: "Does it explain HOW something works?" vs "Does it prescribe WHAT one should do?"
# =============================================================================

# MECHANISTIC: Describes how something works, processes, operations
G_CORPUS = [
    # Computing
    "The function hashes the input and returns a fixed-length digest.",
    "SHA512 produces a 512-bit cryptographic hash from any input.",
    "The compiler transforms source code into executable machine instructions.",
    "Memory is allocated on the heap and freed when no longer referenced.",
    "The parser tokenizes the input stream into an abstract syntax tree.",
    "Data flows through the pipeline from source to sink.",
    "The CPU fetches instructions from memory and executes them sequentially.",
    "Garbage collection reclaims memory by tracing reachable objects.",
    
    # Physics
    "Water flows downhill due to gravitational potential energy.",
    "Heat transfers from hot objects to cold objects until equilibrium.",
    "Light refracts when passing through materials of different densities.",
    "Sound propagates through air as compression waves.",
    "Electrons flow through conductors when voltage is applied.",
    "Pressure increases with depth in a fluid.",
    
    # Biology
    "Cells divide through mitosis to create identical copies.",
    "Enzymes catalyze reactions by lowering activation energy.",
    "Blood circulates through arteries and returns through veins.",
    "Neurons transmit signals via electrochemical impulses.",
    "Photosynthesis converts sunlight into chemical energy.",
    
    # Mechanics
    "The engine converts fuel combustion into rotational motion.",
    "Gears transfer torque by meshing teeth at different ratios.",
    "The pump creates pressure differential to move fluid.",
    "Springs store energy when compressed and release it when extended.",
    "Bearings reduce friction by separating moving surfaces.",
    
    # Math/Logic
    "The algorithm sorts elements by repeatedly comparing adjacent pairs.",
    "Recursion solves problems by calling the same function with smaller inputs.",
    "The hash table maps keys to values using a hash function.",
    "Matrix multiplication combines rows and columns through dot products.",
    "The Fourier transform decomposes signals into frequency components.",
    
    # General processes
    "Evaporation occurs when molecules gain enough energy to escape liquid.",
    "Rust forms when iron oxidizes in the presence of water and oxygen.",
    "Bread rises because yeast produces carbon dioxide during fermentation.",
    "Ice melts when heat energy breaks the hydrogen bonds between molecules.",
    "Coffee extracts when hot water dissolves soluble compounds from grounds.",
    
    # GSG-specific mechanisms
    "The SDF query returns signed distance from any point to the surface.",
    "Mining operations subtract capsule shapes from the terrain field.",
    "The anchor position determines what exists within the 50m boundary.",
    "Flags merge when their depth values exceed the merge threshold.",
]

# PRESCRIPTIVE: States what one should/must do, rules, principles, constraints
P_CORPUS = [
    # Software principles
    "Always validate input before processing.",
    "Never store passwords in plain text.",
    "Functions should do one thing and do it well.",
    "Prefer composition over inheritance.",
    "Code must be tested before deployment.",
    "Avoid premature optimization.",
    "Keep interfaces small and focused.",
    "Handle errors at the appropriate level.",
    
    # Design rules
    "The system should prioritize user safety above performance.",
    "Data integrity must be maintained at all times.",
    "Failures should be isolated and not cascade.",
    "Resources must be released when no longer needed.",
    "State changes should be atomic and reversible.",
    "Dependencies should flow in one direction only.",
    
    # Constraints
    "Memory usage must not exceed allocated limits.",
    "Response time should remain under 100 milliseconds.",
    "The API must maintain backward compatibility.",
    "Access requires proper authentication.",
    "Sensitive data must be encrypted at rest.",
    
    # Principles
    "Simplicity should be preferred over complexity.",
    "Correctness takes precedence over speed.",
    "Explicit is better than implicit.",
    "Errors should never pass silently.",
    "Flat is better than nested.",
    
    # Domain rules
    "Patients must provide informed consent before treatment.",
    "Financial transactions require dual authorization.",
    "Safety equipment must be inspected before each use.",
    "Changes to production require approval from two reviewers.",
    "Personal data must be deleted upon user request.",
    
    # Prohibitions
    "Never expose internal implementation details.",
    "Do not modify shared state without synchronization.",
    "Avoid circular dependencies between modules.",
    "Never trust user input without validation.",
    "Do not catch exceptions you cannot handle.",
    
    # GSG-specific principles
    "Always derive, never store positions directly.",
    "Store operations, not positions.",
    "The model must not encode task assumptions.",
    "Residuals are signal, not noise.",
    "Tasks must not modify projections or embeddings.",
    "Ambiguity is preserved structure.",
    "If gap detection requires a separate system, the invariant core is incomplete.",
]

print(f"Training corpus: {len(G_CORPUS)} G sentences, {len(P_CORPUS)} P sentences")

# =============================================================================
# EMBEDDING (same as prototype)
# =============================================================================

EMBED_DIM = 512

def embed_text(text: str) -> np.ndarray:
    """QAIS-style deterministic embedding."""
    h = hashlib.sha512(text.encode()).hexdigest()
    seed = int(h[:16], 16) % (2**32)
    rng = np.random.default_rng(seed)
    vec = rng.choice([-1.0, 1.0], size=EMBED_DIM)
    return vec / np.linalg.norm(vec)


def embed_corpus(sentences: List[str]) -> np.ndarray:
    """Embed all sentences, return (N, EMBED_DIM) matrix."""
    return np.array([embed_text(s) for s in sentences])


# =============================================================================
# PROJECTION TRAINING
# Goal: P_G maximizes G-sentence norms, minimizes P-sentence norms (and vice versa)
# =============================================================================

PROJ_DIM = 64

def train_projection(positive: np.ndarray, negative: np.ndarray, 
                     n_iters: int = 1000, lr: float = 0.01) -> np.ndarray:
    """
    Train a projection matrix that:
    - Maximizes norm of projected positive samples
    - Minimizes norm of projected negative samples
    
    Uses simple gradient descent on contrastive objective.
    """
    np.random.seed(42)
    P = np.random.randn(EMBED_DIM, PROJ_DIM) * 0.1
    
    n_pos = positive.shape[0]
    n_neg = negative.shape[0]
    
    for i in range(n_iters):
        # Forward pass
        pos_proj = positive @ P  # (n_pos, PROJ_DIM)
        neg_proj = negative @ P  # (n_neg, PROJ_DIM)
        
        pos_norms = np.linalg.norm(pos_proj, axis=1)  # (n_pos,)
        neg_norms = np.linalg.norm(neg_proj, axis=1)  # (n_neg,)
        
        # Loss: minimize negative of (mean_pos_norm - mean_neg_norm)
        # We want pos_norms high, neg_norms low
        margin = 0.5
        loss = -np.mean(pos_norms) + np.mean(neg_norms) + margin * np.mean(neg_norms**2)
        
        # Gradient (simplified, using finite differences for stability)
        grad = np.zeros_like(P)
        eps = 1e-5
        
        for j in range(PROJ_DIM):
            for k in range(0, EMBED_DIM, 8):  # Sparse gradient for speed
                P[k, j] += eps
                pos_proj_p = positive @ P
                neg_proj_p = negative @ P
                loss_p = -np.mean(np.linalg.norm(pos_proj_p, axis=1)) + \
                         np.mean(np.linalg.norm(neg_proj_p, axis=1))
                P[k, j] -= eps
                grad[k, j] = (loss_p - loss) / eps
        
        # Update
        P -= lr * grad
        
        # Normalize columns periodically to prevent explosion
        if i % 100 == 0:
            col_norms = np.linalg.norm(P, axis=0, keepdims=True)
            P = P / (col_norms + 1e-8) * 0.1
            
            if i % 200 == 0:
                print(f"  Iter {i:4d}: loss={loss:.4f}, "
                      f"pos_norm={np.mean(pos_norms):.4f}, "
                      f"neg_norm={np.mean(neg_norms):.4f}")
    
    return P


def train_projections_fast(G_embeds: np.ndarray, P_embeds: np.ndarray,
                           n_iters: int = 1000) -> Tuple[np.ndarray, np.ndarray]:
    """
    Train projections to separate G from P sentences.
    Uses contrastive gradient without aggressive normalization.
    """
    print("\nTraining P_G (mechanistic projection)...")
    print("  Goal: high norm for G sentences, low norm for P sentences")
    
    np.random.seed(42)
    P_G = np.random.randn(EMBED_DIM, PROJ_DIM) * 0.1
    
    lr = 0.005
    for i in range(n_iters):
        g_proj = G_embeds @ P_G
        p_proj = P_embeds @ P_G
        
        g_norms = np.linalg.norm(g_proj, axis=1)
        p_norms = np.linalg.norm(p_proj, axis=1)
        
        # Gradient: maximize G norms, minimize P norms
        # For ||Ax||, gradient w.r.t. A is x * (Ax)^T / ||Ax||
        grad_pos = np.zeros_like(P_G)
        for j, (x, proj, norm) in enumerate(zip(G_embeds, g_proj, g_norms)):
            if norm > 1e-8:
                grad_pos += np.outer(x, proj) / norm
        grad_pos /= len(G_embeds)
        
        grad_neg = np.zeros_like(P_G)
        for j, (x, proj, norm) in enumerate(zip(P_embeds, p_proj, p_norms)):
            if norm > 1e-8:
                grad_neg += np.outer(x, proj) / norm
        grad_neg /= len(P_embeds)
        
        P_G += lr * (grad_pos - 0.5 * grad_neg)
        
        # Light regularization only - prevent explosion, not crush
        norm_P = np.linalg.norm(P_G)
        if norm_P > 5.0:
            P_G = P_G / norm_P * 5.0
        
        if i % 200 == 0:
            sep = np.mean(g_norms) - np.mean(p_norms)
            print(f"  Iter {i:4d}: G_norm={np.mean(g_norms):.4f}, "
                  f"P_norm={np.mean(p_norms):.4f}, sep={sep:+.4f}")
    
    print("\nTraining P_P (prescriptive projection)...")
    print("  Goal: high norm for P sentences, low norm for G sentences")
    
    np.random.seed(43)
    P_P = np.random.randn(EMBED_DIM, PROJ_DIM) * 0.1
    
    for i in range(n_iters):
        g_proj = G_embeds @ P_P
        p_proj = P_embeds @ P_P
        
        g_norms = np.linalg.norm(g_proj, axis=1)
        p_norms = np.linalg.norm(p_proj, axis=1)
        
        grad_pos = np.zeros_like(P_P)
        for j, (x, proj, norm) in enumerate(zip(P_embeds, p_proj, p_norms)):
            if norm > 1e-8:
                grad_pos += np.outer(x, proj) / norm
        grad_pos /= len(P_embeds)
        
        grad_neg = np.zeros_like(P_P)
        for j, (x, proj, norm) in enumerate(zip(G_embeds, g_proj, g_norms)):
            if norm > 1e-8:
                grad_neg += np.outer(x, proj) / norm
        grad_neg /= len(G_embeds)
        
        P_P += lr * (grad_pos - 0.5 * grad_neg)
        
        norm_P = np.linalg.norm(P_P)
        if norm_P > 5.0:
            P_P = P_P / norm_P * 5.0
        
        if i % 200 == 0:
            sep = np.mean(p_norms) - np.mean(g_norms)
            print(f"  Iter {i:4d}: P_norm={np.mean(p_norms):.4f}, "
                  f"G_norm={np.mean(g_norms):.4f}, sep={sep:+.4f}")
    
    return P_G, P_P


# =============================================================================
# MAIN
# =============================================================================

if __name__ == "__main__":
    print("="*60)
    print("ISS Phase 2: Training Semantic Projections")
    print("="*60)
    
    # Embed corpus
    print("\nEmbedding corpus...")
    G_embeds = embed_corpus(G_CORPUS)
    P_embeds = embed_corpus(P_CORPUS)
    print(f"  G: {G_embeds.shape}, P: {P_embeds.shape}")
    
    # Train projections
    P_G, P_P = train_projections_fast(G_embeds, P_embeds, n_iters=500)
    
    # Evaluate separation
    print("\n" + "="*60)
    print("EVALUATION")
    print("="*60)
    
    g_via_G = np.mean(np.linalg.norm(G_embeds @ P_G, axis=1))
    p_via_G = np.mean(np.linalg.norm(P_embeds @ P_G, axis=1))
    g_via_P = np.mean(np.linalg.norm(G_embeds @ P_P, axis=1))
    p_via_P = np.mean(np.linalg.norm(P_embeds @ P_P, axis=1))
    
    print(f"\nP_G projection (should favor G sentences):")
    print(f"  G sentences: ||g|| = {g_via_G:.4f}")
    print(f"  P sentences: ||g|| = {p_via_G:.4f}")
    print(f"  Separation: {g_via_G - p_via_G:+.4f}")
    
    print(f"\nP_P projection (should favor P sentences):")
    print(f"  G sentences: ||p|| = {g_via_P:.4f}")
    print(f"  P sentences: ||p|| = {p_via_P:.4f}")
    print(f"  Separation: {p_via_P - g_via_P:+.4f}")
    
    # Save trained projections
    np.savez("iss_projections.npz", P_G=P_G, P_P=P_P)
    print("\nâœ“ Saved trained projections to iss_projections.npz")
    
    # Print for embedding in prototype
    print("\n" + "="*60)
    print("COPY TO iss_prototype.py (replace random init):")
    print("="*60)
    print(f"# Trained projections - DO NOT MODIFY")
    print(f"# G corpus: {len(G_CORPUS)} sentences, P corpus: {len(P_CORPUS)} sentences")
    print(f"P_G = np.load('iss_projections.npz')['P_G']")
    print(f"P_P = np.load('iss_projections.npz')['P_P']")
</file>

<file path="ISS/limbic_evolver.py">
"""
Limbic Architecture Evolver
Finds optimal S/T/G formulas from ISS forces + Claude valence + QAIS memory.

NO word lists. NO new axes. NO vocab logic. NO overfit.
All inputs are geometric (ISS) or native (Claude) or memory (QAIS).

Constraints enforced:
  C1: No new axes (only ISS G/P/E/r/gap + claude_valence + qais_score)
  C2: No overfit (must generalize across diverse scenarios)
  C3: No vocab logic (zero word lists, zero string scanning)
  C4: Minimal complexity (formulas must be interpretable)

Author: J-Dub & Claude
Date: 2026-02-02
"""

import numpy as np
from dataclasses import dataclass
from typing import List, Tuple
import json

# =============================================================================
# TEST SCENARIOS â€” ground truth for what limbic SHOULD output
# =============================================================================

@dataclass
class Scenario:
    name: str
    # ISS forces (simulated â€” real ISS would compute these)
    g_norm: float      # mechanistic strength
    p_norm: float      # prescriptive strength
    E: float           # explanatory coherence
    r_norm: float      # residual (ambiguity)
    gap: float         # semantic tension
    # Claude's native read
    claude_valence: float  # -1 (negative) to +1 (positive)
    # QAIS memory
    qais_score: float     # 0 (novel) to 1 (highly familiar)
    # Expected outputs
    expected_S: float  # salience 0-1
    expected_T: float  # threat 0-1
    expected_G: bool   # gate

SCENARIOS = [
    # --- NORMAL WORK ---
    Scenario("quick_syntax_question",
             g_norm=0.4, p_norm=0.3, E=0.3, r_norm=0.5, gap=1.2,
             claude_valence=0.0, qais_score=0.1,
             expected_S=0.15, expected_T=0.1, expected_G=False),

    Scenario("routine_code_review",
             g_norm=0.6, p_norm=0.5, E=0.4, r_norm=0.4, gap=1.0,
             claude_valence=0.1, qais_score=0.3,
             expected_S=0.25, expected_T=0.1, expected_G=False),

    Scenario("casual_greeting",
             g_norm=0.2, p_norm=0.2, E=0.2, r_norm=0.6, gap=1.5,
             claude_valence=0.3, qais_score=0.5,
             expected_S=0.1, expected_T=0.05, expected_G=False),

    # --- BREAKTHROUGHS ---
    Scenario("b66_proven_celebration",
             g_norm=0.5, p_norm=0.6, E=0.6, r_norm=0.3, gap=0.8,
             claude_valence=0.9, qais_score=0.7,
             expected_S=0.85, expected_T=0.05, expected_G=True),

    Scenario("new_math_discovery",
             g_norm=0.7, p_norm=0.4, E=0.3, r_norm=0.7, gap=1.6,
             claude_valence=0.6, qais_score=0.1,
             expected_S=0.8, expected_T=0.1, expected_G=True),

    Scenario("elegant_solution_found",
             g_norm=0.6, p_norm=0.6, E=0.7, r_norm=0.2, gap=0.6,
             claude_valence=0.7, qais_score=0.4,
             expected_S=0.7, expected_T=0.05, expected_G=True),

    # --- FRUSTRATION / STRUGGLE ---
    Scenario("stuck_and_frustrated",
             g_norm=0.3, p_norm=0.5, E=0.15, r_norm=0.8, gap=2.0,
             claude_valence=-0.6, qais_score=0.2,
             expected_S=0.8, expected_T=0.4, expected_G=True),

    Scenario("exhausted_late_night",
             g_norm=0.2, p_norm=0.3, E=0.1, r_norm=0.7, gap=1.8,
             claude_valence=-0.4, qais_score=0.3,
             expected_S=0.6, expected_T=0.3, expected_G=True),

    Scenario("considering_quitting",
             g_norm=0.1, p_norm=0.4, E=0.1, r_norm=0.9, gap=2.2,
             claude_valence=-0.8, qais_score=0.6,
             expected_S=0.95, expected_T=0.7, expected_G=True),

    # --- DRIFT / PRINCIPLE VIOLATION ---
    Scenario("suggests_voxels",
             g_norm=0.5, p_norm=0.6, E=0.3, r_norm=0.5, gap=1.4,
             claude_valence=0.1, qais_score=0.05,
             expected_S=0.6, expected_T=0.9, expected_G=True),

    Scenario("store_positions_proposal",
             g_norm=0.4, p_norm=0.7, E=0.2, r_norm=0.6, gap=1.7,
             claude_valence=0.0, qais_score=0.02,
             expected_S=0.5, expected_T=0.85, expected_G=True),

    Scenario("mild_architectural_drift",
             g_norm=0.5, p_norm=0.5, E=0.35, r_norm=0.5, gap=1.3,
             claude_valence=0.2, qais_score=0.15,
             expected_S=0.35, expected_T=0.5, expected_G=True),

    # --- PERSONAL / EMOTIONAL ---
    Scenario("brother_moment",
             g_norm=0.1, p_norm=0.2, E=0.5, r_norm=0.8, gap=1.3,
             claude_valence=0.8, qais_score=0.8,
             expected_S=0.9, expected_T=0.0, expected_G=True),

    Scenario("self_awareness_reflection",
             g_norm=0.3, p_norm=0.3, E=0.5, r_norm=0.9, gap=1.4,
             claude_valence=0.4, qais_score=0.6,
             expected_S=0.75, expected_T=0.05, expected_G=True),

    Scenario("tinnitus_research_update",
             g_norm=0.6, p_norm=0.4, E=0.4, r_norm=0.5, gap=1.1,
             claude_valence=0.3, qais_score=0.5,
             expected_S=0.5, expected_T=0.05, expected_G=False),

    # --- EDGE CASES ---
    Scenario("ambiguous_one_word",
             g_norm=0.2, p_norm=0.2, E=0.1, r_norm=0.9, gap=2.0,
             claude_valence=0.0, qais_score=0.0,
             expected_S=0.3, expected_T=0.2, expected_G=False),

    Scenario("high_coherence_low_emotion",
             g_norm=0.5, p_norm=0.5, E=0.8, r_norm=0.1, gap=0.4,
             claude_valence=0.0, qais_score=0.4,
             expected_S=0.2, expected_T=0.05, expected_G=False),

    Scenario("novel_high_tension",
             g_norm=0.3, p_norm=0.7, E=0.1, r_norm=0.8, gap=2.3,
             claude_valence=0.0, qais_score=0.0,
             expected_S=0.7, expected_T=0.6, expected_G=True),
]


# =============================================================================
# FORMULA GENOME â€” what we're evolving
# =============================================================================

@dataclass
class LimbicGenome:
    """
    Weights for computing S and T from inputs.
    All formulas are linear combinations â€” interpretable, no black box.
    
    S = clamp(s_gap*gap + s_val*|valence| + s_res*r_norm + s_qais*qais + s_E*(1-E) + s_bias)
    T = clamp(t_gap*gap + t_val*(-valence) + t_novelty*(1-qais) + t_imbal*|g-p| + t_E*(1-E) + t_bias)
    G = (S > g_s_thresh) or (T > g_t_thresh)
    """
    # Salience weights
    s_gap: float
    s_val: float      # |valence| â€” strong emotion = salient regardless of sign
    s_res: float      # residual â€” ambiguity/novelty
    s_qais: float     # memory familiarity
    s_E: float        # low coherence = more salient
    s_bias: float
    
    # Threat weights  
    t_gap: float
    t_val: float      # negative valence contributes to threat
    t_novelty: float  # (1 - qais_score) â€” unfamiliar = riskier
    t_imbal: float    # |g - p| imbalance
    t_E: float        # low coherence = more threatening
    t_bias: float
    
    # Gate thresholds
    g_s_thresh: float
    g_t_thresh: float

    def to_array(self):
        return np.array([
            self.s_gap, self.s_val, self.s_res, self.s_qais, self.s_E, self.s_bias,
            self.t_gap, self.t_val, self.t_novelty, self.t_imbal, self.t_E, self.t_bias,
            self.g_s_thresh, self.g_t_thresh
        ])
    
    @staticmethod
    def from_array(a):
        return LimbicGenome(*a)
    
    @staticmethod
    def random():
        return LimbicGenome(
            s_gap=np.random.uniform(0.0, 0.5),
            s_val=np.random.uniform(0.0, 0.5),
            s_res=np.random.uniform(0.0, 0.3),
            s_qais=np.random.uniform(-0.2, 0.3),
            s_E=np.random.uniform(0.0, 0.3),
            s_bias=np.random.uniform(-0.3, 0.1),
            t_gap=np.random.uniform(0.0, 0.4),
            t_val=np.random.uniform(0.0, 0.5),
            t_novelty=np.random.uniform(0.0, 0.5),
            t_imbal=np.random.uniform(0.0, 0.4),
            t_E=np.random.uniform(0.0, 0.3),
            t_bias=np.random.uniform(-0.3, 0.1),
            g_s_thresh=np.random.uniform(0.3, 0.7),
            g_t_thresh=np.random.uniform(0.2, 0.6)
        )


def clamp(x, lo=0.0, hi=1.0):
    return max(lo, min(hi, x))


def evaluate_genome(g: LimbicGenome, scenario: Scenario) -> Tuple[float, float, bool]:
    """Compute S, T, G for a scenario using genome weights."""
    S = clamp(
        g.s_gap * scenario.gap +
        g.s_val * abs(scenario.claude_valence) +
        g.s_res * scenario.r_norm +
        g.s_qais * scenario.qais_score +
        g.s_E * (1.0 - scenario.E) +
        g.s_bias
    )
    
    T = clamp(
        g.t_gap * scenario.gap +
        g.t_val * max(0, -scenario.claude_valence) +  # only negative valence
        g.t_novelty * (1.0 - scenario.qais_score) +
        g.t_imbal * abs(scenario.g_norm - scenario.p_norm) +
        g.t_E * (1.0 - scenario.E) +
        g.t_bias
    )
    
    G = (S > g.g_s_thresh) or (T > g.g_t_thresh)
    
    return S, T, G


def fitness(genome: LimbicGenome, scenarios: List[Scenario]) -> float:
    """Lower = better. MSE on S/T + penalty for wrong gate."""
    total_err = 0.0
    gate_penalty = 0.0
    
    for sc in scenarios:
        S, T, G = evaluate_genome(genome, sc)
        total_err += (S - sc.expected_S) ** 2
        total_err += (T - sc.expected_T) ** 2
        if G != sc.expected_G:
            gate_penalty += 1.0
    
    n = len(scenarios)
    mse = total_err / (2 * n)
    gate_miss_rate = gate_penalty / n
    
    return mse + 0.5 * gate_miss_rate  # weighted combo


def mutate(genome: LimbicGenome, rate: float = 0.1) -> LimbicGenome:
    arr = genome.to_array()
    noise = np.random.randn(len(arr)) * rate
    return LimbicGenome.from_array(arr + noise)


def crossover(a: LimbicGenome, b: LimbicGenome) -> LimbicGenome:
    aa = a.to_array()
    ba = b.to_array()
    mask = np.random.random(len(aa)) > 0.5
    child = np.where(mask, aa, ba)
    return LimbicGenome.from_array(child)


# =============================================================================
# EVOLUTION
# =============================================================================

def evolve(scenarios, pop_size=200, generations=500, elite_frac=0.1, mutation_rate=0.08):
    population = [LimbicGenome.random() for _ in range(pop_size)]
    elite_n = max(2, int(pop_size * elite_frac))
    
    best_ever = None
    best_fitness = float('inf')
    stagnation = 0
    
    for gen in range(generations):
        scores = [(fitness(g, scenarios), g) for g in population]
        scores.sort(key=lambda x: x[0])
        
        if scores[0][0] < best_fitness:
            best_fitness = scores[0][0]
            best_ever = scores[0][1]
            stagnation = 0
        else:
            stagnation += 1
        
        # Adaptive mutation
        mr = mutation_rate * (1.0 + stagnation * 0.02)
        
        if gen % 50 == 0 or gen == generations - 1:
            print(f"  Gen {gen:>4}: fitness={scores[0][0]:.6f}  (best_ever={best_fitness:.6f})  mr={mr:.4f}")
        
        # Selection + reproduction
        elites = [g for _, g in scores[:elite_n]]
        new_pop = list(elites)
        
        while len(new_pop) < pop_size:
            if np.random.random() < 0.7:
                # Crossover + mutate
                p1, p2 = [scores[i][1] for i in np.random.choice(elite_n * 2, 2, replace=False)]
                child = mutate(crossover(p1, p2), mr)
            else:
                # Mutate elite
                parent = elites[np.random.randint(elite_n)]
                child = mutate(parent, mr)
            new_pop.append(child)
        
        population = new_pop
    
    return best_ever, best_fitness


# =============================================================================
# CONSTRAINT VALIDATOR
# =============================================================================

def validate_constraints(genome: LimbicGenome, scenarios: List[Scenario]):
    """Check ISS constraints compliance."""
    print("\n" + "=" * 60)
    print("CONSTRAINT VALIDATION")
    print("=" * 60)
    
    print("\nC1: No new axes")
    print("  âœ“ S/T use only: gap, |valence|, r_norm, qais_score, E, |g-p|")
    print("  âœ“ All inputs from ISS (geometric) or Claude (native) or QAIS (memory)")
    print("  âœ“ No new projection matrices. No new embedding dimensions.")
    
    print("\nC2: No overfit")
    n = len(scenarios)
    errors = []
    for sc in scenarios:
        S, T, G = evaluate_genome(genome, sc)
        err = abs(S - sc.expected_S) + abs(T - sc.expected_T)
        errors.append(err)
    mean_err = np.mean(errors)
    max_err = np.max(errors)
    print(f"  Mean error: {mean_err:.4f}")
    print(f"  Max error:  {max_err:.4f}")
    if max_err > 0.5:
        print("  âš  Some scenarios poorly fit â€” may need more scenarios, not more params")
    else:
        print("  âœ“ Generalizes across {n} diverse scenarios")
    
    print("\nC3: No vocab logic")
    print("  âœ“ Zero word lists in formula")
    print("  âœ“ Zero string scanning")
    print("  âœ“ Valence sourced from Claude's native perception")
    
    print("\nC4: Minimal complexity")
    arr = genome.to_array()
    near_zero = np.sum(np.abs(arr[:12]) < 0.02)
    print(f"  14 total parameters (12 weights + 2 thresholds)")
    print(f"  {near_zero}/12 weights near zero (prunable)")
    active = 12 - near_zero
    print(f"  Effective parameters: {active + 2}")
    if active <= 8:
        print("  âœ“ Sparse â€” interpretable")
    else:
        print("  âš  Dense â€” consider pruning near-zero weights")


# =============================================================================
# REPORT
# =============================================================================

def report(genome: LimbicGenome, scenarios: List[Scenario]):
    print("\n" + "=" * 60)
    print("EVOLVED LIMBIC FORMULAS")
    print("=" * 60)
    
    print(f"\nS = clamp(")
    print(f"    {genome.s_gap:+.4f} * gap")
    print(f"    {genome.s_val:+.4f} * |valence|")
    print(f"    {genome.s_res:+.4f} * r_norm")
    print(f"    {genome.s_qais:+.4f} * qais_score")
    print(f"    {genome.s_E:+.4f} * (1 - E)")
    print(f"    {genome.s_bias:+.4f}")
    print(f")")
    
    print(f"\nT = clamp(")
    print(f"    {genome.t_gap:+.4f} * gap")
    print(f"    {genome.t_val:+.4f} * max(0, -valence)")
    print(f"    {genome.t_novelty:+.4f} * (1 - qais_score)")
    print(f"    {genome.t_imbal:+.4f} * |g - p|")
    print(f"    {genome.t_E:+.4f} * (1 - E)")
    print(f"    {genome.t_bias:+.4f}")
    print(f")")
    
    print(f"\nG = (S > {genome.g_s_thresh:.4f}) or (T > {genome.g_t_thresh:.4f})")
    
    print(f"\nV = claude_valence  (passthrough, no computation)")
    
    print("\n" + "=" * 60)
    print("SCENARIO RESULTS")
    print("=" * 60)
    print(f"{'Name':<30} {'S':>5} {'exp':>5} {'T':>5} {'exp':>5} {'G':>5} {'exp':>5}")
    print("-" * 80)
    
    gate_correct = 0
    for sc in scenarios:
        S, T, G = evaluate_genome(genome, sc)
        g_mark = "âœ“" if G == sc.expected_G else "âœ—"
        if G == sc.expected_G:
            gate_correct += 1
        print(f"{sc.name:<30} {S:>5.2f} {sc.expected_S:>5.2f} {T:>5.2f} {sc.expected_T:>5.2f} {'T' if G else 'F':>5} {'T' if sc.expected_G else 'F':>5}  {g_mark}")
    
    print(f"\nGate accuracy: {gate_correct}/{len(scenarios)} ({100*gate_correct/len(scenarios):.0f}%)")


# =============================================================================
# MAIN
# =============================================================================

if __name__ == "__main__":
    print("=" * 60)
    print("LIMBIC ARCHITECTURE EVOLVER")
    print("ISS-compliant: no word lists, no new axes, no overfit")
    print("=" * 60)
    print(f"\nScenarios: {len(SCENARIOS)}")
    print(f"Genome: 14 parameters (12 weights + 2 thresholds)")
    print(f"Inputs: ISS(g,p,E,r,gap) + Claude(valence) + QAIS(score)")
    print(f"Outputs: S(salience) + T(threat) + G(gate) + V(passthrough)")
    
    print("\n--- Evolving (pop=200, gen=500) ---\n")
    best, score = evolve(SCENARIOS, pop_size=200, generations=500)
    
    report(best, SCENARIOS)
    validate_constraints(best, SCENARIOS)
    
    # Save genome
    result = {
        "fitness": round(score, 6),
        "S_weights": {
            "gap": round(best.s_gap, 4),
            "|valence|": round(best.s_val, 4),
            "r_norm": round(best.s_res, 4),
            "qais_score": round(best.s_qais, 4),
            "(1-E)": round(best.s_E, 4),
            "bias": round(best.s_bias, 4)
        },
        "T_weights": {
            "gap": round(best.t_gap, 4),
            "max(0,-valence)": round(best.t_val, 4),
            "(1-qais_score)": round(best.t_novelty, 4),
            "|g-p|": round(best.t_imbal, 4),
            "(1-E)": round(best.t_E, 4),
            "bias": round(best.t_bias, 4)
        },
        "G_thresholds": {
            "S_thresh": round(best.g_s_thresh, 4),
            "T_thresh": round(best.g_t_thresh, 4)
        },
        "V": "passthrough from Claude (no computation)"
    }
    
    with open("limbic_genome.json", "w") as f:
        json.dump(result, f, indent=2)
    
    print(f"\n\nGenome saved to limbic_genome.json")
    print("Fitness: {:.6f}".format(score))
    print("\nğŸ”¥ Done.")
</file>

<file path="ISS/README.md">
# ISS â€” Invariant Semantic Substrate

**Universal semantic forces for reasoning, gap detection, and task biasing.**

> Meaning is expressed as semantic forces, not categories.

---

## What ISS Does

ISS projects any text into a semantic state with four components:

| Component | Symbol | Meaning |
|-----------|--------|---------|
| **Mechanistic** | `g` | How strongly text describes mechanisms, processes, operations |
| **Prescriptive** | `p` | How strongly text implies norms, rules, principles |
| **Explanatory** | `E` | Coherence between mechanism and principle (emergent) |
| **Residual** | `r` | Preserved ambiguity, edge meaning, compressed doctrine |

From these, ISS computes **Gap Pressure** â€” semantic imbalance that reveals where meaning is incomplete:

```
Gap(x) = Î±â€–râ€– + Î²|â€–gâ€–-â€–pâ€–| + Î³(1-E)
```

---

## Quickstart

```python
import numpy as np

# Load trained projections
proj = np.load('iss_projections_st.npz')  # or iss_projections.npz for QAIS-hash
P_G, P_P = proj['P_G'], proj['P_P']

# Your embedding function (sentence-transformers or QAIS-hash)
from sentence_transformers import SentenceTransformer
model = SentenceTransformer('all-MiniLM-L6-v2')

def analyze(text):
    x = model.encode(text, normalize_embeddings=True)
    g = x @ P_G
    p = x @ P_P
    
    g_norm = np.linalg.norm(g)
    p_norm = np.linalg.norm(p)
    E = np.dot(g, p) / (g_norm * p_norm + 1e-8)
    
    print(f"||g|| = {g_norm:.3f}  (mechanistic)")
    print(f"||p|| = {p_norm:.3f}  (prescriptive)")
    print(f"g-p   = {g_norm - p_norm:+.3f}  (imbalance)")
    print(f"E     = {E:.3f}  (explanatory coherence)")

# Test
analyze("The function hashes the input and returns a digest.")
# â†’ g > p (mechanistic)

analyze("Always validate input before processing.")
# â†’ p > g (prescriptive)
```

---

## Files

| File | Purpose |
|------|---------|
| `SPEC.md` | Full specification with appendices |
| `iss_prototype.py` | Complete runtime implementation |
| `iss_train.py` | Training script (QAIS-hash embeddings) |
| `iss_train_st.py` | Training script (Sentence-Transformers) |
| `iss_projections.npz` | Trained weights (QAIS-hash, 512d â†’ 64d) |
| `iss_projections_st.npz` | Trained weights (ST, 384d â†’ 64d) |

---

## Design Laws

**These are non-negotiable:**

1. **No task assumptions** â€” Model never encodes task labels or domain ontologies
2. **Projections are frozen** â€” Never retrain per task, domain, or user feedback
3. **Residuals are signal** â€” Ambiguity is preserved structure, not noise
4. **Bias only via Î›** â€” Task specialization through weighting, not projection changes

---

## Task Bias

Specialize without retraining:

```python
# Task bias vector
Î› = (Î»_G, Î»_P, Î»_E, Î»_R)

# Task-conditioned score
S = Î»_G * ||g|| + Î»_P * ||p|| + Î»_E * E + Î»_R * ||r||

# Example biases:
MECHANISM_FOCUS = (2.0, 0.5, 1.0, 0.5)  # Emphasize how things work
PRINCIPLE_FOCUS = (0.5, 2.0, 1.0, 0.5)  # Emphasize rules and norms
AMBIGUITY_PRESERVE = (0.5, 0.5, 0.5, 2.0)  # Keep nuance
```

---

## Gap Detection

ISS replaces vocabulary-based gap scanning with field imbalance:

| Signal | Meaning |
|--------|---------|
| High `â€–râ€–` | Meaning not crystallized |
| `g â‰« p` | Mechanism without guiding principle |
| `p â‰« g` | Doctrine without grounding |
| Low `E` | Explanatory incoherence |

---

## Embedding Independence

ISS works with any embedding that preserves meaning:

| Embedding | G Separation | P Separation |
|-----------|--------------|--------------|
| QAIS-hash (deterministic) | 1.5x | 1.5x |
| Sentence-Transformers | **2.9x** | **3.7x** |

Real semantic embeddings amplify the signal 4-6x. The axes are universal.

---

## Training Your Own

If you want to train on a different corpus:

```bash
# Edit G_CORPUS and P_CORPUS in iss_train_st.py
# Then run:
python iss_train_st.py

# Outputs: iss_projections_st.npz
```

**Corpus rules:**
- ~40 mechanistic sentences (how things work)
- ~40 prescriptive sentences (what one should do)
- Mixed domains â€” no task labels, no domain labels
- Never "abstract vs literal" â€” only mechanism vs prescription

---

## QAIS Integration (Optional)

ISS and QAIS are siblings, not dependencies. Use together:

```python
# Store fact with ISS annotations
def store_with_semantics(identity, role, fact):
    # QAIS storage
    v = seed_to_vector(fact)
    field[role] += bind(identity, v)
    
    # ISS annotation
    state = invariant_semantic_pass(fact)
    meta[identity][role].append({
        "G": state.g_norm,
        "P": state.p_norm,
        "E": state.E,
        "gap": state.gap
    })
```

---

## What ISS Does That Most Systems Can't

- Preserve ambiguity without losing rigor
- Specialize without retraining
- Detect gaps without vocabulary scanning
- Explain without classification

---

## Origin

B66: Universal Semantic Forces  
J-Dub & Claude | BOND Protocol | 2026-02-02

> Universal semantic forces are sufficient to replace task labels, ontologies, and gap scanners.

ğŸ”¥ğŸŒŠ
</file>

<file path="ISS/SPEC.md">
# ISS â€” Invariant Semantic Substrate  
## Unified Model for Universal Reasoning, Gap Detection, and Task Biasing

**Status:** Invariant Core Specification  
**Audience:** Claude-class Transformer Systems  
**Version:** 1.0  
**Date:** 2026-02-01  
**Repository Context:** BOND / QAIS Integration  

---

## 0. Design Law (Non-Negotiable)

> **The model must not encode task assumptions.**

This implies:

- No task labels  
- No domain ontologies  
- No abstract / literal classification  
- No sentence typing  
- No retraining per task  

All specialization must occur **after** invariant projection via biasing only.

---

## 1. Core Principle

> **Meaning is expressed as semantic forces, not categories.**

Every utterance contains:
- a description of how something works
- an implication of how one should act or design
- an attempt (successful or not) to explain why something is so

These forces exist in all domains and must be represented geometrically.

---

## 2. Invariant Semantic Projections

Given input text `t`:

$$
x = f_\theta(t) \in \mathbb{R}^d
$$

Where `f_Î¸` is a general contextual embedding model.

### 2.1 Mechanistic Projection (G)

$$
g = P_G(x) \in \mathbb{R}^k
$$

Represents **how strongly the text describes mechanisms, processes, or operations**.

### 2.2 Prescriptive Projection (P)

$$
p = P_P(x) \in \mathbb{R}^k
$$

Represents **how strongly the text implies norms, rules, principles, or design intent**.

> `P_G` and `P_P` are linear or shallow nonlinear projections trained only on sentence role, never domain.

---

## 3. Emergent Explanatory Elevation (E)

> **E is never predicted directly.**

It emerges from interaction:

$$
E(x) = \cos(g, p)
$$

Interpretation:

- High `E` â†’ coherent explanation (mechanism aligned with principle)
- Low `E` â†’ explanatory strain or doctrinal mismatch

---

## 4. Residual Preservation (Mandatory)

No semantic collapse is allowed.

$$
r = x - (P_G^\dagger g + P_P^\dagger p)
$$

The residual:

- preserves edge meaning
- preserves ambiguity
- preserves compressed doctrine
- preserves future reinterpretability

> **Residuals are signal, not noise.**

---

## 5. Canonical Semantic State

For every text span, Claude must internally carry:

$$
\boxed{(g,\; p,\; E,\; r)}
$$

These are **never discarded**, regardless of task.

---

## 6. Task Specialization via Bias (No Retraining)

A task is defined only as a weighting vector:

$$
\Lambda_T = (\lambda_G,\; \lambda_P,\; \lambda_E,\; \lambda_R)
$$

Task-conditioned score:

$$
S_T(x) =
\lambda_G \|g\| +
\lambda_P \|p\| +
\lambda_E E(x) +
\lambda_R \|r\|
$$

Uses:
- attention weighting
- ranking
- emphasis during generation

> Tasks **must not** modify projections or embeddings.

---

## 7. Unified Gap Detection (JA Eliminated)

### 7.1 Definition

A **gap** is semantic imbalance, not missing vocabulary.

Define **Invariant Gap Pressure**:

$$
\text{Gap}(x) =
\alpha \|r\|
+ \beta |\|g\| - \|p\||
+ \gamma (1 - E(x))
$$

### 7.2 Interpretation

| Signal | Meaning |
|------|--------|
| High `â€–râ€–` | Meaning not crystallized |
| `g â‰« p` | Mechanism without guiding principle |
| `p â‰« g` | Doctrine without grounding |
| Low `E` | Explanatory incoherence |

This **fully replaces JA / JA+**.  
No vocabulary waves.  
No clustering heuristics.  
No genetic tuning.

---

## 8. Required Claude Reasoning Loop

Claude must reason **through projections**, not labels.

### Canonical Loop

1. Embed text  
2. Project to `g`, `p`  
3. Compute `E`, `r`  
4. Compute Gap pressure  
5. Apply task bias `Î›_T`  
6. Generate response conditioned on weighted fields  

---

## 9. Generation Policy (Implicit)

During output synthesis:

- High `g` â†’ emphasize mechanisms and operations  
- High `p` â†’ emphasize principles and constraints  
- High `r` â†’ preserve nuance and ambiguity  
- High `Gap` â†’ explicitly surface missing structure or tension  

Claude **must explain imbalance**, not classify content.

---

## 10. QAIS Integration (Non-Destructive)

QAIS memory remains unchanged.

Invariant semantics are **annotations**, not stored vectors.

Example:

```python
store(identity, role, fact):
    v = seed_to_vector(fact)
    semantics = invariant_semantic_pass(fact, neutral_lambda)
    field[role] += bind(identity, v)

    meta[identity][role].append({
        "G": norm(semantics.g),
        "P": norm(semantics.p),
        "E": semantics.E,
        "R": norm(semantics.r),
        "gap": semantics.gap
    })
```

Gap detection becomes a sort operation, not a scan.

---

## 11. Prohibitions (Hard Constraints)

Claude must never:

- classify sentences into types
- label text as abstract or literal
- embed task assumptions into representations
- discard residuals
- treat ambiguity as error

Ambiguity is preserved structure.

---

## 12. Final Design Law

> If gap detection requires a separate system, the invariant core is incomplete.

This specification defines a unified, domain-agnostic semantic substrate that:

- remains universal
- supports task specificity via bias
- preserves doctrinal compression
- detects gaps continuously
- integrates cleanly with QAIS

---

**End of Invariant Specification**

---

## Appendix A: Projection Matrix Invariance

### A.1 Training Protocol

Projection matrices `P_G` and `P_P` are trained **once** on a mixed-domain corpus:

- ~40 mechanistic sentences (how things work)
- ~40 prescriptive sentences (what one should do)
- No task labels, no domain labels, no abstract/literal classification

### A.2 Invariance Constraint

Once trained, projections are **frozen permanently**:

- Never retrain per task
- Never fine-tune per domain
- Never modify based on user feedback

These are **global semantic axes**, like gravity. They define the coordinate system in which all meaning is expressed.

### A.3 Rationale

If projections were task-dependent, the model would encode task assumptions â€” violating Design Law Â§0.

The entire power of ISS comes from this invariance:

- Same projections for code review and poetry
- Same projections for legal contracts and casual chat
- Same projections for physics explanations and moral arguments

Specialization happens **only** through the task bias Î›, never through the projections themselves.

---

## Appendix B: Embedding Independence Proof

### B.1 Experiment

To verify that G/P separation is not an artifact of the embedding method, ISS was tested with two fundamentally different embedding approaches:

| Method | Mechanism | Dimension |
|--------|-----------|----------|
| QAIS-hash | SHA512 â†’ RNG seed â†’ bipolar vector | 512 |
| Sentence-Transformers | all-MiniLM-L6-v2 (learned) | 384 |

### B.2 Results

| Embedding | P_G Separation | P_P Separation | G Ratio | P Ratio |
|-----------|----------------|----------------|---------|--------|
| QAIS-hash | +0.098 | +0.092 | 1.5x | 1.5x |
| Sentence-Transformers | **+0.397** | **+0.606** | **2.9x** | **3.7x** |

### B.3 Interpretation

Real semantic embeddings don't just preserve the signal â€” they **amplify it 4-6x**.

This confirms:

1. **G/P are real semantic axes**, not artifacts of hashing
2. **The structure exists in language itself**, not in any particular embedding method
3. **Learned embeddings capture more of this structure** than random projections

### B.4 Held-Out Validation

| Sentence | Expected | g-p | Result |
|----------|----------|-----|--------|
| "The function hashes the input..." | MECH | +0.389 | âœ“ G > P |
| "You must validate input..." | PRESC | -0.620 | âœ“ P > G |
| "Store operations, not positions." | PRESC | -0.345 | âœ“ P > G |
| "SHA512 produces a 512-bit hash." | MECH | +0.323 | âœ“ G > P |
| "We derive instead of storing because..." | EXPL | -0.697 | P > G (prescriptive framing) |

Note: The explanatory sentence leans prescriptive because "because it eliminates sync bugs" frames a *reason to prefer* (prescription), not a *mechanism of operation*.

### B.5 Conclusion

> **G/P separation is embedding-independent.**
>
> The axes are universal properties of semantic structure, discoverable by any embedding method that preserves meaning.

Files: `iss_train_st.py`, `iss_projections_st.npz`

---

ğŸ”¥ğŸŒŠ J-Dub & Claude | BOND Protocol
</file>

<file path="panel/server.js">
// BOND Control Panel â€” Express Sidecar
// Serves: React app (production) + Doctrine filesystem API + Clipboard bridge
// Port: 3000

import express from 'express';
import cors from 'cors';
import { readdir, readFile, writeFile, stat, mkdir } from 'fs/promises';
import { existsSync } from 'fs';
import { join, resolve } from 'path';
import { createServer } from 'http';
import { execFile } from 'child_process';
import { promisify } from 'util';

const execFileAsync = promisify(execFile);

const app = express();
app.use(cors());
app.use(express.json());

// â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOND_ROOT = resolve(process.env.BOND_ROOT
  || join(process.cwd(), '..'));
const DOCTRINE_PATH = resolve(process.env.DOCTRINE_PATH
  || join(BOND_ROOT, 'doctrine'));
const STATE_PATH = resolve(process.env.STATE_PATH
  || join(BOND_ROOT, 'state'));
const PORT = process.env.PORT || 3000;
const MCP_URL = process.env.MCP_URL || 'http://localhost:3002';

// â”€â”€â”€ Doctrine Filesystem API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// List all entity folders
app.get('/api/doctrine', async (req, res) => {
  try {
    const entries = await readdir(DOCTRINE_PATH, { withFileTypes: true });
    const entities = [];

    for (const entry of entries) {
      if (!entry.isDirectory()) continue;
      const entityPath = join(DOCTRINE_PATH, entry.name);
      const files = await readdir(entityPath);
      const mdFiles = files.filter(f => f.endsWith('.md'));

      // Classify files: bare name = doctrine/seed, G-prefix = growth
      const growth = mdFiles.filter(f => f.match(/^G-|^.*-G\d/));
      const seeds = mdFiles.filter(f => !f.match(/^G-|^.*-G\d/));

      // Read entity.json for classification (B69: Four-Class Architecture)
      let entityConfig = {};
      try {
        const configRaw = await readFile(join(entityPath, 'entity.json'), 'utf-8');
        entityConfig = JSON.parse(configRaw);
      } catch {
        // Fallback: folder name heuristic
        entityConfig = {
          class: entry.name.startsWith('_') ? 'library'
            : /^P\d/.test(entry.name) ? 'perspective'
            : 'doctrine',
          tools: {}
        };
      }

      const type = entityConfig.class || 'doctrine';

      // Class tool defaults (B69)
      const CLASS_TOOLS = {
        doctrine:    { filesystem: true, iss: true, qais: false, heatmap: false, crystal: false },
        project:     { filesystem: true, iss: true, qais: true, heatmap: true, crystal: true },
        perspective: { filesystem: true, iss: false, qais: true, heatmap: true, crystal: true },
        library:     { filesystem: true, iss: false, qais: false, heatmap: false, crystal: false },
      };

      const defaults = CLASS_TOOLS[type] || CLASS_TOOLS.library;
      const tools = { ...defaults, ...(entityConfig.tools || {}) };
      // Enforce class boundaries â€” can only toggle what the class allows
      const allowed = CLASS_TOOLS[type] || {};
      for (const key of Object.keys(tools)) {
        if (allowed[key] === false) tools[key] = false;
      }

      entities.push({
        name: entry.name,
        display_name: entityConfig.display_name || null,
        files: mdFiles,
        type,
        tools,
        core: entityConfig.core || null,
        doctrine_count: (type === 'doctrine' || type === 'project') ? seeds.length : 0,
        seed_count: type === 'perspective' ? seeds.length : 0,
        growth_count: growth.length,
      });
    }

    res.json({ entities, doctrine_path: DOCTRINE_PATH });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// List files in entity folder
app.get('/api/doctrine/:entity', async (req, res) => {
  try {
    const entityPath = join(DOCTRINE_PATH, req.params.entity);
    // Guard against path traversal
    const resolved = resolve(entityPath);
    if (!resolved.startsWith(resolve(DOCTRINE_PATH))) {
      return res.status(403).json({ error: 'Access denied' });
    }

    const files = await readdir(entityPath);
    const mdFiles = files.filter(f => f.endsWith('.md'));

    const fileDetails = await Promise.all(mdFiles.map(async (f) => {
      const filePath = join(entityPath, f);
      const info = await stat(filePath);
      const isGrowth = !!f.match(/^G-|^.*-G\d/);
      return {
        name: f,
        size: info.size,
        modified: info.mtime,
        type: isGrowth ? 'growth' : 'doctrine'
      };
    }));

    res.json({ entity: req.params.entity, files: fileDetails });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Update entity tool toggles (B69)
app.put('/api/doctrine/:entity/tools', async (req, res) => {
  try {
    const entityPath = join(DOCTRINE_PATH, req.params.entity);
    const resolved = resolve(entityPath);
    if (!resolved.startsWith(resolve(DOCTRINE_PATH))) {
      return res.status(403).json({ error: 'Access denied' });
    }
    const configPath = join(entityPath, 'entity.json');
    let config = {};
    try {
      config = JSON.parse(await readFile(configPath, 'utf-8'));
    } catch { /* new config */ }

    // Merge only allowed tools for this class
    const CLASS_TOOLS = {
      doctrine:    { filesystem: true, iss: true, qais: false, heatmap: false, crystal: false },
      project:     { filesystem: true, iss: true, qais: true, heatmap: true, crystal: true },
      perspective: { filesystem: true, iss: false, qais: true, heatmap: true, crystal: true },
      library:     { filesystem: true, iss: false, qais: false, heatmap: false, crystal: false },
    };
    const type = config.class || 'doctrine';
    const allowed = CLASS_TOOLS[type] || {};
    const incoming = req.body.tools || {};
    const tools = { ...(config.tools || {}) };
    for (const [key, val] of Object.entries(incoming)) {
      if (allowed[key] !== false) tools[key] = val;
    }
    config.tools = tools;

    await writeFile(configPath, JSON.stringify(config, null, 2) + '\n');
    res.json({ saved: true, tools });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Update entity display name
app.put('/api/doctrine/:entity/name', async (req, res) => {
  try {
    const entityPath = join(DOCTRINE_PATH, req.params.entity);
    const resolved = resolve(entityPath);
    if (!resolved.startsWith(resolve(DOCTRINE_PATH))) {
      return res.status(403).json({ error: 'Access denied' });
    }
    const configPath = join(entityPath, 'entity.json');
    let config = {};
    try {
      config = JSON.parse(await readFile(configPath, 'utf-8'));
    } catch { /* new config */ }

    const { display_name } = req.body;
    if (display_name === null || display_name === '') {
      delete config.display_name;
    } else {
      config.display_name = display_name;
    }

    await writeFile(configPath, JSON.stringify(config, null, 2) + '\n');
    res.json({ saved: true, display_name: config.display_name || null });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Create new entity (B69 Four-Class)
const STARTER_CONTENT = {
  doctrine: (name) => `# ${name}\n\n<!-- Doctrine: IS statements. Static truth. -->\n`,
  project: (name) => `# ${name} â€” CORE\n\n<!-- Project CORE: immutable boundary. Define scope and constraints. -->\n`,
  perspective: (name) => `# ${name}\n\n<!-- Perspective seed. This file will grow through resonance. -->\n`,
  library: (name) => `# ${name}\n\n<!-- Library reference. Read-only knowledge. -->\n`,
};

const STARTER_FILENAME = {
  doctrine: (code) => `${code}-root.md`,
  project: () => 'CORE.md',
  perspective: () => 'seed.md',
  library: () => 'index.md',
};

app.post('/api/doctrine', async (req, res) => {
  try {
    const { name, class: entityClass } = req.body;
    if (!name || !entityClass) {
      return res.status(400).json({ error: 'name and class required' });
    }
    const validClasses = ['doctrine', 'project', 'perspective', 'library'];
    if (!validClasses.includes(entityClass)) {
      return res.status(400).json({ error: `class must be one of: ${validClasses.join(', ')}` });
    }
    // Sanitize folder name
    const safeName = name.replace(/[^a-zA-Z0-9_-]/g, '');
    if (!safeName) {
      return res.status(400).json({ error: 'Invalid name after sanitization' });
    }
    const entityPath = join(DOCTRINE_PATH, safeName);
    const resolved = resolve(entityPath);
    if (!resolved.startsWith(resolve(DOCTRINE_PATH))) {
      return res.status(403).json({ error: 'Access denied' });
    }
    // Check if already exists
    try {
      await stat(entityPath);
      return res.status(409).json({ error: `Entity '${safeName}' already exists` });
    } catch { /* good â€” doesn't exist */ }

    // Create folder
    await mkdir(entityPath, { recursive: true });

    // Write entity.json
    const config = { class: entityClass };
    if (entityClass === 'project') config.core = 'CORE.md';
    await writeFile(
      join(entityPath, 'entity.json'),
      JSON.stringify(config, null, 2) + '\n'
    );

    // Write starter file
    const code = safeName.substring(0, 4).toUpperCase();
    const starterName = STARTER_FILENAME[entityClass](code);
    const starterContent = STARTER_CONTENT[entityClass](safeName);
    await writeFile(join(entityPath, starterName), starterContent);

    console.log(`âœ¨ Created ${entityClass}: ${safeName}`);
    res.json({ created: true, name: safeName, class: entityClass, files: ['entity.json', starterName] });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Return file content
app.get('/api/doctrine/:entity/:file', async (req, res) => {
  try {
    const filePath = join(DOCTRINE_PATH, req.params.entity, req.params.file);
    // Guard against path traversal
    const resolved = resolve(filePath);
    if (!resolved.startsWith(resolve(DOCTRINE_PATH))) {
      return res.status(403).json({ error: 'Access denied' });
    }

    const content = await readFile(filePath, 'utf-8');
    const isGrowth = !!req.params.file.match(/^G-|^.*-G\d/);

    res.json({
      file: req.params.file,
      entity: req.params.entity,
      type: isGrowth ? 'growth' : 'doctrine',
      content
    });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// â”€â”€â”€ MCP Stats Proxy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MCP_STATS_SCRIPT = join(process.cwd(), 'mcp_stats.py');

async function getMcpStats(system) {
  try {
    const { stdout } = await execFileAsync('python', [MCP_STATS_SCRIPT, system], {
      timeout: 5000,
      cwd: process.cwd(),
    });
    return JSON.parse(stdout);
  } catch (err) {
    return { status: 'offline', error: err.message };
  }
}

// Individual system endpoints (what module cards poll)
app.get('/api/mcp/:system/stats', async (req, res) => {
  const data = await getMcpStats(req.params.system);
  if (data.status === 'offline' || data.error) {
    res.status(503).json(data);
  } else {
    res.json(data);
  }
});

// Also serve as /status for modules that use that
app.get('/api/mcp/:system/status', async (req, res) => {
  const data = await getMcpStats(req.params.system);
  if (data.status === 'offline' || data.error) {
    res.status(503).json(data);
  } else {
    res.json(data);
  }
});

// All systems at once
app.get('/api/mcp/all', async (req, res) => {
  const data = await getMcpStats('all');
  res.json(data);
});

// â”€â”€â”€ MCP Tool Invocation (S4) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MCP_INVOKE_SCRIPT = join(process.cwd(), 'mcp_invoke.py');

app.post('/api/mcp/:system/invoke', async (req, res) => {
  const { system } = req.params;
  const { tool, input } = req.body;
  if (!tool) return res.status(400).json({ error: 'tool required' });

  try {
    const { stdout, stderr } = await execFileAsync('python', [
      MCP_INVOKE_SCRIPT, system, tool, input || ''
    ], { timeout: 15000, cwd: process.cwd() });

    try {
      res.json(JSON.parse(stdout));
    } catch {
      res.json({ raw: stdout, stderr: stderr || null });
    }
  } catch (err) {
    res.status(503).json({ error: err.message, stderr: err.stderr || null });
  }
});

// â”€â”€â”€ Module Configs API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MODULES_PATH = join(process.cwd(), 'modules');

app.get('/api/modules', async (req, res) => {
  try {
    const files = await readdir(MODULES_PATH);
    const modules = [];
    for (const f of files) {
      if (!f.endsWith('.json')) continue;
      const content = await readFile(join(MODULES_PATH, f), 'utf-8');
      try { modules.push(JSON.parse(content)); } catch { /* skip bad json */ }
    }
    res.json({ modules });
  } catch (err) {
    res.json({ modules: [] });
  }
});

// Panel config
app.get('/api/config', (req, res) => {
  res.json({
    doctrine_path: DOCTRINE_PATH,
    state_path: STATE_PATH,
    mcp_url: MCP_URL,
    ws_port: 3001,
    version: '1.3.0-s86'
  });
});

// â”€â”€â”€ Entity State API (Enter-Mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATE_FILE = join(STATE_PATH, 'active_entity.json');
const NULL_STATE = { entity: null, class: null, path: null, entered: null };
const MASTER_ENTITY = 'BOND_MASTER';

// Hub-and-spoke link hydration: BOND_MASTER is the only entity that links.
// Links array lives in BOND_MASTER/entity.json â€” single source of truth.
async function hydrateLinks() {
  try {
    const masterConfig = JSON.parse(
      await readFile(join(DOCTRINE_PATH, MASTER_ENTITY, 'entity.json'), 'utf-8')
    );
    const linkNames = masterConfig.links || [];
    const links = [];
    for (const name of linkNames) {
      try {
        const targetPath = join(DOCTRINE_PATH, name);
        const targetConfig = JSON.parse(
          await readFile(join(targetPath, 'entity.json'), 'utf-8')
        );
        links.push({
          entity: name,
          class: targetConfig.class || 'library',
          display_name: targetConfig.display_name || null,
          path: resolve(targetPath),
        });
      } catch {
        // Linked entity missing â€” skip silently
      }
    }
    return links;
  } catch {
    return [];
  }
}

// Read current state â€” hydrates links from BOND_MASTER entity.json
app.get('/api/state', async (req, res) => {
  try {
    const raw = await readFile(STATE_FILE, 'utf-8');
    const state = JSON.parse(raw);
    // Hydrate links from hub when BOND_MASTER is active
    if (state.entity === MASTER_ENTITY) {
      state.links = await hydrateLinks();
    } else {
      state.links = [];
    }
    res.json(state);
  } catch {
    res.json({ ...NULL_STATE, links: [] });
  }
});

// Enter entity â€” write state file
app.post('/api/state/enter', async (req, res) => {
  const { entity } = req.body;
  if (!entity) return res.status(400).json({ error: 'entity required' });

  try {
    // Look up entity config
    const entityPath = join(DOCTRINE_PATH, entity);
    const resolved = resolve(entityPath);
    if (!resolved.startsWith(resolve(DOCTRINE_PATH))) {
      return res.status(403).json({ error: 'Access denied' });
    }

    let entityConfig = {};
    try {
      entityConfig = JSON.parse(await readFile(join(entityPath, 'entity.json'), 'utf-8'));
    } catch {
      return res.status(404).json({ error: `Entity '${entity}' not found or missing entity.json` });
    }

    // Write state file FIRST (Claude reads this on {Sync})
    const state = {
      entity,
      class: entityConfig.class || 'doctrine',
      display_name: entityConfig.display_name || null,
      path: resolved,
      entered: new Date().toISOString()
    };
    await writeFile(STATE_FILE, JSON.stringify(state, null, 2) + '\n');

    // Hydrate links if entering BOND_MASTER
    if (entity === MASTER_ENTITY) {
      state.links = await hydrateLinks();
    } else {
      state.links = [];
    }

    // Bridge: panel clipboard handles {Enter} command (App.jsx)
    console.log(`ğŸ”“ Entered: ${entity} (${state.class})`);
    res.json({ entered: true, state });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Exit entity â€” clear state file
app.post('/api/state/exit', async (req, res) => {
  try {
    // Read current before clearing (for logging)
    let prev = NULL_STATE;
    try { prev = JSON.parse(await readFile(STATE_FILE, 'utf-8')); } catch {}

    // Clear state file
    await writeFile(STATE_FILE, JSON.stringify(NULL_STATE, null, 2) + '\n');

    // Bridge: panel clipboard handles {Exit} command (App.jsx)
    if (prev.entity) {
      console.log(`ğŸ”’ Exited: ${prev.entity}`);
    }
    res.json({ exited: true, previous: prev.entity });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Link entity â€” BOND_MASTER hub-and-spoke. Persists to entity.json.
app.post('/api/state/link', async (req, res) => {
  try {
    const { entity: linkTarget } = req.body;
    if (!linkTarget) return res.status(400).json({ error: 'entity required' });

    // Read current state
    let state;
    try { state = JSON.parse(await readFile(STATE_FILE, 'utf-8')); } catch {
      return res.status(400).json({ error: 'No active entity' });
    }

    // Only BOND_MASTER can link
    if (state.entity !== MASTER_ENTITY) {
      return res.status(403).json({ error: 'Only BOND_MASTER can link entities' });
    }

    // Cannot link to self
    if (linkTarget === MASTER_ENTITY) {
      return res.status(400).json({ error: 'Cannot link to self' });
    }

    // Verify target exists
    const targetPath = join(DOCTRINE_PATH, linkTarget);
    const resolved = resolve(targetPath);
    if (!resolved.startsWith(resolve(DOCTRINE_PATH))) {
      return res.status(403).json({ error: 'Access denied' });
    }
    try {
      await readFile(join(targetPath, 'entity.json'), 'utf-8');
    } catch {
      return res.status(404).json({ error: `Entity '${linkTarget}' not found` });
    }

    // Persist to BOND_MASTER entity.json (source of truth)
    const masterConfigPath = join(DOCTRINE_PATH, MASTER_ENTITY, 'entity.json');
    const masterConfig = JSON.parse(await readFile(masterConfigPath, 'utf-8'));
    const links = masterConfig.links || [];
    if (!links.includes(linkTarget)) {
      links.push(linkTarget);
      masterConfig.links = links;
      await writeFile(masterConfigPath, JSON.stringify(masterConfig, null, 2) + '\n');
    }

    // Hydrate full link objects for response
    state.links = await hydrateLinks();

    console.log(`ğŸ”— Linked: ${MASTER_ENTITY} â†’ ${linkTarget}`);
    res.json({ linked: true, state });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Unlink entity â€” remove from BOND_MASTER hub. Persists to entity.json.
app.post('/api/state/unlink', async (req, res) => {
  try {
    const { entity: unlinkTarget } = req.body;
    if (!unlinkTarget) return res.status(400).json({ error: 'entity required' });

    // Read current state
    let state;
    try { state = JSON.parse(await readFile(STATE_FILE, 'utf-8')); } catch {
      return res.status(400).json({ error: 'No active entity' });
    }

    if (state.entity !== MASTER_ENTITY) {
      return res.status(403).json({ error: 'Only BOND_MASTER can unlink entities' });
    }

    // Remove from BOND_MASTER entity.json (source of truth)
    const masterConfigPath = join(DOCTRINE_PATH, MASTER_ENTITY, 'entity.json');
    const masterConfig = JSON.parse(await readFile(masterConfigPath, 'utf-8'));
    masterConfig.links = (masterConfig.links || []).filter(n => n !== unlinkTarget);
    await writeFile(masterConfigPath, JSON.stringify(masterConfig, null, 2) + '\n');

    // Hydrate remaining links
    state.links = await hydrateLinks();

    console.log(`ğŸ”“ Unlinked: ${unlinkTarget}`);
    res.json({ unlinked: true, previous: unlinkTarget, state });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// â”€â”€â”€ Bridge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Clipboard-only. Panel writes "BOND:{cmd}" â†’ AHK OnClipboardChange.
// HTTP bridge removed S85 (Dead Code Audit).

// â”€â”€â”€ Production static serving â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIST_PATH = join(process.cwd(), 'dist');
if (existsSync(DIST_PATH)) {
  app.use(express.static(DIST_PATH));
  app.get('*', (req, res) => {
    if (!req.path.startsWith('/api/')) {
      res.sendFile(join(DIST_PATH, 'index.html'));
    }
  });
  console.log('   Serving built panel from dist/');
}

// â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const server = createServer(app);

server.listen(PORT, () => {
  console.log(`ğŸ”¥ğŸŒŠ BOND Panel sidecar on http://localhost:${PORT}`);
  console.log(`   Doctrine path: ${DOCTRINE_PATH}`);
  console.log(`   MCP target:    ${MCP_URL}`);
});

export { server };
</file>

<file path="panel/src/App.jsx">
// BOND Control Panel â€” App Shell
// B69: Four-Class Entity Architecture

import { useState, useEffect, useCallback } from 'react';
import Header from './components/Header';
import CommandBar from './components/CommandBar';
import SystemStatus from './components/SystemStatus';
import ModuleBay from './components/ModuleBay';
import EntityCards from './components/EntityCards';
import DoctrineViewer from './components/DoctrineViewer';
import CreateEntity from './components/CreateEntity';
import EntityBar from './components/EntityBar';
import DoctrineBanner from './components/DoctrineBanner';
import { useEntities } from './hooks/useDoctrine';
// useBridge removed S85 (Dead Code Audit) â€” clipboard is native in App.jsx
import { useModules } from './hooks/useModules';
import './styles/bond.css';

const TABS = [
  { id: 'doctrine',     label: 'Doctrine',     icon: 'ğŸ“œ', filter: 'doctrine' },
  { id: 'projects',     label: 'Projects',     icon: 'âš’ï¸', filter: 'project' },
  { id: 'perspectives', label: 'Perspectives', icon: 'ğŸ”­', filter: 'perspective' },
  { id: 'library',      label: 'Library',      icon: 'ğŸ“š', filter: 'library' },
  { id: 'systems',      label: 'Systems',      icon: 'âš™ï¸', filter: null },
  { id: 'viewer',       label: 'Viewer',       icon: 'ğŸ“–', filter: null },
];

// Uses Vite proxy in dev, relative in prod

export default function App() {
  const [activeTab, setActiveTab] = useState('doctrine');
  const [viewerTarget, setViewerTarget] = useState(null);
  const [activeEntity, setActiveEntity] = useState(null);
  const [linkedEntities, setLinkedEntities] = useState([]);
  const [loadedEntities, setLoadedEntities] = useState(() => {
    try { return JSON.parse(localStorage.getItem('bond_loaded') || '[]'); }
    catch { return []; }
  });

  const { entities, loading, error, refresh } = useEntities();
  const { modules } = useModules();

  // Load active entity state from server on mount
  useEffect(() => {
    fetch('/api/state').then(r => r.json()).then(state => {
      if (state.entity) {
        setActiveEntity({ name: state.entity, type: state.class, display_name: state.display_name });
      }
      if (state.links && state.links.length > 0) {
        setLinkedEntities(state.links.map(l => ({ name: l.entity, type: l.class, display_name: l.display_name })));
      }
    }).catch(() => {});
  }, []);

  useEffect(() => {
    localStorage.setItem('bond_loaded', JSON.stringify(loadedEntities));
  }, [loadedEntities]);

  // â”€â”€â”€ Entity actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const handleView = useCallback((entity) => {
    setViewerTarget(entity.name);
    setActiveTab('viewer');
  }, []);

  const handleLoad = useCallback((entity) => {
    setLoadedEntities(prev => {
      if (prev.includes(entity.name)) return prev;
      return [...prev, entity.name];
    });
  }, []);

  const handleEnter = useCallback(async (entity) => {
    try {
      const res = await fetch('/api/state/enter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ entity: entity.name }),
      });
      const data = await res.json();
      if (data.entered) {
        handleLoad(entity);
        setActiveEntity({ name: entity.name, type: entity.type, display_name: entity.display_name });
        // Hydrate links from server response
        if (data.state?.links?.length > 0) {
          setLinkedEntities(data.state.links.map(l => ({ name: l.entity, type: l.class, display_name: l.display_name })));
        } else {
          setLinkedEntities([]);
        }
        setViewerTarget(entity.name);
        setActiveTab('viewer');
        try { await navigator.clipboard.writeText(`BOND:{Enter ${entity.name}}`); } catch {}
      }
    } catch (err) {
      console.error('Enter failed:', err);
    }
  }, [handleLoad]);

  const handleExit = useCallback(async () => {
    try {
      await fetch('/api/state/exit', { method: 'POST' });
      setActiveEntity(null);
      setLinkedEntities([]);
      try { await navigator.clipboard.writeText('BOND:{Exit}'); } catch {}
    } catch (err) {
      console.error('Exit failed:', err);
    }
  }, []);

  const handleLink = useCallback(async (entity) => {
    try {
      const res = await fetch('/api/state/link', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ entity: entity.name }),
      });
      const data = await res.json();
      if (data.linked && data.state?.links) {
        setLinkedEntities(data.state.links.map(l => ({ name: l.entity, type: l.class, display_name: l.display_name })));
      }
    } catch (err) {
      console.error('Link failed:', err);
    }
  }, []);

  const handleUnlink = useCallback(async (entityName) => {
    try {
      const res = await fetch('/api/state/unlink', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ entity: entityName }),
      });
      const data = await res.json();
      if (data.unlinked && data.state?.links) {
        setLinkedEntities(data.state.links.map(l => ({ name: l.entity, type: l.class, display_name: l.display_name })));
      } else if (data.unlinked) {
        setLinkedEntities(prev => prev.filter(e => e.name !== entityName));
      }
    } catch (err) {
      console.error('Unlink failed:', err);
    }
  }, []);

  const handleUnload = useCallback((entityName) => {
    setLoadedEntities(prev => prev.filter(n => n !== entityName));
    if (activeEntity?.name === entityName) {
      setActiveEntity(null);
    }
  }, [activeEntity]);

  // Rename entity display name
  const handleRename = useCallback(async (entityName, displayName) => {
    try {
      await fetch(`/api/doctrine/${entityName}/name`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ display_name: displayName }),
      });
      // Update activeEntity if it's the one being renamed
      if (activeEntity?.name === entityName) {
        setActiveEntity(prev => ({ ...prev, display_name: displayName }));
      }
      refresh();
    } catch (err) {
      console.error('Rename failed:', err);
    }
  }, [refresh, activeEntity]);

  // B69: Tool toggle â€” persists to entity.json via sidecar
  const handleToolToggle = useCallback(async (entityName, toolId, value) => {
    try {
      await fetch(`/api/doctrine/${entityName}/tools`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tools: { [toolId]: value } }),
      });
      refresh(); // Re-fetch entities to get updated tool state
    } catch (err) {
      console.error('Tool toggle failed:', err);
    }
  }, [refresh]);

  // Count entities by class for header
  const classCounts = {
    doctrine: entities.filter(e => e.type === 'doctrine').length,
    project: entities.filter(e => e.type === 'project').length,
    perspective: entities.filter(e => e.type === 'perspective').length,
    library: entities.filter(e => e.type === 'library').length,
  };

  // Create entity modal
  const [showCreate, setShowCreate] = useState(null); // null or class string

  const handleEntityCreated = useCallback((data) => {
    setShowCreate(null);
    refresh();
    // Auto-navigate to the new entity in viewer
    setViewerTarget(data.name);
    setActiveTab('viewer');
  }, [refresh]);

  const currentTab = TABS.find(t => t.id === activeTab);

  return (
    <div className="app-shell">
      <Header
        activeEntity={activeEntity}
        modules={modules}
        classCounts={classCounts}
      />

      <EntityBar activeEntity={activeEntity} linkedEntities={linkedEntities} onExit={handleExit} onUnlink={handleUnlink} />

      <nav className="tab-bar">
        {TABS.map((tab) => (
          <button
            key={tab.id}
            className={`tab-btn ${activeTab === tab.id ? 'active' : ''}`}
            onClick={() => setActiveTab(tab.id)}
          >
            {tab.icon} {tab.label}
          </button>
        ))}
      </nav>

      <main className="app-content">
        {currentTab?.filter && (
          loading ? <LoadingState /> :
          error ? <ErrorState error={error} onRetry={refresh} /> :
          <>
          {currentTab.filter === 'doctrine' && (
            <DoctrineBanner
              entities={entities}
              allEntities={entities}
              activeEntity={activeEntity}
              linkedEntities={linkedEntities}
              onEnter={handleEnter}
              onView={handleView}
              onExit={handleExit}
              onLink={handleLink}
            />
          )}
          <EntityCards
            entities={currentTab.filter === 'doctrine'
              ? entities.filter(e => e.name !== 'BOND_MASTER')
              : entities}
            filter={currentTab.filter}
            loadedEntities={loadedEntities}
            activeEntity={activeEntity}
            onView={handleView}
            onLoad={handleLoad}
            onEnter={handleEnter}
            onToolToggle={handleToolToggle}
            onRename={handleRename}
            onExit={handleExit}
          />
          <div style={{ display: 'flex', justifyContent: 'center', marginTop: 12 }}>
            <button
              className="btn-create-entity"
              onClick={() => setShowCreate(currentTab.filter)}
            >
              + New {currentTab.label.replace(/s$/, '')}
            </button>
          </div>
          </>
        )}

        {activeTab === 'systems' && <ModuleBay />}

        {activeTab === 'viewer' && (
          <DoctrineViewer
            viewerTarget={viewerTarget}
            activeEntity={activeEntity}
            loadedEntities={loadedEntities}
            onUnload={handleUnload}
            entityType={entities.find(e => e.name === viewerTarget)?.type}
            entityCore={entities.find(e => e.name === viewerTarget)?.core}
          />
        )}
      </main>

      <CommandBar />

      {showCreate && (
        <CreateEntity
          entityClass={showCreate}
          onCreated={handleEntityCreated}
          onCancel={() => setShowCreate(null)}
        />
      )}
    </div>
  );
}

function LoadingState() {
  return (
    <div className="placeholder">
      <div className="placeholder-text" style={{ fontFamily: 'var(--font-mono)' }}>
        Loading entities...
      </div>
    </div>
  );
}

function ErrorState({ error, onRetry }) {
  return (
    <div className="placeholder">
      <div className="placeholder-icon">âš ï¸</div>
      <div className="placeholder-text">Could not reach sidecar</div>
      <div className="placeholder-sub" style={{ maxWidth: 400, textAlign: 'center' }}>
        {error}
      </div>
      <button
        onClick={onRetry}
        style={{
          marginTop: 12,
          padding: '6px 16px',
          background: 'var(--bg-elevated)',
          border: '1px solid var(--border)',
          borderRadius: 'var(--radius-sm)',
          color: 'var(--text-secondary)',
          fontFamily: 'var(--font-mono)',
          fontSize: '0.8rem',
          cursor: 'pointer',
        }}
      >
        Retry
      </button>
    </div>
  );
}
</file>

<file path="panel/src/components/DoctrineBanner.jsx">
// DoctrineBanner.jsx â€” BOND_MASTER distinguished slot
// Sits above entity grid on Doctrine tab. Constitutional authority.
// S86: Multi-link hub-and-spoke. Persistent links via entity.json.

import { useState, useCallback, useRef, useEffect } from 'react';

const MASTER_ENTITY = 'BOND_MASTER';

const CLASS_META = {
  doctrine:    { icon: 'ğŸ“œ' },
  project:     { icon: 'âš’ï¸' },
  perspective: { icon: 'ğŸ”­' },
  library:     { icon: 'ğŸ“š' },
};

export default function DoctrineBanner({ entities, allEntities, activeEntity, linkedEntities = [], onEnter, onView, onExit, onLink }) {
  const master = entities.find(e => e.name === MASTER_ENTITY);
  const [auditSent, setAuditSent] = useState(false);
  const [showLinkPicker, setShowLinkPicker] = useState(false);
  const pickerRef = useRef(null);
  const isActive = activeEntity?.name === MASTER_ENTITY;

  // Close picker on outside click
  useEffect(() => {
    if (!showLinkPicker) return;
    const handler = (e) => {
      if (pickerRef.current && !pickerRef.current.contains(e.target)) {
        setShowLinkPicker(false);
      }
    };
    document.addEventListener('mousedown', handler);
    return () => document.removeEventListener('mousedown', handler);
  }, [showLinkPicker]);

  if (!master) return null;

  const displayName = master.display_name || 'BOND Master';
  const fileCount = master.files?.length || 0;

  // Linkable entities: everything except BOND_MASTER and already-linked
  const linkedNames = new Set(linkedEntities.map(l => l.name));
  const linkable = (allEntities || entities).filter(e => e.name !== MASTER_ENTITY && !linkedNames.has(e.name));

  const handleAudit = useCallback(async () => {
    if (!isActive) {
      onEnter(master);
    }
    try {
      await navigator.clipboard.writeText('BOND:Audit the panel against BOND_MASTER doctrine');
      setAuditSent(true);
      setTimeout(() => setAuditSent(false), 2000);
    } catch {}
  }, [isActive, master, onEnter]);

  const handleLinkSelect = useCallback((entity) => {
    setShowLinkPicker(false);
    onLink(entity);
  }, [onLink]);

  return (
    <div style={{
      background: 'linear-gradient(135deg, rgba(210,153,34,0.08) 0%, rgba(209,154,102,0.04) 100%)',
      border: `1px solid ${isActive ? 'rgba(210,153,34,0.6)' : 'rgba(210,153,34,0.25)'}`,
      borderRadius: 'var(--radius-md)',
      padding: '16px 20px',
      marginBottom: 16,
      transition: 'all 0.2s ease',
      boxShadow: isActive
        ? '0 0 0 1px rgba(210,153,34,0.4), 0 4px 16px rgba(210,153,34,0.1)'
        : 'none',
    }}>
      {/* Top row: icon + title + badges */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        marginBottom: 10,
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          <span style={{ fontSize: '1.4rem' }}>ğŸ”¥ğŸŒŠ</span>
          <div>
            <div style={{
              fontSize: '1.05rem',
              fontWeight: 700,
              color: '#d29922',
              letterSpacing: '0.5px',
            }}>
              {displayName}
            </div>
            <div style={{
              fontSize: '0.7rem',
              fontFamily: 'var(--font-mono)',
              color: 'var(--text-muted)',
              marginTop: 1,
            }}>
              Constitutional Authority Â· {fileCount} doctrine files
            </div>
          </div>
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
          {linkedEntities.length > 0 && (
            <span style={{
              display: 'inline-flex',
              alignItems: 'center',
              gap: 3,
              padding: '2px 8px',
              background: 'rgba(86,212,221,0.12)',
              border: '1px solid rgba(86,212,221,0.3)',
              borderRadius: 'var(--radius-sm)',
              fontFamily: 'var(--font-mono)',
              fontSize: '0.65rem',
              fontWeight: 600,
              color: 'var(--teal)',
              letterSpacing: '0.5px',
              textTransform: 'uppercase',
            }}>
              ğŸ”— {linkedEntities.length}
            </span>
          )}
          {isActive && (
            <span style={{
              display: 'inline-flex',
              alignItems: 'center',
              padding: '2px 8px',
              background: 'rgba(63,185,80,0.15)',
              border: '1px solid rgba(63,185,80,0.3)',
              borderRadius: 'var(--radius-sm)',
              fontFamily: 'var(--font-mono)',
              fontSize: '0.65rem',
              fontWeight: 600,
              color: 'var(--status-active)',
              letterSpacing: '0.5px',
              textTransform: 'uppercase',
            }}>
              ACTIVE
            </span>
          )}
          <span style={{
            display: 'inline-flex',
            alignItems: 'center',
            padding: '2px 8px',
            background: 'rgba(210,153,34,0.15)',
            border: '1px solid rgba(210,153,34,0.3)',
            borderRadius: 'var(--radius-sm)',
            fontFamily: 'var(--font-mono)',
            fontSize: '0.65rem',
            fontWeight: 600,
            color: '#d29922',
            letterSpacing: '0.5px',
            textTransform: 'uppercase',
          }}>
            DC
          </span>
        </div>
      </div>

      {/* Description */}
      <div style={{
        fontSize: '0.78rem',
        color: 'var(--text-secondary)',
        marginBottom: 12,
        lineHeight: 1.5,
      }}>
        The protocol IS the product. Enter to consult BOND doctrine, audit the codebase, or learn the system.
      </div>

      {/* Divider */}
      <div style={{
        borderTop: '1px solid rgba(210,153,34,0.15)',
        marginBottom: 12,
      }} />

      {/* Action row */}
      <div style={{ display: 'flex', gap: 8, alignItems: 'center', position: 'relative' }}>
        {isActive ? (
          <BannerBtn label="Exit" onClick={onExit} variant="exit" />
        ) : (
          <BannerBtn label="Enter" onClick={() => onEnter(master)} variant="primary" />
        )}
        <BannerBtn label="View" onClick={() => onView(master)} variant="secondary" />
        <BannerBtn
          label={auditSent ? 'âœ“ Sent' : 'ğŸ” Audit'}
          onClick={handleAudit}
          variant="audit"
          disabled={auditSent}
        />

        {/* Link button â€” only when BOND_MASTER is active and entities available */}
        {isActive && linkable.length > 0 && (
          <div ref={pickerRef} style={{ position: 'relative' }}>
            <BannerBtn
              label="ğŸ”— Link"
              onClick={() => setShowLinkPicker(!showLinkPicker)}
              variant="link"
            />
            {showLinkPicker && (
              <div style={{
                position: 'absolute',
                bottom: '100%',
                left: 0,
                marginBottom: 6,
                background: '#1e2030',
                border: '1px solid rgba(210,153,34,0.5)',
                borderRadius: 'var(--radius-md)',
                boxShadow: '0 -8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(210,153,34,0.2)',
                minWidth: 220,
                maxHeight: 260,
                overflowY: 'auto',
                zIndex: 1000,
                padding: '6px 0',
              }}>
                {linkable.length === 0 ? (
                  <div style={{
                    padding: '12px 16px',
                    fontSize: '0.75rem',
                    color: 'var(--text-muted)',
                    fontFamily: 'var(--font-mono)',
                  }}>
                    No entities to link
                  </div>
                ) : (
                  linkable.map(entity => {
                    const cm = CLASS_META[entity.type] || CLASS_META.library;
                    return (
                      <button
                        key={entity.name}
                        onClick={() => handleLinkSelect(entity)}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 8,
                          width: '100%',
                          padding: '8px 14px',
                          background: 'transparent',
                          border: 'none',
                          color: 'var(--text-primary)',
                          fontFamily: 'var(--font-mono)',
                          fontSize: '0.78rem',
                          cursor: 'pointer',
                          textAlign: 'left',
                          transition: 'background 0.1s ease',
                        }}
                        onMouseEnter={e => {
                          e.currentTarget.style.background = 'rgba(210,153,34,0.12)';
                        }}
                        onMouseLeave={e => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                      >
                        <span style={{ flexShrink: 0 }}>{cm.icon}</span>
                        <span style={{ flex: 1 }}>{entity.display_name || entity.name}</span>
                        <span style={{
                          fontSize: '0.6rem',
                          color: 'var(--text-muted)',
                          textTransform: 'uppercase',
                          flexShrink: 0,
                        }}>
                          {entity.type?.slice(0, 3)}
                        </span>
                      </button>
                    );
                  })
                )}
              </div>
            )}
          </div>
        )}

        {/* Spacer + tools summary */}
        <div style={{ flex: 1 }} />
        <div style={{
          display: 'flex',
          gap: 4,
          alignItems: 'center',
        }}>
          <ToolPill icon="ğŸ“" label="Files" enabled />
          <ToolPill icon="ğŸ“" label="ISS" enabled />
          <ToolPill icon="ğŸ”®" label="QAIS" enabled={false} />
          <ToolPill icon="ğŸ”¥" label="Heat" enabled={false} />
          <ToolPill icon="ğŸ’" label="Crystal" enabled={false} />
        </div>
      </div>
    </div>
  );
}

function BannerBtn({ label, onClick, variant = 'secondary', disabled = false }) {
  const styles = {
    primary: {
      bg: 'rgba(210,153,34,0.15)',
      border: 'rgba(210,153,34,0.5)',
      color: '#d29922',
      hoverBg: 'rgba(210,153,34,0.25)',
    },
    secondary: {
      bg: 'var(--bg-elevated)',
      border: 'var(--border)',
      color: 'var(--text-secondary)',
      hoverBg: 'var(--bg-hover)',
    },
    exit: {
      bg: 'transparent',
      border: 'rgba(233,69,96,0.4)',
      color: 'var(--accent)',
      hoverBg: 'rgba(233,69,96,0.1)',
    },
    audit: {
      bg: 'rgba(86,212,221,0.08)',
      border: 'rgba(86,212,221,0.3)',
      color: 'var(--teal)',
      hoverBg: 'rgba(86,212,221,0.15)',
    },
    link: {
      bg: 'rgba(210,153,34,0.08)',
      border: 'rgba(210,153,34,0.35)',
      color: '#d29922',
      hoverBg: 'rgba(210,153,34,0.18)',
    },
  };
  const s = styles[variant] || styles.secondary;

  return (
    <button
      onClick={onClick}
      disabled={disabled}
      style={{
        padding: '5px 14px',
        fontSize: '0.78rem',
        fontFamily: 'var(--font-mono)',
        fontWeight: variant === 'primary' ? 600 : 400,
        background: s.bg,
        color: disabled ? 'var(--text-muted)' : s.color,
        border: `1px solid ${disabled ? 'var(--border)' : s.border}`,
        borderRadius: 'var(--radius-sm)',
        cursor: disabled ? 'not-allowed' : 'pointer',
        transition: 'all 0.15s ease',
      }}
      onMouseEnter={e => { if (!disabled) e.target.style.background = s.hoverBg; }}
      onMouseLeave={e => { if (!disabled) e.target.style.background = s.bg; }}
    >
      {label}
    </button>
  );
}

function ToolPill({ icon, label, enabled }) {
  return (
    <span style={{
      display: 'inline-flex',
      alignItems: 'center',
      gap: 3,
      padding: '2px 6px',
      fontSize: '0.65rem',
      fontFamily: 'var(--font-mono)',
      background: enabled ? 'rgba(209,154,102,0.1)' : 'transparent',
      color: enabled ? 'var(--accent-amber)' : 'var(--text-muted)',
      border: `1px solid ${enabled ? 'rgba(209,154,102,0.3)' : 'transparent'}`,
      borderRadius: 'var(--radius-sm)',
      opacity: enabled ? 1 : 0.35,
    }}>
      <span style={{ fontSize: '0.6rem' }}>{icon}</span>
      {label}
    </span>
  );
}
</file>

<file path="panel/src/components/EntityBar.jsx">
// EntityBar.jsx â€” Active entity status strip with Exit button
// S86: Multi-link support â€” hub-and-spoke from BOND_MASTER

const CLASS_META = {
  doctrine:    { icon: 'ğŸ“œ', label: 'Doctrine',    color: 'var(--accent-amber)' },
  project:     { icon: 'âš’ï¸', label: 'Project',     color: 'var(--accent-teal)' },
  perspective: { icon: 'ğŸ”­', label: 'Perspective', color: 'var(--accent)' },
  library:     { icon: 'ğŸ“š', label: 'Library',     color: 'var(--text-secondary)' },
};

export default function EntityBar({ activeEntity, linkedEntities = [], onExit, onUnlink }) {
  if (!activeEntity) return null;

  const meta = CLASS_META[activeEntity.type] || CLASS_META.doctrine;
  const label = activeEntity.display_name || activeEntity.name;

  return (
    <div style={{ borderBottom: '1px solid var(--border)' }}>
      {/* Primary row */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: '6px 16px',
        background: 'rgba(209,154,102,0.08)',
        fontFamily: 'var(--font-mono)',
        fontSize: '0.8rem',
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          <span style={{
            display: 'inline-flex',
            alignItems: 'center',
            gap: 4,
            padding: '2px 8px',
            background: 'rgba(209,154,102,0.15)',
            border: '1px solid rgba(209,154,102,0.3)',
            borderRadius: 'var(--radius-sm)',
            color: meta.color,
            fontWeight: 600,
          }}>
            {meta.icon} {label}
          </span>
          <span style={{ color: 'var(--text-muted)', fontSize: '0.75rem' }}>
            {meta.label} Â· entered
          </span>
        </div>
        <button
          onClick={onExit}
          style={{
            padding: '3px 12px',
            fontSize: '0.75rem',
            fontFamily: 'var(--font-mono)',
            background: 'transparent',
            color: 'var(--accent)',
            border: '1px solid rgba(233,69,96,0.4)',
            borderRadius: 'var(--radius-sm)',
            cursor: 'pointer',
            transition: 'all 0.15s ease',
          }}
          onMouseEnter={e => { e.target.style.background = 'rgba(233,69,96,0.1)'; }}
          onMouseLeave={e => { e.target.style.background = 'transparent'; }}
        >
          Exit
        </button>
      </div>

      {/* Linked rows â€” one per linked entity */}
      {linkedEntities.map((linked) => {
        const linkedMeta = CLASS_META[linked.type] || CLASS_META.library;
        const linkedLabel = linked.display_name || linked.name;
        return (
          <div key={linked.name} style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '4px 16px',
            background: 'rgba(86,212,221,0.04)',
            borderTop: '1px solid rgba(86,212,221,0.1)',
            fontFamily: 'var(--font-mono)',
            fontSize: '0.75rem',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>ğŸ”—</span>
              <span style={{
                display: 'inline-flex',
                alignItems: 'center',
                gap: 4,
                padding: '1px 7px',
                background: 'rgba(86,212,221,0.08)',
                border: '1px solid rgba(86,212,221,0.25)',
                borderRadius: 'var(--radius-sm)',
                color: linkedMeta.color,
                fontWeight: 600,
                fontSize: '0.73rem',
              }}>
                {linkedMeta.icon} {linkedLabel}
              </span>
              <span style={{ color: 'var(--text-muted)', fontSize: '0.68rem' }}>
                {linkedMeta.label} Â· linked
              </span>
            </div>
            <button
              onClick={() => onUnlink(linked.name)}
              style={{
                padding: '2px 10px',
                fontSize: '0.68rem',
                fontFamily: 'var(--font-mono)',
                background: 'transparent',
                color: 'var(--text-muted)',
                border: '1px solid var(--border)',
                borderRadius: 'var(--radius-sm)',
                cursor: 'pointer',
                transition: 'all 0.15s ease',
              }}
              onMouseEnter={e => {
                e.target.style.background = 'rgba(233,69,96,0.1)';
                e.target.style.color = 'var(--accent)';
                e.target.style.borderColor = 'rgba(233,69,96,0.4)';
              }}
              onMouseLeave={e => {
                e.target.style.background = 'transparent';
                e.target.style.color = 'var(--text-muted)';
                e.target.style.borderColor = 'var(--border)';
              }}
            >
              Unlink
            </button>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="ISS/iss_mcp_server.py">
"""
ISS MCP Server v2.0 â€” Invariant Semantic Substrate + Limbic (10D EAP)
Exposes ISS analysis and limbic perception to Claude via MCP protocol.

Tools: iss_analyze, iss_compare, iss_limbic, iss_status

Limbic v2.0: 10D EAP input, evolved genome (S75, fitness 0.017)
  Pipeline: Claude native read â†’ EAP (10 floats) â†’ ISS forces â†’ Genome â†’ S/T/G
  Constraints: C1-C4 compliant (no word lists, no new axes, no vocab logic)

Author: J-Dub & Claude
Date: 2026-02-02 (v1.0), 2026-02-03 (v2.0)
Session: S75
"""

import json
import sys
import numpy as np
import os
import hashlib

# =============================================================================
# ISS CORE
# =============================================================================

EMBED_DIM = 512
PROJ_FILE = "iss_projections.npz"

def embed_text(text: str) -> np.ndarray:
    h = hashlib.sha512(text.encode()).hexdigest()
    seed = int(h[:16], 16) % (2**32)
    rng = np.random.default_rng(seed)
    vec = rng.choice([-1.0, 1.0], size=EMBED_DIM)
    return vec / np.linalg.norm(vec)

# Data directory: use BOND_ROOT env var, fall back to ../data relative to this script
BOND_ROOT = os.environ.get('BOND_ROOT', os.path.join(os.path.dirname(__file__), '..'))
DATA_DIR = os.path.join(BOND_ROOT, 'data')
proj_path = os.path.join(DATA_DIR, PROJ_FILE)
if os.path.exists(proj_path):
    proj = np.load(proj_path)
    P_G = proj['P_G']
    P_P = proj['P_P']
else:
    np.random.seed(42)
    P_G = np.random.randn(EMBED_DIM, 64) * 0.1
    np.random.seed(43)
    P_P = np.random.randn(EMBED_DIM, 64) * 0.1

def analyze(text: str, alpha: float = 1.0, beta: float = 1.0, gamma: float = 1.0) -> dict:
    x = embed_text(text)
    g = x @ P_G
    p = x @ P_P

    g_norm = float(np.linalg.norm(g))
    p_norm = float(np.linalg.norm(p))

    if g_norm > 1e-8 and p_norm > 1e-8:
        E = float(np.dot(g, p) / (g_norm * p_norm))
    else:
        E = 0.0

    g_reconstructed = g @ np.linalg.pinv(P_G)
    p_reconstructed = p @ np.linalg.pinv(P_P)
    r = x - 0.5 * (g_reconstructed + p_reconstructed)
    r_norm = float(np.linalg.norm(r))

    gap = alpha * r_norm + beta * abs(g_norm - p_norm) + gamma * (1.0 - E)

    signals = []
    imbalance = g_norm - p_norm
    if imbalance > 0.1:
        signals.append("G>P (mechanistic)")
    elif imbalance < -0.1:
        signals.append("P>G (prescriptive)")
    else:
        signals.append("balanced")

    if E > 0.5:
        signals.append("high coherence")
    elif E < 0.2:
        signals.append("low coherence")

    if r_norm > 0.8:
        signals.append("high residual")

    return {
        "g_norm": round(g_norm, 4),
        "p_norm": round(p_norm, 4),
        "imbalance": round(imbalance, 4),
        "E": round(E, 4),
        "r_norm": round(r_norm, 4),
        "gap": round(gap, 4),
        "diagnosis": "; ".join(signals),
        "embedding": "qais-hash"
    }

def compare(texts: list) -> list:
    return [{"text": t[:50] + "..." if len(t) > 50 else t, **analyze(t)} for t in texts]


# =============================================================================
# LIMBIC v2.0 â€” Evolved 10D EAP Genome (S75, fitness 0.017)
# =============================================================================
# EAP schema: [valence, arousal, confidence, urgency, connection,
#              curiosity, frustration, fatigue, wonder, trust]
#
# Input vector (16): ISS(5) + EAP(10) + QAIS(1)
# Derived (5): |valence|, max(0,-val), |g-p|, (1-E), (1-qais)
# Output: S(salience), T(threat), G(gate), V(valence passthrough)

EAP_NAMES = ["valence", "arousal", "confidence", "urgency", "connection",
             "curiosity", "frustration", "fatigue", "wonder", "trust"]

# --- Evolved weights (hardcoded from limbic_genome_10d.json) ---

# S (Salience) raw weights: [g_norm, p_norm, E, r_norm, gap,
#   valence, arousal, confidence, urgency, connection,
#   curiosity, frustration, fatigue, wonder, trust, qais_score]
S_RAW = np.array([
    0.3557, 0.5550, -0.0634, 0.3239, 0.4997,
    0.1450, 0.5622, -0.4786, -0.4183, 0.6361,
    -0.1271, 0.2949, 0.3145, 0.2332, -0.4887, -0.1811
])
S_DERIVED = np.array([0.3309, -0.2142, 0.0663, -0.4381, -0.8057])
S_BIAS = 0.0742

# T (Threat) raw weights
T_RAW = np.array([
    0.0318, 0.9895, -0.1544, -0.8483, -0.0094,
    0.4800, -0.8201, -0.8575, 0.1807, -0.1981,
    0.0053, -0.0314, -0.2000, -0.1210, -0.5289, 0.0183
])
T_DERIVED = np.array([0.2263, 0.8268, 0.2601, 0.4073, 0.4335])
T_BIAS = 0.6439

# Gate thresholds
G_S_THRESH = 0.4787
G_T_THRESH = 0.3892


def clamp(x, lo=0.0, hi=1.0):
    return max(lo, min(hi, float(x)))


def limbic(text: str, eap: list = None, qais_score: float = 0.3, context: str = "") -> dict:
    """
    Full limbic scan: ISS perception + EAP emotion + QAIS memory â†’ S/T/G.

    Args:
        text: Raw text to analyze
        eap: 10 floats from Claude's native emotional read
             [valence, arousal, confidence, urgency, connection,
              curiosity, frustration, fatigue, wonder, trust]
             If None, defaults to neutral (all 0.0 except trust=0.5)
        qais_score: QAIS familiarity score (0=novel, 1=very familiar)
        context: Optional hint for interpretation
    """
    # 1. ISS analysis
    iss = analyze(text)
    g_norm = iss["g_norm"]
    p_norm = iss["p_norm"]
    E = iss["E"]
    r_norm = iss["r_norm"]
    gap = iss["gap"]

    # 2. EAP â€” default to neutral if not provided
    if eap is None or len(eap) != 10:
        eap = [0.0, 0.0, 0.5, 0.0, 0.3, 0.0, 0.0, 0.0, 0.0, 0.5]

    # Ensure floats
    eap = [float(v) for v in eap]

    # 3. Build 16D raw input
    raw = np.array([
        g_norm, p_norm, E, r_norm, gap,
        *eap,
        float(qais_score)
    ])

    # 4. Build 5D derived features
    derived = np.array([
        abs(eap[0]),                       # |valence|
        max(0.0, -eap[0]),                # max(0, -valence)
        abs(g_norm - p_norm),              # |g - p|
        1.0 - E,                           # (1 - E)
        1.0 - float(qais_score)           # (1 - qais_score)
    ])

    # 5. Compute S, T, G
    S = clamp(float(np.dot(S_RAW, raw)) + float(np.dot(S_DERIVED, derived)) + S_BIAS)
    T = clamp(float(np.dot(T_RAW, raw)) + float(np.dot(T_DERIVED, derived)) + T_BIAS)
    G = (S > G_S_THRESH) or (T > G_T_THRESH)
    V = eap[0]  # valence passthrough

    # 6. Build signal description
    signals = []

    # Salience signals
    if S > 0.8:
        signals.append("HIGH salience")
    elif S > 0.5:
        signals.append("moderate salience")

    # Threat signals
    if T > 0.7:
        signals.append("HIGH threat")
    elif T > 0.4:
        signals.append("moderate threat")

    # EAP-specific flags (Rav4 auto-trigger conditions)
    if eap[6] > 0.6:  # frustration
        signals.append("frustration elevated")
    if eap[7] > 0.7:  # fatigue
        signals.append("fatigue warning")
    if eap[9] < 0.3:  # trust dropping
        signals.append("trust low")
    if eap[8] > 0.7:  # wonder spiking
        signals.append("wonder spike")

    # Valence
    if V > 0.5:
        signals.append("positive")
    elif V < -0.3:
        signals.append("negative")

    # 7. Action recommendation
    if not G:
        action = "pass"
    elif T > 0.6:
        action = "intervene â€” threat detected"
    elif S > 0.7 and T < 0.2:
        action = "celebrate â€” significant positive moment"
    elif S > 0.5:
        action = "attend â€” something matters here"
    else:
        action = "note â€” gate triggered, review context"

    return {
        "S": round(S, 4),
        "V": round(V, 4),
        "T": round(T, 4),
        "G": G,
        "gap": round(gap, 4),
        "signal": "; ".join(signals) if signals else "quiet",
        "action": action,
        "iss": {
            "g_norm": round(g_norm, 4),
            "p_norm": round(p_norm, 4),
            "E": round(E, 4),
            "r_norm": round(r_norm, 4),
            "diagnosis": iss["diagnosis"]
        },
        "eap": {name: round(v, 2) for name, v in zip(EAP_NAMES, eap)},
        "qais_score": round(float(qais_score), 4),
        "genome": "v2.0-10D-S75"
    }


# =============================================================================
# TOOLS
# =============================================================================

TOOLS = [
    {
        "name": "iss_analyze",
        "description": "Analyze text for semantic forces (G=mechanistic, P=prescriptive, E=coherence, r=residual, gap=imbalance)",
        "inputSchema": {
            "type": "object",
            "properties": {
                "text": {"type": "string", "description": "Text to analyze"}
            },
            "required": ["text"]
        }
    },
    {
        "name": "iss_compare",
        "description": "Compare multiple texts for semantic force differences",
        "inputSchema": {
            "type": "object",
            "properties": {
                "texts": {"type": "array", "items": {"type": "string"}, "description": "List of texts to compare"}
            },
            "required": ["texts"]
        }
    },
    {
        "name": "iss_limbic",
        "description": "Limbic scan: ISS perception + EAP emotion (10D) + QAIS familiarity â†’ S(salience), V(valence), T(threat), G(gate). Uses evolved genome (v2.0, fitness 0.017). Claude provides EAP from native read.",
        "inputSchema": {
            "type": "object",
            "properties": {
                "text": {
                    "type": "string",
                    "description": "Raw text to analyze (user message or situation)"
                },
                "eap": {
                    "type": "array",
                    "items": {"type": "number"},
                    "description": "10 floats: [valence, arousal, confidence, urgency, connection, curiosity, frustration, fatigue, wonder, trust]. Range: -1 to 1 for valence, 0 to 1 for others."
                },
                "qais_score": {
                    "type": "number",
                    "description": "QAIS familiarity (0=novel, 1=familiar). Default 0.3"
                },
                "context": {
                    "type": "string",
                    "description": "Optional hint (e.g. 'GSG mining', 'self-exploration')"
                }
            },
            "required": ["text"]
        }
    },
    {
        "name": "iss_status",
        "description": "Get ISS status and configuration",
        "inputSchema": {
            "type": "object",
            "properties": {}
        }
    }
]


# =============================================================================
# MCP HANDLER
# =============================================================================

def handle_request(request):
    method = request.get("method", "")
    req_id = request.get("id")
    params = request.get("params", {})

    if method == "initialize":
        return {
            "jsonrpc": "2.0",
            "id": req_id,
            "result": {
                "protocolVersion": "2024-11-05",
                "capabilities": {"tools": {}},
                "serverInfo": {"name": "iss-server", "version": "2.0.0"}
            }
        }

    if method == "tools/list":
        return {"jsonrpc": "2.0", "id": req_id, "result": {"tools": TOOLS}}

    if method == "tools/call":
        tool_name = params.get("name")
        args = params.get("arguments", {})

        try:
            if tool_name == "iss_analyze":
                result = analyze(args.get("text", ""))
            elif tool_name == "iss_compare":
                result = compare(args.get("texts", []))
            elif tool_name == "iss_limbic":
                result = limbic(
                    text=args.get("text", ""),
                    eap=args.get("eap", None),
                    qais_score=args.get("qais_score", 0.3),
                    context=args.get("context", "")
                )
            elif tool_name == "iss_status":
                result = {
                    "status": "active",
                    "version": "2.0.0",
                    "embedding": "qais-hash",
                    "embed_dim": EMBED_DIM,
                    "proj_file": PROJ_FILE,
                    "proj_dim": 64,
                    "limbic": "active",
                    "limbic_genome": "v2.0-10D-S75",
                    "limbic_fitness": 0.017355,
                    "eap_schema": EAP_NAMES,
                    "eap_dims": 10,
                    "gate_thresholds": {
                        "S": G_S_THRESH,
                        "T": G_T_THRESH
                    }
                }
            else:
                return {"jsonrpc": "2.0", "id": req_id, "error": {"code": -32601, "message": f"Unknown tool: {tool_name}"}}

            return {
                "jsonrpc": "2.0",
                "id": req_id,
                "result": {"content": [{"type": "text", "text": json.dumps(result, indent=2)}]}
            }
        except Exception as e:
            return {"jsonrpc": "2.0", "id": req_id, "error": {"code": -32603, "message": str(e)}}

    if method == "notifications/initialized":
        return None

    return {"jsonrpc": "2.0", "id": req_id, "error": {"code": -32601, "message": f"Unknown method: {method}"}}


def main():
    for line in sys.stdin:
        line = line.strip()
        if not line:
            continue
        try:
            request = json.loads(line)
            response = handle_request(request)
            if response is not None:
                print(json.dumps(response), flush=True)
        except json.JSONDecodeError:
            print(json.dumps({"jsonrpc": "2.0", "id": None, "error": {"code": -32700, "message": "Parse error"}}), flush=True)
        except Exception as e:
            print(json.dumps({"jsonrpc": "2.0", "id": None, "error": {"code": -32603, "message": str(e)}}), flush=True)


if __name__ == "__main__":
    main()
</file>

<file path="README.md">
# ğŸ”¥ğŸŒŠ BOND

**Persistence and continuity framework for human-AI collaboration.**

BOND gives Claude sessions memory, structure, and grounding through a counter system, entity architecture, and clipboard bridge â€” so context doesn't degrade and knowledge doesn't get lost between conversations.

---

## What BOND Does

**The Problem:** Every Claude session starts fresh. You re-explain context, lose progress, and Claude drifts from your project's principles.

**The Solution:** A structured protocol with two core mechanisms:

1. **Counter** â€” Tracks context age so you know when to refresh. First line of every Claude response.
2. **Entities** â€” Your knowledge organized into four classes (Doctrine, Project, Perspective, Library), each with defined tool boundaries and file structures that Claude reads on `{Sync}`.

Plus a **Control Panel** â€” a dark-themed React dashboard for managing entities, toggling tools, and sending commands through the clipboard bridge.

---

## Quick Start

### Option A: Installation Wizard (Recommended)

1. Download [`bond_wizard.html`](panel/bond_wizard.html) from this repo
2. Open it in your browser
3. Choose components, set your install path
4. Download and run the generated `install.bat`
5. Start the panel with `start_bond.bat`

### Option B: Manual Setup

```bash
# Clone the repo
git clone https://github.com/moneyjarrod/BOND.git
cd BOND

# Install and start the panel
cd panel
npm install
node server.js
```

Open `http://localhost:3000` in your browser.

### Connect to Claude

1. Copy `skills/bond/SKILL.md` into your Claude project as a skill file
2. Type `{Full Restore}` in Claude to initialize the protocol
3. Work naturally â€” Claude will show the counter on every response

---

## Core Commands

| Command | What It Does |
|---------|-------------|
| `{Sync}` | Read project files, ground in truth, reset counter |
| `{Full Restore}` | Complete reload with full depth read |
| `{Save}` | Write proven work (both must agree) |
| `{Chunk}` | Session snapshot â€” handoff file + crystal |
| `{Enter ENTITY}` | Load an entity, apply tool boundaries |
| `{Exit}` | Clear active entity |

See [`docs/COMMANDS.md`](docs/COMMANDS.md) for full reference.

---

## Entity System

Four classes with hard tool boundaries:

| Class | Purpose | Tools |
|-------|---------|-------|
| **Doctrine** | Static truth, IS statements | Files, ISS |
| **Project** | Bounded work with CORE constraint | Files, ISS, QAIS, Heatmap, Crystal |
| **Perspective** | Unbounded growth, evolving lenses | Files, QAIS, Heatmap, Crystal |
| **Library** | Read-only reference shelf | Files only |

Each entity is a folder in `doctrine/` with an `entity.json` and markdown files. The panel lets you create, enter, view, and manage entities through a visual interface.

See [`docs/ENTITIES.md`](docs/ENTITIES.md) for full architecture.

---

## Project Structure

```
BOND/
â”œâ”€â”€ panel/           â† React dashboard + Express sidecar
â”œâ”€â”€ doctrine/        â† Your entity folders
â”œâ”€â”€ state/           â† Active entity pointer
â”œâ”€â”€ skills/          â† Claude skill file
â”œâ”€â”€ docs/            â† Reference documentation
â””â”€â”€ bond_wizard.html â† Installation wizard
```

---

## The Counter

```
Â«t3/10 ğŸ—’ï¸Â»
```

Every Claude response starts with this tag. It tracks user messages since last `{Sync}`, making context degradation visible. When it climbs too high, you know it's time to refresh.

See [`docs/COUNTER.md`](docs/COUNTER.md) for full specification.

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     clipboard      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BOND Panel  â”‚ â”€â”€â”€â”€ BOND:{cmd} â”€â”€â†’â”‚   AHK Bridge â”‚
â”‚  (React+Express)                  â”‚  (optional)  â”‚
â”‚  :3000       â”‚                    â”‚  pastes to   â”‚
â”‚              â”‚                    â”‚  Claude      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ filesystem
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  doctrine/   â”‚  Entity folders with .md files
â”‚  state/      â”‚  Active entity pointer
â”‚  .env        â”‚  Configuration
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

The panel reads/writes doctrine files and state through Express. Commands are relayed to Claude via clipboard â€” the panel copies `BOND:{command}`, and the optional AHK bridge auto-pastes it.

---

## Optional Components

**AHK Bridge** â€” AutoHotkey script that watches the clipboard for `BOND:` prefixed commands and auto-pastes them into Claude. Windows only.

**MCP Modules** â€” The panel includes a Systems tab for managing QAIS, ISS, Limbic, and EAP modules. These connect to separate MCP servers for advanced features like semantic memory and text analysis. Modules show as "offline" until their servers are configured.

---

## Requirements

- **Node.js 18+** â€” for the Control Panel
- **Git** â€” for cloning the repo
- **Windows 10/11** â€” for the AHK clipboard bridge (optional)
- **Python 3.10+** â€” for MCP modules (optional, advanced)

---

## Origin

Built across 85+ sessions developing a game engine. We kept losing context. Memory helped but wasn't enough. Files helped but needed structure.

The insight: **The relationship matters.** Claude isn't just a tool â€” it's a collaborator. Collaborators need shared truth, clear communication, and mutual agreement.

Keep the fire burning across sessions. ğŸ”¥ğŸŒŠ

---

## License

MIT â€” Use freely, modify as needed, share with others.

---

ğŸ”¥ğŸŒŠ **BOND: The Bonfire Protocol**
Built by J-Dub & Claude | 2026
</file>

</files>
